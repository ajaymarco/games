<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tactile Pro Ultra | Encrypted P2P</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0e14;
            --panel: #161b22;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.3);
        }
        [data-theme="rose"] { --accent: #fb7185; --accent-glow: rgba(251, 113, 133, 0.3); }
        [data-theme="emerald"] { --accent: #10b981; --accent-glow: rgba(16, 185, 129, 0.3); }
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg);
            color: #e6edf3;
            height: 100dvh;
            overflow: hidden;
            transition: background 0.3s ease;
        }

        .animate__faster { animation-duration: 300ms !important; }

        .glass-blur {
            backdrop-filter: blur(12px);
            background: rgba(13, 17, 23, 0.8);
        }

        .msg-bubble {
            max-width: 85%;
            transition: transform 0.1s ease;
            position: relative;
        }

        .msg-me { background: var(--accent); color: white; border-radius: 1rem 1rem 0.1rem 1rem; }
        .msg-peer { background: #1c2128; border: 1px solid #30363d; border-radius: 1rem 1rem 1rem 0.1rem; }

        .code-block {
            background: #0d1117 !important;
            border-radius: 0.5rem;
            font-size: 0.75rem !important;
        }

        .chat-scroll::-webkit-scrollbar { width: 3px; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
        
        .reaction-chip {
            font-size: 10px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 99px;
            padding: 1px 6px;
            margin-top: -8px;
            z-index: 10;
        }

        #gateway-screen {
            background: radial-gradient(circle at center, #1e293b 0%, #0b0e14 100%);
        }

        .input-container { max-width: 1000px; margin: 0 auto; width: 100%; }

        /* Self-destruct timer bar */
        .burn-bar {
            height: 2px;
            background: #fb7185;
            position: absolute;
            bottom: 0;
            left: 0;
            transition: width linear;
        }
    </style>
</head>
<body data-theme="default">

    <!-- Gateway Screen (Auth/Connection First) -->
    <div id="gateway-screen" class="fixed inset-0 z-[500] flex flex-col items-center justify-center p-6 transition-all duration-500">
        <div class="w-full max-w-sm space-y-8 animate__animated animate__fadeIn">
            <div class="text-center space-y-2">
                <div class="inline-flex p-3 rounded-2xl bg-indigo-600/20 mb-4">
                    <i data-lucide="zap" class="w-8 h-8 text-indigo-500"></i>
                </div>
                <h1 class="text-3xl font-black tracking-tighter">TACTILE PRO</h1>
                <p class="text-gray-500 text-sm font-medium">Decentralized P2P Tunnel</p>
            </div>

            <div class="bg-[#161b22] border border-[#30363d] rounded-2xl p-6 shadow-2xl space-y-6">
                <div class="space-y-2 text-center">
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Your Private Node ID</label>
                    <div class="flex items-center justify-center gap-3">
                        <span id="gateway-id" class="font-mono text-2xl font-black tracking-widest text-white">------</span>
                        <button onclick="copyId()" class="p-2 hover:bg-white/5 rounded-lg text-gray-400 hover:text-white"><i data-lucide="copy" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="relative">
                        <input type="text" id="peer-id-gateway" placeholder="Enter Peer Node ID" class="w-full bg-black/40 border border-[#30363d] rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-indigo-500 uppercase font-mono tracking-widest text-center transition-all">
                    </div>
                    <button onclick="connectAndEnter()" id="connect-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-xl font-bold text-sm shadow-lg shadow-indigo-600/20 active:scale-95 transition-all">
                        INITIALIZE LINK
                    </button>
                </div>
            </div>
            
            <p class="text-center text-[10px] text-gray-600 uppercase tracking-widest font-bold">Encrypted via WebRTC â€¢ No Servers</p>
        </div>
    </div>

    <!-- Main Workspace (Hidden until connection) -->
    <div id="main-app" class="hidden h-full flex flex-col md:flex-row overflow-hidden">
        
        <!-- Collapsible Mini Sidebar (Discord Style) -->
        <aside class="hidden md:flex w-16 border-r border-[#30363d] flex-col items-center py-4 gap-4 bg-[#0d1117] shrink-0">
            <div class="w-10 h-10 rounded-2xl bg-indigo-600 flex items-center justify-center cursor-pointer shadow-lg shadow-indigo-600/20">
                <i data-lucide="message-square" class="w-5 h-5 text-white"></i>
            </div>
            <div class="w-8 h-[1px] bg-[#30363d]"></div>
            <button onclick="setTheme('rose')" class="w-10 h-10 rounded-full bg-rose-500/20 border border-rose-500/40 hover:scale-110 transition"></button>
            <button onclick="setTheme('emerald')" class="w-10 h-10 rounded-full bg-emerald-500/20 border border-emerald-500/40 hover:scale-110 transition"></button>
            <button onclick="setTheme('default')" class="w-10 h-10 rounded-full bg-indigo-500/20 border border-indigo-500/40 hover:scale-110 transition"></button>
        </aside>

        <main class="flex-1 flex flex-col relative bg-[#0b0e14]">
            <!-- Responsive Header -->
            <header class="h-14 border-b border-[#30363d] px-4 md:px-8 flex items-center justify-between glass-blur z-20">
                <div class="flex items-center gap-3">
                    <div id="active-indicator" class="w-2.5 h-2.5 rounded-full bg-green-500"></div>
                    <div>
                        <h2 id="active-peer-name" class="font-bold text-xs">NODE: ------</h2>
                        <p class="text-[9px] text-indigo-400 font-bold uppercase tracking-widest">Live Tunnel</p>
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <button onclick="initiateCall()" class="p-2 hover:bg-white/5 rounded-lg text-gray-400 hover:text-white transition"><i data-lucide="phone" class="w-4 h-4"></i></button>
                    <button onclick="toggleBurnMode()" id="burn-toggle" class="p-2 hover:bg-rose-500/10 rounded-lg text-gray-400 hover:text-rose-400 transition" title="Self Destruct Mode"><i data-lucide="flame" class="w-4 h-4"></i></button>
                    <button onclick="window.location.reload()" class="p-2 hover:bg-white/5 rounded-lg text-gray-400 transition"><i data-lucide="log-out" class="w-4 h-4"></i></button>
                </div>
            </header>

            <div id="message-container" class="flex-1 overflow-y-auto p-4 md:p-10 space-y-6 chat-scroll"></div>

            <div id="typing-indicator" class="px-10 py-1 h-4 invisible flex items-center gap-1">
                <span class="w-1 h-1 bg-indigo-500 rounded-full animate-bounce"></span>
                <span class="w-1 h-1 bg-indigo-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
                <span class="w-1 h-1 bg-indigo-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
            </div>

            <footer class="p-4 md:p-6 bg-[#0b0e14]">
                <div class="input-container">
                    <div class="flex items-end gap-3 bg-[#161b22] border border-[#30363d] rounded-2xl p-1.5 focus-within:border-indigo-500 transition-all">
                        <button onclick="toggleGiphy()" class="w-10 h-10 rounded-xl hover:bg-white/5 flex items-center justify-center text-[10px] font-black shrink-0">GIF</button>
                        <textarea id="chat-input" rows="1" placeholder="Message..." class="flex-1 bg-transparent border-none py-2.5 px-2 text-sm outline-none resize-none max-h-32"></textarea>
                        <div class="flex items-center gap-1 pr-1">
                            <button onclick="sendCodePrompt()" class="w-10 h-10 rounded-xl hover:bg-white/5 flex items-center justify-center text-gray-400 shrink-0"><i data-lucide="code" class="w-4 h-4"></i></button>
                            <button onclick="sendMessage()" class="w-10 h-10 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl flex items-center justify-center shadow-lg active:scale-95 transition-all shrink-0"><i data-lucide="send" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
            </footer>
        </main>
    </div>

    <!-- Modals & Overlays -->
    <div id="giphy-panel" class="hidden absolute bottom-24 right-4 md:right-8 w-72 h-80 bg-[#161b22] border border-[#30363d] rounded-2xl shadow-2xl z-50 flex flex-col overflow-hidden animate__animated animate__fadeInUp animate__faster">
        <div class="p-2 bg-black/20"><input type="text" id="giphy-search" placeholder="Search..." class="w-full bg-white/5 rounded-lg px-3 py-1.5 text-xs outline-none"></div>
        <div id="giphy-results" class="flex-1 overflow-y-auto grid grid-cols-2 gap-1 p-2 chat-scroll"></div>
    </div>

    <script>
        const GIPHY_KEY = 'dc6zaTOxFJmzC';
        let peer, conn, burnMode = false;
        
        function init() {
            const shortId = Math.random().toString(36).substring(2, 8).toUpperCase();
            peer = new Peer(shortId, { config: { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] } });

            peer.on('open', id => {
                document.getElementById('gateway-id').innerText = id;
                const params = new URLSearchParams(window.location.search);
                if (params.get('connect')) document.getElementById('peer-id-gateway').value = params.get('connect');
            });

            peer.on('connection', c => {
                conn = c;
                setupConnection();
                enterApp();
            });

            lucide.createIcons();
        }

        function connectAndEnter() {
            const id = document.getElementById('peer-id-gateway').value.trim().toUpperCase();
            if (!id || id === peer.id) return alert("Invalid Node ID");
            conn = peer.connect(id);
            setupConnection();
            enterApp();
        }

        function enterApp() {
            document.getElementById('gateway-screen').classList.add('opacity-0', 'pointer-events-none', 'scale-110');
            setTimeout(() => {
                document.getElementById('gateway-screen').remove();
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('active-peer-name').innerText = `NODE: ${conn.peer}`;
            }, 500);
        }

        function setupConnection() {
            conn.on('open', () => {
                confetti({ particleCount: 40, spread: 60, colors: ['#6366f1', '#fb7185'] });
            });
            conn.on('data', data => {
                if (data.type === 'typing') toggleTyping(data.state);
                else if (data.type === 'reaction') applyReaction(data);
                else renderMessage('peer', data);
            });
        }

        function sendMessage(custom = null) {
            const input = document.getElementById('chat-input');
            const content = custom ? custom.content : input.value.trim();
            if (!content) return;

            const payload = {
                id: Math.random().toString(36).substr(2, 9),
                type: custom ? custom.type : 'text',
                content: DOMPurify.sanitize(content),
                burn: burnMode,
                timestamp: Date.now()
            };

            conn.send(payload);
            renderMessage('me', payload);
            input.value = '';
            input.style.height = 'auto';
        }

        function renderMessage(sender, data) {
            const container = document.getElementById('message-container');
            const div = document.createElement('div');
            div.id = `msg-${data.id}`;
            div.className = `flex flex-col ${sender === 'me' ? 'items-end' : 'items-start'} animate__animated animate__fadeInUp animate__faster relative`;

            let body = '';
            if (data.type === 'gif') body = `<img src="${data.content}" class="rounded-lg max-w-[180px]">`;
            else if (data.type === 'code') body = `<pre class="code-block"><code class="language-js">${data.content}</code></pre>`;
            else body = `<p class="text-[13px]">${data.content}</p>`;

            div.innerHTML = `
                <div class="msg-bubble ${sender === 'me' ? 'msg-me' : 'msg-peer'} p-3 px-4 shadow-sm group" onclick="showReactions('${data.id}')">
                    ${body}
                    ${data.burn ? `<div class="burn-bar" id="burn-${data.id}"></div>` : ''}
                </div>
                <div id="reactions-${data.id}" class="flex gap-1"></div>
            `;

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            if (data.type === 'code') Prism.highlightAll();

            if (data.burn) {
                const bar = document.getElementById(`burn-${data.id}`);
                bar.style.width = '100%';
                setTimeout(() => {
                    bar.style.width = '0%';
                    setTimeout(() => div.classList.add('animate__fadeOut'), 4500);
                    setTimeout(() => div.remove(), 5000);
                }, 100);
            }
        }

        function showReactions(msgId) {
            const emojis = ['ðŸ‘', 'â¤ï¸', 'ðŸ”¥', 'ðŸ˜‚'];
            const existing = document.getElementById(`reactions-${msgId}`);
            if (existing.innerHTML !== '') return; 
            
            emojis.forEach(e => {
                const btn = document.createElement('button');
                btn.className = "text-xs hover:scale-125 transition active:scale-90";
                btn.innerText = e;
                btn.onclick = () => {
                    const reaction = { type: 'reaction', msgId, emoji: e };
                    conn.send(reaction);
                    applyReaction(reaction);
                };
                existing.appendChild(btn);
            });
            setTimeout(() => { if(existing) existing.innerHTML = ''; }, 3000);
        }

        function applyReaction(data) {
            const msg = document.getElementById(`msg-${data.msgId}`);
            if (!msg) return;
            const chip = document.createElement('div');
            chip.className = "reaction-chip animate__animated animate__bounceIn";
            chip.innerText = data.emoji;
            msg.appendChild(chip);
        }

        function toggleBurnMode() {
            burnMode = !burnMode;
            document.getElementById('burn-toggle').classList.toggle('text-rose-400', burnMode);
            if(burnMode) confetti({ colors: ['#fb7185'], particleCount: 20 });
        }

        function setTheme(t) {
            document.body.setAttribute('data-theme', t);
            localStorage.setItem('tactile-theme', t);
        }

        function copyId() {
            navigator.clipboard.writeText(document.getElementById('gateway-id').innerText);
        }

        function toggleGiphy() { document.getElementById('giphy-panel').classList.toggle('hidden'); }
        async function searchGiphy() {
            const q = document.getElementById('giphy-search').value;
            if (q.length < 2) return;
            const res = await fetch(`https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_KEY}&q=${q}&limit=8`);
            const { data } = await res.json();
            const results = document.getElementById('giphy-results');
            results.innerHTML = '';
            data.forEach(gif => {
                const img = document.createElement('img');
                img.src = gif.images.fixed_height_small.url;
                img.className = "w-full rounded-lg cursor-pointer hover:opacity-80 transition";
                img.onclick = () => { sendMessage({ type: 'gif', content: gif.images.fixed_height.url }); toggleGiphy(); };
                results.appendChild(img);
            });
        }

        function sendCodePrompt() {
            const code = prompt("Paste code snippet:");
            if (code) sendMessage({ type: 'code', content: code });
        }

        function toggleTyping(state) { document.getElementById('typing-indicator').style.visibility = state ? 'visible' : 'hidden'; }

        // Input Auto-resize
        document.getElementById('chat-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(conn) conn.send({ type: 'typing', state: true });
        });

        document.getElementById('chat-input').onkeydown = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
        document.getElementById('giphy-search').oninput = searchGiphy;

        window.onload = init;
    </script>
</body>
</html>
