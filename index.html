<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tactile v0.3 - P2P Suite</title>
    
    <!-- Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <!-- Core JS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.18.3/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/linkifyjs@4.1.3/dist/linkify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/linkify-html@4.1.3/dist/linkify-html.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

        :root {
            --font-sans: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --bg-app: #f8fafc;
        }

        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            font-family: var(--font-sans);
            background-color: var(--bg-app);
            color: #0f172a;
            overflow: hidden;
        }

        /* UTILS */
        .full-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; overflow-y: auto; }
        .center-flex { display: flex; align-items: center; justify-content: center; }

        /* CHAT BUBBLES - REFINED */
        .chat-bubble {
            font-size: 0.925rem;
            line-height: 1.4;
            padding: 0.6rem 0.85rem;
            border-radius: 1.25rem; 
            box-shadow: 0 1px 1px rgba(0,0,0,0.03);
            max-width: 70%; /* Reduced width */
            min-height: auto; 
            position: relative;
            display: flex; 
            flex-direction: column;
        }
        
        .chat-start .chat-bubble { background-color: white; color: #1e293b; border: 1px solid #e2e8f0; border-bottom-left-radius: 4px; }
        .chat-end .chat-bubble { background: #3b82f6; color: white; border-bottom-right-radius: 4px; border: none; }
        
        .chat-end .chat-bubble a { color: #dbeafe !important; text-decoration: underline; }
        .chat-start .chat-bubble a { color: #2563eb !important; text-decoration: underline; }

        /* Media / Images - CLEANER */
        .chat-bubble.media-only { background: transparent !important; box-shadow: none !important; padding: 0 !important; border: none !important; overflow: visible !important; }
        .media-wrapper { border-radius: 1rem; overflow: hidden; background: #e2e8f0; border: 1px solid rgba(0,0,0,0.05); position: relative; display: inline-block; box-shadow: 0 2px 8px -2px rgba(0,0,0,0.1); }
        .media-wrapper img { display: block; max-width: 100%; max-height: 250px; object-fit: cover; transition: transform 0.2s; }
        .media-wrapper:hover img { transform: scale(1.02); }

        /* Link Card */
        .link-preview-card {
            margin-top: 6px;
            background: rgba(0,0,0,0.03);
            border-radius: 8px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(0,0,0,0.05);
            text-decoration: none !important;
        }
        .chat-end .link-preview-card { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.2); }
        .link-domain { font-weight: 700; font-size: 0.75rem; opacity: 0.9; display: block; }
        .link-url { font-size: 0.7rem; opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; display: block; }

        /* FILE CARD - HORIZONTAL LAYOUT */
        .file-card-container {
            margin-top: 4px;
            max-width: 280px;
        }
        .file-card {
            display: flex;
            flex-direction: row; /* FORCE HORIZONTAL */
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none !important;
            color: #1e293b !important;
        }
        .file-card:hover { background: #f8fafc; transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .file-icon {
            width: 36px; height: 36px;
            border-radius: 8px;
            background: #eff6ff;
            color: #3b82f6;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        .file-info {
            display: flex; flex-direction: column;
            overflow: hidden;
            flex-grow: 1;
        }
        .file-name { font-weight: 600; font-size: 0.85rem; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;}
        .file-status { font-size: 0.7rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; display: block; }

        /* SCROLLBAR */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* ANIMATIONS */
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .msg-enter { animation: slideUp 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* INPUT RESET */
        .input:focus, .textarea:focus { outline: none !important; box-shadow: none !important; border-color: transparent !important; }
        #emoji-popover emoji-picker { width: 100%; height: 300px; --background: #ffffff; --border-color: #e2e8f0; }

        .glass-panel { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #e2e8f0; }
        
        canvas { touch-action: none; }
    </style>
</head>
<body class="bg-slate-50 text-base-content antialiased h-full w-full overflow-hidden">

    <!-- 1. LANDING PAGE -->
    <div id="landing-page" class="full-overlay bg-white flex flex-col items-center justify-center transition-opacity duration-500 z-[100]">
        <div class="hero min-h-screen bg-slate-50 w-full">
            <div class="hero-content flex-col lg:flex-row-reverse gap-12 w-full max-w-5xl p-6">
                <div class="text-center lg:text-left">
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-50 text-blue-600 text-xs font-bold mb-6 border border-blue-100">
                        <span class="w-2 h-2 rounded-full bg-blue-600 animate-pulse"></span> v0.3 STABLE
                    </div>
                    <h1 class="text-6xl font-extrabold tracking-tight text-slate-900">Tactile.io</h1>
                    <p class="py-6 text-xl text-slate-500 leading-relaxed font-light">
                        P2P Chat, File Sharing & <span class="font-bold text-indigo-600">Games</span>.
                    </p>
                </div>
                
                <div class="card shrink-0 w-full max-w-md shadow-2xl bg-white border border-slate-100">
                    <div class="card-body gap-5 p-8">
                        <input type="text" id="username-input" class="input input-bordered w-full bg-slate-50" placeholder="Display Name" />
                        <input type="text" id="room-input" class="input input-bordered w-full bg-slate-50 font-mono uppercase" placeholder="ROOM-ID" />
                        <div class="grid grid-cols-1 gap-3 mt-2">
                            <button onclick="initSession('host-group')" class="btn btn-primary bg-blue-600 border-none text-white">Host Group</button>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="initSession('host-1on1')" class="btn btn-outline">Private</button>
                                <button onclick="initSession('join')" class="btn btn-neutral">Join</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. CONNECTING -->
    <div id="connecting-state" class="full-overlay bg-white z-[90] hidden flex flex-col items-center justify-center">
        <div class="loading loading-ring loading-lg text-primary"></div>
        <p class="mt-4 font-mono text-xs font-bold text-slate-400">CONNECTING...</p>
    </div>

    <!-- 3. MAIN APP -->
    <div id="app-interface" class="hidden h-full w-full">
        <div class="drawer md:drawer-open h-full">
            <input id="main-drawer" type="checkbox" class="drawer-toggle" />
            
            <div class="drawer-content flex flex-col h-full relative overflow-hidden bg-white">
                
                <!-- Navbar -->
                <div class="navbar h-14 min-h-[3.5rem] px-4 flex-none z-30 glass-panel sticky top-0">
                    <div class="flex-none md:hidden">
                        <label for="main-drawer" class="btn btn-square btn-ghost text-slate-500 btn-sm">
                            <i class="ph-bold ph-list text-xl"></i>
                        </label>
                    </div>
                    <div class="flex-1 px-2 mx-2 overflow-hidden">
                        <div class="flex flex-col">
                            <span class="font-bold text-sm leading-tight truncate text-slate-800" id="header-title">Room</span>
                            <div class="flex items-center gap-1.5">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Live</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex-none gap-1">
                        <button onclick="toggleGameMode()" class="btn btn-ghost btn-circle btn-sm text-indigo-500 hover:bg-indigo-50" title="Play Game">
                            <i class="ph-bold ph-game-controller text-lg"></i>
                        </button>
                        <div class="w-px h-4 bg-slate-200 mx-1"></div>
                        <button onclick="startCall(false)" class="btn btn-ghost btn-circle btn-sm text-slate-500"><i class="ph-bold ph-phone text-lg"></i></button>
                        <button onclick="startCall(true)" class="btn btn-ghost btn-circle btn-sm text-slate-500"><i class="ph-bold ph-video text-lg"></i></button>
                    </div>
                </div>

                <!-- GAME CONTAINER -->
                <div id="game-container" class="hidden flex-col h-64 bg-slate-100 border-b border-slate-200 shrink-0 relative">
                    <div class="absolute top-2 right-2 flex gap-2 z-10">
                        <span class="badge badge-neutral font-mono" id="game-word-display">WAITING...</span>
                        <button onclick="clearCanvas()" class="btn btn-xs btn-square bg-white"><i class="ph-bold ph-eraser"></i></button>
                        <button onclick="toggleGameMode()" class="btn btn-xs btn-square btn-error text-white"><i class="ph-bold ph-x"></i></button>
                    </div>
                    <canvas id="game-canvas" class="w-full h-full bg-white cursor-crosshair touch-none"></canvas>
                    <div class="absolute bottom-2 left-2 flex gap-1">
                        <button onclick="setGameColor('#000000')" class="w-6 h-6 rounded-full bg-black border border-white"></button>
                        <button onclick="setGameColor('#ef4444')" class="w-6 h-6 rounded-full bg-red-500 border border-white"></button>
                        <button onclick="setGameColor('#3b82f6')" class="w-6 h-6 rounded-full bg-blue-500 border border-white"></button>
                        <button onclick="setGameColor('#22c55e')" class="w-6 h-6 rounded-full bg-green-500 border border-white"></button>
                    </div>
                </div>

                <!-- Messages -->
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scroll bg-slate-50/50 relative">
                    <div class="divider text-[10px] opacity-40 my-4 font-mono">TODAY</div>
                </div>

                <!-- Floating -->
                <div class="absolute bottom-[4.5rem] left-0 right-0 px-4 pointer-events-none z-20 flex flex-col gap-2 items-center">
                    <div id="typing-indicator" class="hidden bg-white/90 backdrop-blur shadow border border-slate-200 rounded-full px-3 py-1 flex items-center gap-2">
                        <span class="loading loading-dots loading-xs text-blue-500"></span>
                        <span class="text-[10px] font-bold text-slate-500" id="typing-text">...</span>
                    </div>
                </div>

                <!-- Reply -->
                <div id="reply-preview" class="hidden mx-3 mb-2 bg-white rounded-lg p-2 shadow-sm border-l-4 border-blue-500 flex justify-between items-center animate-slide-up z-20 ring-1 ring-slate-100">
                    <div class="flex flex-col overflow-hidden min-w-0">
                        <span class="text-[10px] font-bold text-blue-500 uppercase">Replying</span>
                        <span id="reply-text" class="text-xs truncate text-slate-600">...</span>
                    </div>
                    <button onclick="cancelReply()" class="btn btn-ghost btn-xs btn-square text-slate-400"><i class="ph-bold ph-x"></i></button>
                </div>

                <!-- Input -->
                <div class="p-2 bg-white border-t border-slate-100 shrink-0 z-30 safe-pb relative">
                    
                    <div id="media-drawer" class="hidden absolute bottom-full left-0 right-0 bg-white border-t border-slate-200 shadow-xl h-64 flex flex-col z-20 rounded-t-xl">
                        <div class="p-2 border-b border-slate-100 flex gap-2">
                            <input type="text" id="sticker-search" class="input input-sm w-full bg-slate-50" placeholder="Search GIPHY..." oninput="filterStickers()">
                            <button onclick="toggleMediaDrawer(event)" class="btn btn-sm btn-ghost btn-square"><i class="ph-bold ph-x"></i></button>
                        </div>
                        <div id="sticker-grid" class="flex-1 overflow-y-auto p-2 grid grid-cols-4 gap-2 bg-slate-50 custom-scroll"></div>
                    </div>

                    <div class="flex items-end gap-2 bg-slate-100 p-1 rounded-3xl focus-within:bg-white focus-within:ring-1 focus-within:ring-blue-200 transition-all border border-transparent focus-within:border-blue-100">
                        <button onclick="document.getElementById('file-picker').click()" class="btn btn-circle btn-sm btn-ghost text-slate-400 hover:text-blue-600">
                            <i class="ph-bold ph-paperclip text-lg"></i>
                        </button>
                        
                        <textarea id="msg-input" rows="1" class="textarea textarea-ghost w-full p-2 min-h-[2.5rem] max-h-[100px] resize-none text-sm custom-scroll bg-transparent placeholder:text-slate-400" placeholder="Type a message..."></textarea>
                        
                        <div class="flex items-center gap-0.5 shrink-0 pb-0.5 pr-1">
                            <button onclick="toggleMediaDrawer(event)" class="btn btn-circle btn-xs btn-ghost text-slate-400" data-tip="GIFs"><i class="ph-bold ph-sticker text-lg"></i></button>
                            <button onclick="toggleEmojiPicker(event)" class="btn btn-circle btn-xs btn-ghost text-slate-400" data-tip="Emoji"><i class="ph-bold ph-smiley text-lg"></i></button>
                            <button onclick="sendMessage()" class="btn btn-circle btn-sm btn-primary ml-1 bg-blue-600 border-none text-white shadow-sm hover:bg-blue-700"><i class="ph-bold ph-paper-plane-right"></i></button>
                        </div>
                    </div>

                    <div id="emoji-popover" class="hidden absolute bottom-16 right-2 z-50 shadow-2xl rounded-xl overflow-hidden border border-slate-100 w-80 max-w-[90vw]">
                        <emoji-picker></emoji-picker>
                    </div>
                </div>
            </div> 

            <!-- SIDEBAR -->
            <div class="drawer-side z-40">
                <label for="main-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
                <ul class="menu p-4 w-72 min-h-full bg-white text-base-content border-r border-slate-100">
                    <div class="flex items-center gap-3 mb-6 p-3 bg-slate-50 rounded-xl border border-slate-100">
                        <div class="avatar online placeholder">
                            <div class="bg-blue-600 text-white rounded-lg w-10 text-xl font-bold flex items-center justify-center"><span id="my-avatar-initial">?</span></div>
                        </div>
                        <div class="overflow-hidden">
                            <div class="font-bold text-slate-800 truncate text-sm" id="my-name-display">Guest</div>
                            <div class="text-[10px] uppercase font-bold text-slate-400 tracking-wider" id="my-role-display">...</div>
                        </div>
                    </div>

                    <li class="menu-title text-xs font-bold text-slate-400 uppercase mb-1 px-2">Channels</li>
                    <li>
                        <a onclick="switchContext('group')" id="nav-group" class="active flex justify-between rounded-lg mb-1 font-medium hover:bg-blue-50 text-sm">
                            <span class="flex items-center gap-2"><i class="ph-bold ph-users-three text-blue-500"></i> <span id="group-nav-text">General</span></span>
                            <span class="badge badge-sm badge-ghost font-mono" id="group-badge"></span>
                        </a>
                    </li>

                    <li class="menu-title text-xs font-bold text-slate-400 uppercase mt-4 mb-1 px-2">People</li>
                    <div id="dm-list" class="flex flex-col gap-1"></div>

                    <div class="mt-auto">
                        <div class="bg-slate-900 p-3 rounded-lg text-white shadow-lg cursor-pointer hover:bg-slate-800 transition" onclick="navigator.clipboard.writeText(this.innerText); showToast('ID Copied')">
                            <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Session ID</p>
                            <div class="font-mono text-xs break-all select-all" id="session-id-display">...</div>
                        </div>
                    </div>
                </ul>
            </div>
        </div>
    </div>

    <!-- CALL OVERLAY -->
    <div id="call-overlay" class="hidden fixed inset-0 z-[200] bg-slate-900 flex flex-col">
        <div class="flex-1 relative bg-black flex flex-col justify-center">
            <video id="remote-video" autoplay playsinline class="w-full h-full object-contain"></video>
            <div class="absolute top-6 right-6 w-32 aspect-[3/4] bg-slate-800 rounded-xl overflow-hidden shadow-2xl border border-white/10">
                <video id="local-video" autoplay playsinline muted class="w-full h-full object-cover transform scale-x-[-1]"></video>
            </div>
        </div>
        <div class="p-6 flex justify-center gap-6 bg-slate-900 border-t border-slate-800">
            <button onclick="endCall()" class="btn btn-circle btn-error text-white"><i class="ph-fill ph-phone-slash text-xl"></i></button>
        </div>
    </div>

    <!-- MODALS -->
    <dialog id="incoming-call-modal" class="modal"><div class="modal-box text-center shadow-xl"><h3 class="font-bold text-lg">Incoming Call</h3><div class="flex justify-center gap-4 mt-4"><button onclick="rejectCall()" class="btn btn-error btn-circle"><i class="ph-bold ph-phone-slash"></i></button><button onclick="answerCall()" class="btn btn-success btn-circle"><i class="ph-bold ph-phone"></i></button></div></div></dialog>

    <!-- CONTEXT MENU -->
    <div id="context-menu" class="hidden fixed z-[9999] bg-white border border-slate-100 shadow-xl rounded-xl p-1.5 min-w-[150px] animate-scale-in">
        <div class="flex gap-1 mb-2 p-1 bg-slate-50 rounded-lg justify-center">
            <button class="hover:scale-125 transition" onclick="sendReaction('üëç')">üëç</button>
            <button class="hover:scale-125 transition" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
            <button class="hover:scale-125 transition" onclick="sendReaction('üòÇ')">üòÇ</button>
        </div>
        <button onclick="handleCtxAction('reply')" class="btn btn-sm btn-ghost w-full justify-start font-normal text-xs h-8 min-h-0"><i class="ph-bold ph-arrow-u-up-left"></i> Reply</button>
        <button onclick="handleCtxAction('copy')" class="btn btn-sm btn-ghost w-full justify-start font-normal text-xs h-8 min-h-0"><i class="ph-bold ph-copy"></i> Copy</button>
        <button id="ctx-delete-btn" onclick="handleCtxAction('delete')" class="btn btn-sm btn-ghost w-full justify-start font-normal text-xs h-8 min-h-0 text-red-500 hidden"><i class="ph-bold ph-trash"></i> Delete</button>
    </div>

    <input type="file" id="file-picker" class="hidden">

    <script>
        const STICKERS = [
            { url: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExM3ZtZ3Zt/l0HlHJGHe3yAMhdQY/giphy.gif', tags: 'cat' },
            { url: 'https://media.giphy.com/media/26tPplGWjN0xLybiU/giphy.gif', tags: 'yes' },
            { url: 'https://media.giphy.com/media/xT5LMHxhOfscxPfIfm/giphy.gif', tags: 'no' },
            { url: 'https://media.giphy.com/media/l3q2K5jinAlChoCLS/giphy.gif', tags: 'what' }
        ];

        let peer, myId, myName, myRole='guest', sessionMode='group', connections={}, participants={}, chats={'group':[]}, unread={}, activeContext='group';
        let ctxTarget=null, replyContext=null, typingTimeout=null, incomingFileBuffer={}, localStream, currentCall;
        const CHUNK_SIZE=16*1024;
        
        // GAME STATE
        let gameActive = false;
        let isDrawer = false;
        let currentWord = "";
        let canvas, ctx;
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let gameColor = "#000000";

        const sounds = { pop: new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.m4a'), msg: new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.m4a') };

        document.addEventListener('DOMContentLoaded', () => {
            renderStickerGrid(STICKERS);
            canvas = document.getElementById('game-canvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            
            document.addEventListener('mousedown', e => {
                if(!e.target.closest('#context-menu')) document.getElementById('context-menu').classList.add('hidden');
                if(!e.target.closest('#emoji-popover') && !e.target.closest('button[data-tip="Emoji"]')) document.getElementById('emoji-popover').classList.add('hidden');
                if(!e.target.closest('#media-drawer') && !e.target.closest('button[data-tip="GIFs"]')) document.getElementById('media-drawer').classList.add('hidden');
            });

            const ta = document.getElementById('msg-input');
            ta.addEventListener('input', function(){ this.style.height='auto';this.style.height=this.scrollHeight+'px'; });
            ta.addEventListener('keydown', e=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault(); checkGameGuess(ta.value); sendMessage();} sendTyping(); });
            document.querySelector('emoji-picker').addEventListener('emoji-click', e=>{ta.value+=e.detail.unicode;ta.focus();});
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('touchstart', (e)=>{e.preventDefault(); startDrawing(e.touches[0])});
            canvas.addEventListener('touchmove', (e)=>{e.preventDefault(); draw(e.touches[0])});
            canvas.addEventListener('touchend', stopDrawing);
            window.addEventListener('resize', resizeCanvas);
        });

        // --- INIT ---
        function initSession(action) {
            const name = document.getElementById('username-input').value.trim() || "Guest";
            const room = document.getElementById('room-input').value.trim().toLowerCase().replace(/[^a-z0-9]/g,'-');
            if(!room) return showToast("Room ID required", "error");
            myName = name;
            if(action==='host-group') { myRole='host'; sessionMode='group'; myId=`tactile-${room}-HOST`; }
            else if(action==='host-1on1') { myRole='host'; sessionMode='1on1'; myId=`tactile-${room}-HOST`; }
            else { myRole='guest'; myId=`tactile-${room}-${Math.random().toString(36).substr(2,5)}`; }

            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('connecting-state').classList.remove('hidden');
            document.getElementById('my-name-display').innerText = myName;
            document.getElementById('my-avatar-initial').innerText = myName[0].toUpperCase();
            document.getElementById('my-role-display').innerText = myRole.toUpperCase();
            document.getElementById('session-id-display').innerText = myId;

            peer = new Peer(myId);
            peer.on('open', ()=>{
                document.getElementById('connecting-state').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden');
                if(myRole==='guest') connectToHost(myId.split('-').slice(0,2).join('-')+'-HOST');
            });
            peer.on('connection', handleConn);
            peer.on('call', handleIncomingCall);
            peer.on('error', e=>{ showToast("Connection Error: "+e.type, 'error'); setTimeout(()=>location.reload(),2000); });
        }

        function connectToHost(id) { const c=peer.connect(id,{metadata:{name:myName}}); handleConn(c); }
        function handleConn(conn) {
            if(myRole==='host'&&sessionMode==='1on1'&&Object.keys(connections).length>0) { conn.on('open', ()=>{conn.send({type:'error',msg:'Room Full'});setTimeout(()=>conn.close(),500)}); return; }
            conn.on('open', ()=>{ connections[conn.peer]=conn; conn.send({type:'handshake',name:myName}); });
            conn.on('data', d=>processData(d,conn));
            conn.on('close', ()=>{ delete connections[conn.peer]; delete participants[conn.peer]; updateNav(); showToast("Peer Left"); });
        }

        function processData(data, conn) {
            if(myRole==='host') {
                if(data.to&&data.to!==myId && connections[data.to]) connections[data.to].send(data);
                else if(!data.to && data.type!=='handshake') Object.values(connections).forEach(c=>{if(c.peer!==conn.peer)c.send(data)});
            }
            switch(data.type) {
                case 'handshake':
                    participants[conn.peer]=data.name; updateNav();
                    if(myRole==='host') {
                        conn.send({type:'sync', list:{...participants,[myId]:myName}, mode:sessionMode});
                        broadcast({type:'join', id:conn.peer, name:data.name}, conn.peer);
                    }
                    break;
                case 'sync': participants=data.list; sessionMode=data.mode||'group'; delete participants[myId]; updateNav(); break;
                case 'join': participants[data.id]=data.name; updateNav(); showToast(data.name+" joined"); break;
                case 'message': receiveMessage(data); break;
                case 'typing': showTyping(data); break;
                case 'reaction': handleReaction(data); break;
                case 'delete': handleDelete(data); break;
                case 'file-start': case 'file-chunk': handleFile(data); break;
                case 'game-start': startGame(data.drawer, false); break;
                case 'game-draw': drawRemote(data); break;
                case 'game-clear': ctx.clearRect(0,0,canvas.width,canvas.height); break;
                case 'game-win': showToast(`Winner: ${data.winner}! Word: ${data.word}`, 'success'); resetGame(); break;
            }
        }

        // --- MESSAGING ---
        function sendMessage() {
            const input = document.getElementById('msg-input');
            const txt = input.value.trim();
            if(!txt) return;
            const msg = {type:'message', id:crypto.randomUUID(), content:txt, from:myId, senderName:myName, to:activeContext==='group'?null:activeContext, timestamp:Date.now(), replyTo:replyContext};
            storeMessage(msg, activeContext); renderMessage(msg, true); sendNetwork(msg);
            input.value=''; input.style.height='auto'; cancelReply(); sounds.pop.play().catch(()=>{});
        }

        function renderMessage(msg, isMe) {
            const c = document.getElementById('messages-container');
            const d = document.createElement('div');
            d.className = `chat ${isMe?'chat-end':'chat-start'} msg-enter group`;
            d.id = `msg-${msg.id}`;

            const urlRegex = /((https?|blob):\/\/[^\s]+)/g;
            const match = msg.content.match(urlRegex);
            let mediaHtml = '', isMediaOnly = false, linkCardHtml = '';

            // Detect Image (Mime or Regex)
            const isImg = msg.mimeType?.startsWith('image/') || /\.(jpeg|jpg|gif|png|webp)(\?.*)?$/i.test(msg.content) || (match && msg.content.startsWith('blob:'));

            if(isImg && match) {
                const url = match[0];
                if(msg.content.trim() === url) isMediaOnly = true;
                mediaHtml = `<div class="media-wrapper mt-1 cursor-pointer" onclick="window.open('${url}')"><img src="${url}"></div>`;
            } else if(match) {
                // Regular Link Card
                try {
                    const url = match[0];
                    const domain = new URL(url).hostname;
                    linkCardHtml = `<a href="${url}" target="_blank" class="link-preview-card text-base-content/70 hover:bg-base-200"><div class="w-8 h-8 bg-base-300 rounded flex items-center justify-center"><i class="ph-bold ph-link"></i></div><div class="flex flex-col overflow-hidden"><span class="link-domain">${domain}</span><span class="link-url">${url}</span></div></a>`;
                } catch(e){}
            }

            const formatted = linkifyHtml(msg.content, {target:'_blank', className:'font-bold underline decoration-2'});
            const senderHeader = (!isMe && activeContext==='group' && sessionMode!=='1on1') ? `<div class="chat-header text-[10px] opacity-50 mb-1 ml-1 font-bold">${msg.senderName}</div>` : '';
            const replyHtml = msg.replyTo ? `<div class="text-xs border-l-2 border-base-content/20 pl-2 mb-1 opacity-60 truncate">${msg.replyTo.text}</div>` : '';

            d.innerHTML = `
                ${senderHeader}
                <div class="chat-bubble ${isMediaOnly?'media-only':''} shadow-sm">
                    ${replyHtml}
                    ${!isMediaOnly ? `<div class="break-words">${formatted}</div>` : ''}
                    ${mediaHtml}
                    ${linkCardHtml}
                    <div class="text-[9px] opacity-50 text-right mt-1 font-mono">${new Date(msg.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
                    <div id="reacts-${msg.id}" class="absolute -bottom-2 ${isMe?'right-0':'left-0'} bg-base-100 border text-[10px] px-1.5 rounded-full hidden shadow-sm scale-90"></div>
                </div>`;
            
            d.querySelector('.chat-bubble').oncontextmenu = e => { e.preventDefault(); ctxTarget={id:msg.id,text:msg.content,isMe}; const m=document.getElementById('context-menu'); m.style.left=Math.min(e.clientX,window.innerWidth-160)+'px'; m.style.top=e.clientY+'px'; m.classList.remove('hidden'); document.getElementById('ctx-delete-btn').classList.toggle('hidden',!isMe); };
            c.appendChild(d); c.scrollTop = c.scrollHeight;
        }

        // --- FILE HANDLING ---
        document.getElementById('file-picker').addEventListener('change', async e => {
            const f = e.target.files[0]; if(!f) return;
            const fid = crypto.randomUUID();
            const url = URL.createObjectURL(f);
            const mime = f.type;
            
            const msg = {type:'message', id:fid, content:url, senderName:myName, from:myId, timestamp:Date.now(), mimeType:mime};
            
            if(mime.startsWith('image/')) renderMessage(msg, true);
            else renderFileCard(fid, f.name, url, true, true);
            
            const meta = {type:'file-start', id:fid, name:f.name, mime:mime, total:Math.ceil(f.size/CHUNK_SIZE), senderName:myName, from:myId, to:activeContext==='group'?null:activeContext};
            sendNetwork(meta);
            const buf = await f.arrayBuffer(); const u8 = new Uint8Array(buf);
            for(let i=0; i<meta.total; i++) {
                const chunk = u8.slice(i*CHUNK_SIZE, (i+1)*CHUNK_SIZE);
                let bin = ''; for(let b of chunk) bin+=String.fromCharCode(b);
                sendNetwork({type:'file-chunk', id:fid, index:i, data:window.btoa(bin), from:myId, to:meta.to});
                if(i%5===0) await new Promise(r=>setTimeout(r,10));
            }
        });

        function handleFile(d) {
            if(d.type==='file-start') { incomingFileBuffer[d.id]={name:d.name, mime:d.mime, total:d.total, count:0, chunks:[]}; renderFilePlaceholder(d.id, d.name, false, d.senderName); }
            else {
                const f = incomingFileBuffer[d.id]; if(!f) return;
                f.chunks[d.index] = d.data; f.count++;
                if(f.count===f.total) {
                    try {
                        const bin = f.chunks.map(c=>window.atob(c)).join('');
                        const u8 = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
                        const url = URL.createObjectURL(new Blob([u8],{type:f.mime}));
                        document.getElementById(`msg-${d.id}`)?.remove();
                        if(f.mime.startsWith('image/')) renderMessage({id:d.id, content:url, senderName:participants[d.from]||'Peer', from:d.from, timestamp:Date.now(), mimeType:f.mime}, false);
                        else renderFileCard(d.id, f.name, url, false);
                    } catch(e){ console.error(e); }
                    delete incomingFileBuffer[d.id];
                }
            }
        }

        function renderFileCard(id, name, url, isMe, isLocal=false) {
            const c = document.getElementById('messages-container');
            const d = document.createElement('div');
            d.className = `chat ${isMe?'chat-end':'chat-start'}`;
            // Use dedicated file-card-container to opt-out of chat bubble styling
            d.innerHTML = `
                <div class="file-card-container">
                    <div class="file-card" onclick="const a=document.createElement('a');a.href='${url}';a.download='${name}';a.click()">
                        <div class="file-icon"><i class="ph-bold ph-file"></i></div>
                        <div class="file-info">
                            <span class="file-name">${name}</span>
                            <span class="file-status">${isLocal?'Uploaded':'Download'}</span>
                        </div>
                    </div>
                </div>`;
            c.appendChild(d); c.scrollTop=c.scrollHeight;
        }

        function renderFilePlaceholder(id, name, isMe, sender) {
            const c = document.getElementById('messages-container');
            const d = document.createElement('div'); d.id=`msg-${id}`; d.className=`chat ${isMe?'chat-end':'chat-start'}`;
            d.innerHTML = `<div class="chat-bubble !bg-base-100 !text-base-content border border-base-200 flex items-center gap-2"><span class="loading loading-spinner loading-xs"></span> Receiving ${name}...</div>`;
            c.appendChild(d);
        }

        // --- CALLING ---
        function startCall(isVideo) {
            if(Object.keys(connections).length === 0) return showToast("No peers connected", "error");
            const constraints = isVideo ? {video: true, audio: true} : {audio: true};
            
            navigator.mediaDevices.getUserMedia(constraints).then(stream => {
                localStream = stream;
                document.getElementById('call-overlay').classList.remove('hidden');
                document.getElementById('local-video').srcObject = stream;
                Object.values(connections).forEach(c => { const call = peer.call(c.peer, stream); setupCallEvents(call); });
            }).catch(e => showToast("Media Access Denied", "error"));
        }

        function handleIncomingCall(call) {
            document.getElementById('incoming-call-modal').showModal();
            window.answerCall = () => {
                document.getElementById('incoming-call-modal').close();
                navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                    localStream = stream;
                    document.getElementById('call-overlay').classList.remove('hidden');
                    document.getElementById('local-video').srcObject = stream;
                    call.answer(stream);
                    setupCallEvents(call);
                });
            };
            window.rejectCall = () => {
                document.getElementById('incoming-call-modal').close();
                call.close();
                const conn = connections[call.peer];
                if(conn) conn.send({type: 'call-rejected'});
            };
        }

        function setupCallEvents(call) {
            currentCall = call;
            call.on('stream', stream => {
                document.getElementById('remote-video').srcObject = stream;
            });
            call.on('close', endCall);
        }

        function endCall() {
            if(currentCall) currentCall.close();
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            document.getElementById('call-overlay').classList.add('hidden');
        }

        function toggleMute() {
            if(localStream) {
                const t = localStream.getAudioTracks()[0];
                t.enabled = !t.enabled;
                document.getElementById('btn-mute').classList.toggle('btn-error', !t.enabled);
                document.getElementById('btn-mute').classList.toggle('btn-outline', t.enabled);
            }
        }

        function toggleCamera() {
             if(localStream) {
                const t = localStream.getVideoTracks()[0];
                if(t) {
                    t.enabled = !t.enabled;
                    document.getElementById('btn-cam').classList.toggle('btn-error', !t.enabled);
                    document.getElementById('btn-cam').classList.toggle('btn-outline', t.enabled);
                }
            }
        }

        // --- GAME LOGIC ---
        function toggleGameMode() {
            if(activeContext !== 'group') return showToast("Games only available in Group Chat", "error");
            const el = document.getElementById('game-container');
            el.classList.toggle('hidden');
            if(!el.classList.contains('hidden')) resizeCanvas();
            if(myRole === 'host' && !gameActive) startGame(myId, true);
        }

        function startGame(drawerId, broadcastStart) {
            gameActive = true;
            isDrawer = (drawerId === myId);
            currentWord = isDrawer ? ["APPLE", "HOUSE", "SUN", "TREE", "CAR"][Math.floor(Math.random()*5)] : "";
            
            document.getElementById('game-container').classList.remove('hidden');
            resizeCanvas();
            clearCanvas();
            
            const display = document.getElementById('game-word-display');
            display.innerText = isDrawer ? `DRAW: ${currentWord}` : "GUESS THE DRAWING!";
            display.className = isDrawer ? "badge badge-primary font-mono" : "badge badge-neutral font-mono";
            
            if(broadcastStart && myRole === 'host') sendNetwork({type: 'game-start', drawer: drawerId});
        }

        function resetGame() {
            gameActive = false; isDrawer = false; currentWord = "";
            document.getElementById('game-container').classList.add('hidden');
        }

        function checkGameGuess(text) {
            if(gameActive && !isDrawer && text.toUpperCase().trim() === currentWord) {
                sendNetwork({type: 'game-win', winner: myName, word: currentWord});
                showToast("You guessed it!", "success");
            }
        }

        function startDrawing(e) { if(!isDrawer) return; isDrawing=true; draw(e); }
        function stopDrawing() { isDrawing=false; ctx.beginPath(); }
        function draw(e) {
            if(!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX||e.touches[0].clientX) - rect.left;
            const y = (e.clientY||e.touches[0].clientY) - rect.top;
            ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = gameColor;
            ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
            sendNetwork({type: 'game-draw', x, y, color: gameColor, newStroke: false});
        }
        function drawRemote(d) {
            if(isDrawer) return;
            ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = d.color;
            ctx.lineTo(d.x, d.y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(d.x, d.y);
        }
        function resizeCanvas() { canvas.width = canvas.parentElement.offsetWidth; canvas.height = canvas.parentElement.offsetHeight; }
        function clearCanvas() { ctx.clearRect(0,0,canvas.width,canvas.height); if(isDrawer) sendNetwork({type:'game-clear'}); }
        function setGameColor(c) { gameColor = c; }

        // --- UTILS ---
        function broadcast(data, exclude) { Object.values(connections).forEach(c => { if(c.peer !== exclude) c.send(data); }); }
        function sendNetwork(data) {
            if(myRole === 'host') {
                if(data.to && connections[data.to]) connections[data.to].send(data);
                else broadcast(data, null);
            } else {
                const h = Object.values(connections)[0];
                if(h) h.send(data);
            }
        }
        function storeMessage(m, c) { if(!chats[c]) chats[c]=[]; chats[c].push(m); }
        function receiveMessage(msg) {
            const ctx = (msg.to === myId) ? msg.from : 'group';
            storeMessage(msg, ctx);
            if(activeContext === ctx) renderMessage(msg, false);
            else { unread[ctx] = (unread[ctx]||0) + 1; updateNav(); showToast(`New message from ${msg.senderName}`); }
        }
        function switchContext(ctx) {
            activeContext = ctx; unread[ctx] = 0; updateNav();
            document.getElementById('messages-container').innerHTML = '<div class="divider text-[10px] opacity-40 my-4 font-mono">HISTORY</div>';
            (chats[ctx]||[]).forEach(m => renderMessage(m, m.from===myId));
            document.getElementById('header-title').innerText = ctx==='group' ? (sessionMode==='1on1'?'Private Room':'General') : (participants[ctx]||'Unknown');
            document.getElementById('main-drawer').checked = false;
        }
        function updateNav() {
            const list = document.getElementById('dm-list'); list.innerHTML = '';
            Object.entries(participants).forEach(([id, name]) => {
                list.innerHTML += `<li onclick="switchContext('${id}')"><a class="${activeContext===id?'active bg-blue-50 text-blue-700':''} text-xs font-medium"><div class="avatar placeholder online"><div class="w-5 rounded-full bg-neutral/10 text-neutral-content"><span class="text-[10px]">${name[0]}</span></div></div>${name}</a></li>`;
            });
        }
        function toggleMediaDrawer(e) { e.stopPropagation(); document.getElementById('media-drawer').classList.toggle('hidden'); }
        function toggleEmojiPicker(e) { e.stopPropagation(); document.getElementById('emoji-popover').classList.toggle('hidden'); }
        function showToast(m, t='info') { Toastify({text:m, style:{background:t==='error'?'#ef4444':'#3b82f6', borderRadius:'8px', fontSize:'12px'}}).showToast(); }
        function clearChat() { chats[activeContext]=[]; switchContext(activeContext); }
        function disconnect() { location.reload(); }
        
        function handleCtxAction(a) {
            document.getElementById('context-menu').classList.add('hidden');
            if(a==='copy') navigator.clipboard.writeText(ctxTarget.text);
            if(a==='reply') { replyContext={id:ctxTarget.id, text:ctxTarget.text.substring(0,50)+'...'}; document.getElementById('reply-preview').classList.remove('hidden'); document.getElementById('reply-text').innerText=replyContext.text; document.getElementById('msg-input').focus(); }
            if(a==='delete') sendNetwork({type:'delete', msgId:ctxTarget.id, from:myId});
        }
        function sendReaction(e) {
            document.getElementById('context-menu').classList.add('hidden');
            sendNetwork({type:'reaction', msgId:ctxTarget.id, emoji:e, from:myId, to:activeContext==='group'?null:activeContext});
            handleReaction({msgId:ctxTarget.id, emoji:e});
        }
        function handleReaction(d) { const el = document.getElementById(`reacts-${d.msgId}`); if(el) { el.innerHTML = d.emoji; el.classList.remove('hidden'); }}
        function handleDelete(d) { const el = document.getElementById(`msg-${d.msgId}`); if(el) el.innerHTML = `<div class="text-[10px] italic opacity-50 text-center py-1">Message deleted</div>`; }
        function cancelReply() { replyContext=null; document.getElementById('reply-preview').classList.add('hidden'); }
        function showTyping(d) {
            if((activeContext==='group' && !d.to) || (activeContext===d.from)) {
                const el=document.getElementById('typing-indicator'); el.classList.remove('hidden');
                document.getElementById('typing-text').innerText = `${d.senderName} is typing...`;
                clearTimeout(typingTimeout); typingTimeout=setTimeout(()=>el.classList.add('hidden'),3000);
            }
        }
        function sendTyping() { sendNetwork({type:'typing', senderName:myName, from:myId, to:activeContext==='group'?null:activeContext}); }
        function renderStickerGrid(l) { 
            const g=document.getElementById('sticker-grid'); g.innerHTML='';
            l.forEach(s=>{ g.innerHTML+=`<img src="${s.url}" class="w-full h-16 object-contain bg-slate-50 rounded cursor-pointer hover:scale-105 transition" onclick="document.getElementById('msg-input').value='${s.url}';sendMessage();document.getElementById('media-drawer').classList.add('hidden')">`; });
        }
        function filterStickers() { 
            const q=document.getElementById('sticker-search').value.toLowerCase();
            renderStickerGrid(STICKERS.filter(s=>s.tags.includes(q)));
        }
    </script>
</body>
</html>
