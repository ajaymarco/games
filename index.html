<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DoodleChain</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #6366f1; /* Indigo-500 */
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 20%);
            overscroll-behavior: none;
        }
        .pattern-grid {
            background-image: radial-gradient(#818cf8 2px, transparent 2px);
            background-size: 24px 24px;
        }
        .canvas-container {
            touch-action: none;
            cursor: crosshair;
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .card-pop {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .modal-backdrop {
            background-color: rgba(17, 24, 39, 0.7); /* Gray-900 with opacity */
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col pattern-grid text-gray-800">

    <!-- HEADER -->
    <header class="bg-white/95 backdrop-blur shadow-lg px-4 py-2 flex justify-between items-center z-10 shrink-0 border-b-4 border-indigo-200">
        <div class="flex items-center gap-2">
            <div class="bg-indigo-600 text-white w-8 h-8 rounded-lg flex items-center justify-center shadow">
                <i class="fa-solid fa-link"></i>
            </div>
            <h1 class="text-2xl font-black text-indigo-700 tracking-tight">Doodle<span class="text-orange-500">Chain</span></h1>
        </div>
        <div class="flex items-center gap-2">
             <button onclick="toggleHowTo()" class="bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-100 transition border border-indigo-100">
                <i class="fa-solid fa-circle-question mr-1"></i> Help
            </button>
            <div id="status-indicator" class="text-xs font-bold px-3 py-1.5 rounded-lg bg-gray-100 text-gray-500 border border-gray-200">
                Offline
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT AREA -->
    <main class="flex-1 relative overflow-y-auto overflow-x-hidden w-full flex flex-col items-center justify-center p-4">
        
        <!-- SCENE: LOBBY -->
        <div id="scene-lobby" class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-6 card-pop flex flex-col gap-5 border-4 border-indigo-50">
            
            <!-- Identity Section -->
            <div class="space-y-2">
                <label class="block text-xs font-black text-gray-400 uppercase tracking-wider ml-1">Your Nickname</label>
                <div class="relative">
                    <input type="text" id="input-name" placeholder="Enter name" maxlength="12" class="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-indigo-500 focus:bg-white transition font-bold text-gray-700 pl-10">
                    <i class="fa-solid fa-user absolute left-4 top-4 text-gray-400"></i>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-gray-100 p-1.5 rounded-xl flex font-bold text-sm">
                <button onclick="switchLobbyTab('host')" id="tab-host" class="flex-1 py-2.5 rounded-lg shadow-sm bg-white text-indigo-600 transition">Host Game</button>
                <button onclick="switchLobbyTab('join')" id="tab-join" class="flex-1 py-2.5 rounded-lg text-gray-500 hover:text-gray-700 transition">Join Game</button>
            </div>

            <!-- HOST PANEL -->
            <div id="section-host" class="space-y-5">
                <!-- Room Key -->
                <div class="bg-indigo-50 border-2 border-indigo-100 rounded-2xl p-4 text-center relative group">
                    <p class="text-xs text-indigo-500 font-black uppercase tracking-wider mb-1">Room Key (Share This)</p>
                    <div class="flex items-center justify-center gap-3">
                        <input type="text" id="host-key-display" value="..." class="text-3xl font-black text-indigo-700 bg-transparent text-center w-32 uppercase focus:outline-none focus:border-b-2 focus:border-indigo-500" maxlength="4" onchange="updateCustomKey(this.value)">
                        <button onclick="copyInviteLink()" class="w-10 h-10 rounded-full bg-indigo-200 text-indigo-700 hover:bg-indigo-300 transition flex items-center justify-center shadow-sm" title="Copy Link">
                            <i class="fa-solid fa-share-nodes"></i>
                        </button>
                    </div>
                    <p class="text-[10px] text-indigo-400 mt-1 font-bold">Tap key to edit</p>
                </div>

                <!-- Settings -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Game Mode</label>
                        <select id="game-mode-select" class="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-3 py-2 text-sm font-bold text-gray-700 focus:border-indigo-500 outline-none">
                            <option value="CLASSIC">Classic (Write First)</option>
                            <option value="ART_START">Art First (Draw First)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Round Timer</label>
                        <select id="game-timer-select" class="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-3 py-2 text-sm font-bold text-gray-700 focus:border-indigo-500 outline-none">
                            <option value="0">No Limit</option>
                            <option value="30">30 Seconds</option>
                            <option value="60">60 Seconds</option>
                            <option value="90">90 Seconds</option>
                        </select>
                    </div>
                </div>

                <!-- Player List -->
                <div class="bg-gray-50 rounded-xl p-3 border border-gray-100 min-h-[80px]">
                    <p class="text-xs font-bold text-gray-400 mb-2 uppercase flex justify-between">
                        <span>Players</span>
                        <span id="player-count" class="bg-gray-200 text-gray-600 px-1.5 rounded text-[10px]">1</span>
                    </p>
                    <div id="lobby-player-list" class="flex flex-wrap gap-2"></div>
                </div>

                <button onclick="startGame()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-xl shadow-[0_4px_0_rgb(67,56,202)] active:shadow-none active:translate-y-[4px] transition text-lg uppercase tracking-wide flex items-center justify-center gap-2">
                    <i class="fa-solid fa-play"></i> Start Game
                </button>
            </div>

            <!-- JOIN PANEL -->
            <div id="section-join" class="hidden space-y-4 pt-2">
                <div>
                    <label class="block text-xs font-black text-gray-400 uppercase tracking-wider ml-1 mb-1">Enter Room Key</label>
                    <input type="text" id="input-host-id" placeholder="ABCD" maxlength="4" class="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-4 focus:outline-none focus:border-indigo-500 font-mono text-center text-3xl uppercase tracking-[0.2em] font-bold text-gray-700 placeholder:text-gray-300">
                </div>
                <button onclick="joinGame()" class="w-full bg-green-500 hover:bg-green-600 text-white font-black py-4 rounded-xl shadow-[0_4px_0_rgb(21,128,61)] active:shadow-none active:translate-y-[4px] transition text-lg uppercase tracking-wide">
                    Join Room
                </button>
            </div>
        </div>

        <!-- SCENE: WAITING -->
        <div id="scene-waiting" class="hidden text-center card-pop">
            <div class="bg-white p-8 rounded-3xl shadow-xl max-w-sm mx-auto border-4 border-indigo-50">
                <div class="relative w-20 h-20 mx-auto mb-6">
                    <div class="absolute inset-0 border-4 border-gray-100 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-indigo-500 rounded-full border-t-transparent animate-spin"></div>
                    <i class="fa-solid fa-hourglass-half absolute inset-0 flex items-center justify-center text-indigo-300 text-2xl"></i>
                </div>
                <h2 class="text-2xl font-black text-gray-800 mb-2">Hold Tight!</h2>
                <p id="waiting-msg" class="text-gray-500 font-bold">Waiting for host to start...</p>
            </div>
        </div>

        <!-- SCENE: INPUT (Text) -->
        <div id="scene-input" class="hidden w-full max-w-lg card-pop">
            <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border-4 border-indigo-50">
                <div class="bg-indigo-600 p-4 text-white flex justify-between items-center shadow-md">
                    <div class="flex items-center gap-2">
                        <span class="bg-indigo-500 p-1.5 rounded-lg"><i class="fa-solid fa-pen"></i></span>
                        <p id="input-instruction" class="font-bold text-lg">Write a sentence</p>
                    </div>
                    <div id="timer-text-input" class="font-mono font-bold bg-indigo-800 px-3 py-1 rounded-lg text-sm hidden">00:00</div>
                </div>
                
                <div id="input-image-preview" class="hidden p-6 bg-gray-100 flex justify-center border-b-2 border-dashed border-gray-300 relative">
                    <span class="absolute top-2 left-2 text-[10px] font-bold text-gray-400 uppercase">Describe this image</span>
                    <img id="img-to-guess" src="" class="max-h-56 rounded-lg shadow-sm bg-white border-4 border-white transform rotate-1">
                </div>

                <div class="p-6">
                    <textarea id="game-text-input" class="w-full h-32 bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4 text-xl font-bold text-gray-800 focus:outline-none focus:border-yellow-400 focus:ring-4 focus:ring-yellow-100 resize-none placeholder:text-gray-300 leading-relaxed" placeholder="Type something funny..."></textarea>
                    <button onclick="submitRound()" class="w-full mt-4 bg-gray-900 text-white font-black py-4 rounded-xl shadow-lg hover:bg-black transition flex items-center justify-center gap-2">
                        Submit <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- SCENE: CANVAS (Drawing) -->
        <div id="scene-canvas" class="hidden w-full max-w-2xl h-full flex flex-col pb-2">
            
            <!-- Prompt Bar -->
            <div class="bg-white rounded-2xl shadow-lg p-2 mb-3 flex items-center justify-between shrink-0 mx-2 border-2 border-indigo-50">
                <div class="flex items-center gap-3 overflow-hidden flex-1">
                    <span class="bg-indigo-100 text-indigo-700 w-10 h-10 flex items-center justify-center rounded-xl shrink-0"><i class="fa-solid fa-eye"></i></span>
                    <p class="font-bold text-gray-800 text-sm truncate pr-2" id="draw-prompt">Draw: Something</p>
                </div>
                <div class="bg-red-50 text-red-600 px-3 py-1.5 rounded-xl font-mono font-bold text-lg border border-red-100 hidden" id="timer-canvas">
                    30s
                </div>
            </div>

            <!-- Canvas Area -->
            <div class="flex-1 relative bg-white rounded-2xl shadow-inner border-4 border-gray-200 overflow-hidden mx-2 touch-none cursor-crosshair canvas-container" id="canvas-wrapper">
                <canvas id="drawing-canvas"></canvas>
            </div>

            <!-- Tools -->
            <div class="bg-white rounded-2xl shadow-lg p-3 mt-3 mx-2 shrink-0 border-t border-gray-100">
                <div class="flex justify-between items-center gap-2">
                    <!-- Colors -->
                    <div class="flex gap-2 overflow-x-auto no-scrollbar py-1 px-1">
                        <button class="w-9 h-9 rounded-full bg-black border-2 border-white shadow-sm ring-2 ring-gray-100 focus:ring-indigo-500 scale-100 hover:scale-110 transition" onclick="setColor('#000000')"></button>
                        <button class="w-9 h-9 rounded-full bg-red-500 border-2 border-white shadow-sm ring-2 ring-gray-100 focus:ring-indigo-500 scale-100 hover:scale-110 transition" onclick="setColor('#ef4444')"></button>
                        <button class="w-9 h-9 rounded-full bg-blue-500 border-2 border-white shadow-sm ring-2 ring-gray-100 focus:ring-indigo-500 scale-100 hover:scale-110 transition" onclick="setColor('#3b82f6')"></button>
                        <button class="w-9 h-9 rounded-full bg-yellow-400 border-2 border-white shadow-sm ring-2 ring-gray-100 focus:ring-indigo-500 scale-100 hover:scale-110 transition" onclick="setColor('#facc15')"></button>
                        <button class="w-9 h-9 rounded-full bg-green-500 border-2 border-white shadow-sm ring-2 ring-gray-100 focus:ring-indigo-500 scale-100 hover:scale-110 transition" onclick="setColor('#22c55e')"></button>
                        <button class="w-9 h-9 rounded-full bg-white border-2 border-gray-200 shadow-sm ring-2 ring-gray-100 focus:ring-indigo-500 flex items-center justify-center text-gray-400" onclick="setColor('#ffffff', true)"><i class="fa-solid fa-eraser"></i></button>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex gap-2">
                        <button onclick="clearCanvas()" class="w-10 h-10 rounded-xl bg-gray-100 text-gray-500 hover:bg-red-100 hover:text-red-500 transition flex items-center justify-center"><i class="fa-solid fa-trash-can"></i></button>
                        <button onclick="submitRound()" class="px-6 h-10 rounded-xl bg-indigo-600 text-white font-bold shadow-md hover:bg-indigo-700 transition text-sm uppercase tracking-wide">Done</button>
                    </div>
                </div>
                <!-- Size Slider -->
                <div class="mt-3 px-1 flex items-center gap-3">
                    <i class="fa-solid fa-circle text-[4px] text-gray-300"></i>
                    <input type="range" min="2" max="25" value="5" class="flex-1 accent-indigo-600 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="setLineWidth(this.value)">
                    <i class="fa-solid fa-circle text-[12px] text-gray-300"></i>
                </div>
            </div>
        </div>

        <!-- SCENE: SHOWCASE -->
        <div id="scene-showcase" class="hidden w-full max-w-4xl h-full flex flex-col">
            <div class="text-center mb-6 shrink-0 mt-4">
                <span class="bg-white/20 text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-widest backdrop-blur-sm">Showcase</span>
                <h2 class="text-4xl font-black text-white drop-shadow-lg mt-2">The Results!</h2>
            </div>
            
            <div id="showcase-container" class="flex-1 overflow-y-auto px-4 pb-24 space-y-10 no-scrollbar">
                <!-- Albums injected here -->
            </div>

            <div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-white/95 backdrop-blur shadow-2xl rounded-full p-2 flex gap-2">
                 <button onclick="downloadResults()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 w-12 h-12 rounded-full flex items-center justify-center transition" title="Save All"><i class="fa-solid fa-download"></i></button>
                 <button onclick="location.reload()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 h-12 rounded-full font-black shadow-lg transition uppercase tracking-wide flex items-center gap-2"><i class="fa-solid fa-rotate-right"></i> Play Again</button>
            </div>
        </div>

    </main>

    <!-- MODAL: HOW TO PLAY -->
    <div id="modal-how-to" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4" onclick="if(event.target === this) toggleHowTo()">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-8 card-pop relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
            <button onclick="toggleHowTo()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
            
            <div class="text-center mb-6">
                <h2 class="text-3xl font-black text-gray-800">How to Play</h2>
                <p class="text-indigo-500 font-bold">Telephone with Drawings!</p>
            </div>
            
            <div class="space-y-5">
                <div class="flex gap-4 items-start">
                    <div class="bg-green-100 w-10 h-10 rounded-xl flex items-center justify-center text-green-600 font-bold shrink-0 text-lg shadow-sm">1</div>
                    <div>
                        <p class="font-bold text-gray-800">Get the Squad</p>
                        <p class="text-sm text-gray-500 leading-tight mt-1">Share the Room Key URL. Works best with 3+ players.</p>
                    </div>
                </div>
                <div class="flex gap-4 items-start">
                    <div class="bg-indigo-100 w-10 h-10 rounded-xl flex items-center justify-center text-indigo-600 font-bold shrink-0 text-lg shadow-sm">2</div>
                    <div>
                        <p class="font-bold text-gray-800">Start the Chain</p>
                        <p class="text-sm text-gray-500 leading-tight mt-1">Write a quirky sentence (e.g. "A cat eating pizza in space").</p>
                    </div>
                </div>
                <div class="flex gap-4 items-start">
                    <div class="bg-purple-100 w-10 h-10 rounded-xl flex items-center justify-center text-purple-600 font-bold shrink-0 text-lg shadow-sm">3</div>
                    <div>
                        <p class="font-bold text-gray-800">Draw & Guess</p>
                        <p class="text-sm text-gray-500 leading-tight mt-1">Pass it on! The next person draws your text. The person after that guesses the drawing.</p>
                    </div>
                </div>
            </div>

            <button onclick="toggleHowTo()" class="w-full mt-8 bg-gray-900 hover:bg-black text-white font-bold py-3.5 rounded-xl transition shadow-lg">
                Let's Go!
            </button>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        const APP_STATE = {
            peer: null,
            conn: null,
            connections: [],
            myId: null, // This is the Short ID
            hostId: null,
            myName: '',
            isHost: false,
            players: [],
            game: {
                phase: 'LOBBY',
                mode: 'CLASSIC',
                timerDuration: 0, // 0 = infinite
                round: 0,
                totalPlayers: 0,
                books: [],
                currentInput: null,
                timerInterval: null
            }
        };

        // --- DOM ELEMENTS ---
        const scenes = {
            lobby: document.getElementById('scene-lobby'),
            waiting: document.getElementById('scene-waiting'),
            input: document.getElementById('scene-input'),
            canvas: document.getElementById('scene-canvas'),
            showcase: document.getElementById('scene-showcase')
        };
        const statusEl = document.getElementById('status-indicator');
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');

        // --- HELPER: SHORT ID GENERATOR ---
        function generateShortId(length = 4) {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; 
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // --- PEERJS SETUP ---
        function initPeer(customId = null) {
            const idToUse = customId || generateShortId(4);

            if (APP_STATE.peer) APP_STATE.peer.destroy();

            APP_STATE.peer = new Peer(idToUse, { debug: 1 });

            APP_STATE.peer.on('open', (id) => {
                APP_STATE.myId = id;
                // Host UI updates
                document.getElementById('host-key-display').value = id;
                updateStatus('Online', 'bg-green-100 text-green-700 border-green-200');
                
                // If Host, update URL hash
                if (APP_STATE.isHost) {
                    window.location.hash = id;
                }
            });

            APP_STATE.peer.on('connection', (conn) => {
                // If not host, reject
                if (!APP_STATE.isHost) {
                    conn.close();
                    return;
                }
                handleIncomingConnection(conn);
            });

            APP_STATE.peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    // If custom ID taken, or random collision
                    if (customId) {
                        alert("That Key is already taken. Try another.");
                        document.getElementById('host-key-display').value = APP_STATE.myId; // revert
                    } else {
                        initPeer(); // retry random
                    }
                } else {
                    console.error(err);
                    updateStatus('Connection Error', 'bg-red-100 text-red-700 border-red-200');
                }
            });
        }

        // Host wants to change key
        function updateCustomKey(newKey) {
            newKey = newKey.toUpperCase().trim();
            if (newKey.length < 3) {
                alert("Key must be at least 3 characters.");
                document.getElementById('host-key-display').value = APP_STATE.myId;
                return;
            }
            if (newKey === APP_STATE.myId) return;

            // Re-init peer with new ID
            initPeer(newKey);
        }

        function updateStatus(text, classes) {
            statusEl.textContent = text;
            statusEl.className = `text-xs font-bold px-3 py-1.5 rounded-lg border ${classes}`;
        }

        // --- UI LOGIC ---
        function toggleHowTo() {
            const modal = document.getElementById('modal-how-to');
            modal.classList.toggle('hidden');
        }

        function switchLobbyTab(tab) {
            const hostSec = document.getElementById('section-host');
            const joinSec = document.getElementById('section-join');
            const tabHost = document.getElementById('tab-host');
            const tabJoin = document.getElementById('tab-join');

            if (tab === 'host') {
                hostSec.classList.remove('hidden');
                joinSec.classList.add('hidden');
                tabHost.classList.add('shadow-sm', 'bg-white', 'text-indigo-600');
                tabHost.classList.remove('text-gray-500');
                tabJoin.classList.remove('shadow-sm', 'bg-white', 'text-indigo-600');
                tabJoin.classList.add('text-gray-500');
                APP_STATE.isHost = true;
                if(APP_STATE.myId) window.location.hash = APP_STATE.myId;
                updateMyName();
            } else {
                hostSec.classList.add('hidden');
                joinSec.classList.remove('hidden');
                tabHost.classList.remove('shadow-sm', 'bg-white', 'text-indigo-600');
                tabHost.classList.add('text-gray-500');
                tabJoin.classList.add('shadow-sm', 'bg-white', 'text-indigo-600');
                tabJoin.classList.remove('text-gray-500');
                APP_STATE.isHost = false;
                window.location.hash = '';
            }
        }

        function updateMyName() {
            const nameInput = document.getElementById('input-name');
            APP_STATE.myName = nameInput.value.trim() || "Doodler " + Math.floor(Math.random() * 100);
            
            if (APP_STATE.isHost) {
                const existingParams = APP_STATE.players.find(p => p.peerId === APP_STATE.myId);
                if (!existingParams) {
                    APP_STATE.players = [{ name: APP_STATE.myName, peerId: APP_STATE.myId, isHost: true }];
                } else {
                    existingParams.name = APP_STATE.myName;
                }
                renderPlayerList();
                broadcastPlayerList();
            }
        }

        function copyInviteLink() {
            const url = window.location.origin + window.location.pathname + '#' + APP_STATE.myId;
            navigator.clipboard.writeText(url).then(() => {
                const btn = document.querySelector('button[onclick="copyInviteLink()"]');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                setTimeout(() => btn.innerHTML = originalHTML, 2000);
            });
        }

        // --- HOST LOGIC ---
        function handleIncomingConnection(conn) {
            APP_STATE.connections.push(conn);
            conn.on('data', (data) => handleDataPacket(data, conn.peer));
            conn.on('close', () => {
                APP_STATE.connections = APP_STATE.connections.filter(c => c !== conn);
                APP_STATE.players = APP_STATE.players.filter(p => p.peerId !== conn.peer);
                renderPlayerList();
                broadcastPlayerList();
            });
        }

        function broadcast(type, payload) {
            const msg = { type, payload };
            APP_STATE.connections.forEach(c => c.send(msg));
        }

        function broadcastPlayerList() {
            broadcast('PLAYER_LIST', APP_STATE.players);
        }

        function startGame() {
            if (APP_STATE.players.length < 2) {
                alert("Need at least 2 players to start!");
                return;
            }
            
            APP_STATE.game.mode = document.getElementById('game-mode-select').value;
            APP_STATE.game.timerDuration = parseInt(document.getElementById('game-timer-select').value);
            
            APP_STATE.game.round = 0;
            APP_STATE.game.totalPlayers = APP_STATE.players.length;
            APP_STATE.game.books = APP_STATE.players.map(p => ({
                ownerId: p.peerId,
                ownerName: p.name,
                pages: []
            }));

            const startPayload = { 
                totalPlayers: APP_STATE.players.length,
                mode: APP_STATE.game.mode,
                timerDuration: APP_STATE.game.timerDuration
            };
            
            broadcast('GAME_START', startPayload);
            handleGameStart(startPayload); 
        }

        // --- CLIENT LOGIC ---
        function joinGame() {
            updateMyName();
            const hostId = document.getElementById('input-host-id').value.trim().toUpperCase();
            if (!hostId) return alert("Please enter the Room Key.");

            APP_STATE.hostId = hostId;
            APP_STATE.conn = APP_STATE.peer.connect(hostId);

            APP_STATE.conn.on('open', () => {
                updateStatus('Connected', 'bg-blue-100 text-blue-700 border-blue-200');
                APP_STATE.conn.send({
                    type: 'JOIN',
                    payload: { name: APP_STATE.myName }
                });
                showScene('waiting');
                document.getElementById('waiting-msg').textContent = "Waiting for host to start...";
            });

            APP_STATE.conn.on('data', (data) => handleDataPacket(data));
            APP_STATE.conn.on('close', () => {
                alert("Host disconnected or game ended.");
                location.reload();
            });
        }

        function sendToHost(type, payload) {
            if (APP_STATE.isHost) {
                handleDataPacket({ type, payload }, APP_STATE.myId);
            } else {
                APP_STATE.conn.send({ type, payload });
            }
        }

        // --- DATA HANDLING ---
        function handleDataPacket(data, senderPeerId) {
            if (APP_STATE.isHost) {
                if (data.type === 'JOIN') {
                    // Check if name taken or just append
                    const safeName = data.payload.name || "Guest";
                    APP_STATE.players.push({ name: safeName, peerId: senderPeerId, isHost: false });
                    renderPlayerList();
                    broadcastPlayerList();
                } else if (data.type === 'SUBMIT_ROUND') {
                    handleRoundSubmission(senderPeerId, data.payload);
                }
            }

            if (data.type === 'PLAYER_LIST' && !APP_STATE.isHost) {
                APP_STATE.players = data.payload;
                renderPlayerList();
            } else if (data.type === 'GAME_START') {
                handleGameStart(data.payload);
            } else if (data.type === 'NEXT_PHASE') {
                startRound(data.payload);
            } else if (data.type === 'GAME_OVER') {
                renderShowcase(data.payload);
            }
        }

        // --- GAMEFLOW LOGIC ---

        function handleGameStart(payload) {
            APP_STATE.game.round = 1;
            APP_STATE.game.mode = payload.mode;
            APP_STATE.game.timerDuration = payload.timerDuration;
            
            if (APP_STATE.game.mode === 'ART_START') {
                showScene('canvas');
                resizeCanvas();
                clearCanvas();
                document.getElementById('draw-prompt').textContent = "Draw whatever you want!";
                setupTimer('canvas');
            } else {
                showScene('input');
                document.getElementById('input-instruction').textContent = "Start the chain! Write a sentence.";
                document.getElementById('input-image-preview').classList.add('hidden');
                document.getElementById('game-text-input').value = "";
                setupTimer('input');
            }
        }

        function startRound(payload) {
            APP_STATE.game.currentInput = payload.prompt;
            
            if (payload.mode === 'DRAW') {
                showScene('canvas');
                resizeCanvas();
                clearCanvas();
                document.getElementById('draw-prompt').textContent = "Draw: " + payload.prompt;
                setupTimer('canvas');
            } else {
                showScene('input');
                document.getElementById('input-instruction').textContent = "Describe this drawing!";
                document.getElementById('input-image-preview').classList.remove('hidden');
                document.getElementById('img-to-guess').src = payload.prompt;
                document.getElementById('game-text-input').value = "";
                setupTimer('input');
            }
        }

        // --- TIMER LOGIC ---
        function setupTimer(sceneType) {
            // Clear existing
            if (APP_STATE.game.timerInterval) clearInterval(APP_STATE.game.timerInterval);

            const duration = APP_STATE.game.timerDuration;
            const timerEl = sceneType === 'canvas' ? document.getElementById('timer-canvas') : document.getElementById('timer-text-input');
            
            if (duration === 0) {
                timerEl.classList.add('hidden');
                return;
            }

            timerEl.classList.remove('hidden');
            let timeLeft = duration;
            timerEl.textContent = timeLeft + "s";
            
            // Visual urgency
            timerEl.classList.remove('text-red-600', 'bg-red-50', 'animate-pulse');
            
            APP_STATE.game.timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft + "s";
                
                if (timeLeft <= 10) {
                    timerEl.classList.add('text-red-600', 'bg-red-50', 'animate-pulse');
                }

                if (timeLeft <= 0) {
                    clearInterval(APP_STATE.game.timerInterval);
                    // Force submit
                    submitRound(true);
                }
            }, 1000);
        }

        function submitRound(forced = false) {
            if (APP_STATE.game.timerInterval) clearInterval(APP_STATE.game.timerInterval);

            const currentScene = Object.keys(scenes).find(k => !scenes[k].classList.contains('hidden'));
            let content;

            if (currentScene === 'input') {
                let text = document.getElementById('game-text-input').value.trim();
                if (!text && forced) text = "Time ran out!"; 
                else if (!text) return alert("Please type something!");
                content = { type: 'text', value: text };
            } else if (currentScene === 'canvas') {
                content = { type: 'image', value: canvas.toDataURL('image/jpeg', 0.5) };
            }

            showScene('waiting');
            document.getElementById('waiting-msg').textContent = "Waiting for other players...";

            sendToHost('SUBMIT_ROUND', content);
        }

        function handleRoundSubmission(playerId, content) {
            const N = APP_STATE.game.totalPlayers;
            const round = APP_STATE.game.round;
            
            const playerIndex = APP_STATE.players.findIndex(p => p.peerId === playerId);
            let bookIndex = (playerIndex - (round - 1)) % N;
            if (bookIndex < 0) bookIndex += N;

            const book = APP_STATE.game.books[bookIndex];
            book.pages.push({
                type: content.type,
                value: content.value,
                author: APP_STATE.players[playerIndex].name
            });

            const pagesInCurrentRound = APP_STATE.game.books.reduce((acc, b) => acc + (b.pages.length === round ? 1 : 0), 0);

            if (pagesInCurrentRound === N) {
                advanceGame();
            }
        }

        function advanceGame() {
            const N = APP_STATE.game.totalPlayers;
            const currentRound = APP_STATE.game.round;
            
            if (currentRound >= N) {
                broadcast('GAME_OVER', APP_STATE.game.books);
                renderShowcase(APP_STATE.game.books);
                return;
            }

            APP_STATE.game.round++;
            const newRound = APP_STATE.game.round;
            const gameMode = APP_STATE.game.mode;

            let phaseType;
            if (gameMode === 'ART_START') {
                phaseType = (newRound % 2 !== 0) ? 'DRAW' : 'GUESS';
            } else {
                phaseType = (newRound % 2 === 0) ? 'DRAW' : 'GUESS';
            }

            APP_STATE.players.forEach((p, pIndex) => {
                let bookIndex = (pIndex - (newRound - 1)) % N;
                if (bookIndex < 0) bookIndex += N;

                const book = APP_STATE.game.books[bookIndex];
                const lastPage = book.pages[book.pages.length - 1];

                const payload = { 
                    mode: phaseType, 
                    prompt: lastPage.value,
                    timerDuration: APP_STATE.game.timerDuration
                };

                if (p.isHost) {
                    startRound(payload);
                } else {
                    const conn = APP_STATE.connections.find(c => c.peer === p.peerId);
                    if (conn) conn.send({ type: 'NEXT_PHASE', payload });
                }
            });
        }

        // --- UI RENDERERS ---
        function showScene(id) {
            Object.values(scenes).forEach(el => el.classList.add('hidden'));
            scenes[id].classList.remove('hidden');
        }

        function renderPlayerList() {
            const list = document.getElementById('lobby-player-list');
            list.innerHTML = '';
            APP_STATE.players.forEach(p => {
                const div = document.createElement('div');
                div.className = "bg-white border-2 border-indigo-100 text-gray-700 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm flex items-center gap-2 transform transition hover:scale-105";
                div.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-400"></span> ${p.name} ${p.isHost ? '<i class="fa-solid fa-crown text-yellow-500 ml-1"></i>' : ''}`;
                list.appendChild(div);
            });
            document.getElementById('player-count').textContent = APP_STATE.players.length;
        }

        function renderShowcase(books) {
            showScene('showcase');
            const container = document.getElementById('showcase-container');
            container.innerHTML = '';

            books.forEach((book, i) => {
                const album = document.createElement('div');
                album.className = "bg-white rounded-3xl shadow-xl overflow-hidden border-4 border-white transform transition hover:-translate-y-2 duration-500";
                
                album.innerHTML = `
                    <div class="bg-indigo-600 p-4 text-white flex items-center justify-between">
                        <h3 class="font-black text-lg tracking-wide"><i class="fa-solid fa-book-open mr-2 text-indigo-300"></i> ${book.ownerName}'s Chain</h3>
                    </div>
                `;

                const contentDiv = document.createElement('div');
                contentDiv.className = "p-6 space-y-6 bg-gray-50";

                book.pages.forEach((page, idx) => {
                    const isEven = idx % 2 === 0;
                    const row = document.createElement('div');
                    row.className = `flex flex-col items-center p-4 rounded-2xl border-2 ${isEven ? 'bg-white border-gray-200' : 'bg-yellow-50 border-yellow-200'}`;
                    
                    const authorBadge = `<div class="text-[10px] font-black text-gray-400 mb-2 uppercase tracking-wider bg-gray-100 px-2 py-1 rounded-full self-start">Step ${idx+1} â€¢ ${page.author}</div>`;
                    
                    if (page.type === 'text') {
                        row.innerHTML = `${authorBadge}<p class="text-xl font-black text-gray-800 text-center leading-snug py-2">"${page.value}"</p>`;
                    } else {
                        row.innerHTML = `${authorBadge}<img src="${page.value}" class="max-h-64 rounded-xl shadow-sm border border-gray-100 bg-white">`;
                    }
                    contentDiv.appendChild(row);
                });

                album.appendChild(contentDiv);
                container.appendChild(album);
            });
        }

        function downloadResults() {
            // Simplified: Prompt user this works best on desktop or saving manually
            alert("To save results: On mobile, long press images. On Desktop, right click 'Save Image'.");
        }

        // --- CANVAS ---
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let brushColor = '#000000';
        let brushSize = 5;

        function resizeCanvas() {
            const wrapper = document.getElementById('canvas-wrapper');
            canvas.width = wrapper.clientWidth;
            canvas.height = wrapper.clientHeight;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.fillStyle = "white";
            ctx.fillRect(0,0, canvas.width, canvas.height);
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            if (e.touches) return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }

        function startDraw(e) { e.preventDefault(); isDrawing = true; const pos = getPos(e); lastX = pos.x; lastY = pos.y; }
        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            ctx.strokeStyle = brushColor;
            ctx.lineWidth = brushSize;
            ctx.stroke();
            lastX = pos.x; lastY = pos.y;
        }
        function stopDraw() { isDrawing = false; }
        function setColor(color, isEraser = false) { brushColor = isEraser ? '#ffffff' : color; }
        function setLineWidth(val) { brushSize = val; }
        function clearCanvas() { ctx.fillStyle = "white"; ctx.fillRect(0,0, canvas.width, canvas.height); }

        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDraw);
        canvas.addEventListener('mouseout', stopDraw);
        canvas.addEventListener('touchstart', startDraw, {passive: false});
        canvas.addEventListener('touchmove', draw, {passive: false});
        canvas.addEventListener('touchend', stopDraw);

        // --- INIT ---
        window.onload = () => {
            // Check for hash
            if (window.location.hash) {
                const hashKey = window.location.hash.substring(1).toUpperCase();
                if (hashKey.length >= 3) {
                    switchLobbyTab('join');
                    document.getElementById('input-host-id').value = hashKey;
                }
            } else {
                switchLobbyTab('host');
                initPeer(); // Init random host
            }
        };

    </script>
</body>
</html>
