<!DOCTYPE html>
<html lang="en" data-theme="lofi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tactile.io - Pro P2P Chat</title>
    
    <!-- Tailwind CSS & DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Emoji Picker -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.18.3/index.js"></script>

    <!-- Linkify -->
    <script src="https://cdn.jsdelivr.net/npm/linkifyjs@4.1.3/dist/linkify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/linkify-html@4.1.3/dist/linkify-html.min.js"></script>

    <!-- Toastify JS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- AutoAnimate -->
    <script type="module">
        import autoAnimate from 'https://cdn.jsdelivr.net/npm/@formkit/auto-animate@1.0.0/index.min.js';
        window.autoAnimate = autoAnimate;
    </script>

    <style>
        :root {
            --accent-primary: #0088cc;
        }

        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #e5e7eb;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
            height: 100dvh;
            overflow: hidden;
        }

        /* Message Area Background */
        #messages-container {
            background-color: #f3f4f6;
            scroll-behavior: smooth;
        }

        /* DaisyUI Chat Bubble Overrides */
        .chat-bubble {
            min-height: auto;
            padding: 0.5rem 1rem;
            font-size: 0.95rem;
            line-height: 1.5;
            max-width: 85%;
        }
        
        .chat-bubble-primary {
            background-color: #2563eb;
            color: white;
        }

        /* Ephemeral Message Style */
        .msg-timed .chat-bubble {
            border: 2px dashed #7c3aed;
            background-color: #f3e8ff;
            color: #4c1d95;
        }
        .chat-end.msg-timed .chat-bubble {
            background-color: #7c3aed;
            color: white;
            border: 2px dashed rgba(255,255,255,0.5);
        }

        /* Image Constraints */
        .chat-image-content {
            max-height: 300px;
            width: auto;
            max-width: 100%;
            border-radius: 0.75rem;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Emoji Picker Override */
        emoji-picker {
            width: 100%;
            height: 300px;
            --background: #fff;
            --border-color: #e5e7eb;
        }
        
        #context-menu {
            position: fixed;
            z-index: 2000;
        }
        
        #upload-progress { transition: width 0.1s linear; }

        .recording-active {
            animation: pulse-red 1.5s infinite;
            background-color: #fee2e2 !important;
            color: #dc2626 !important;
            border-color: #dc2626 !important;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        /* Input Area Fixes */
        .textarea-chat {
            min-height: 3rem;
            max-height: 8rem;
            padding-right: 4rem; /* Space for absolute buttons */
            line-height: 1.5;
        }
    </style>
</head>
<body class="text-base-content">

    <div id="app" class="relative w-full h-full max-w-6xl mx-auto flex flex-col sm:p-4 lg:p-6">
        
        <!-- 1. LANDING PAGE -->
        <div id="landing-page" class="flex-1 w-full h-full flex flex-col items-center justify-center p-4 z-20">
            <div class="card w-full max-w-3xl bg-base-100 shadow-xl overflow-hidden border border-base-200">
                <div class="card-body p-0 md:flex-row">
                    <!-- Brand Section -->
                    <div class="bg-neutral text-neutral-content p-10 flex flex-col items-center justify-center md:w-5/12 text-center">
                        <i class="ph-duotone ph-chats-circle text-6xl mb-4"></i>
                        <h1 class="text-4xl font-bold tracking-tight">Tactile.io</h1>
                        <p class="mt-2 opacity-90 font-medium">Professional P2P Suite</p>
                        <div class="mt-8 text-xs opacity-75 font-mono bg-white/10 px-3 py-1 rounded-full">v5.1 Stable</div>
                    </div>

                    <!-- Input Section -->
                    <div class="p-8 flex flex-col justify-center gap-6 md:w-7/12 bg-base-100">
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text font-bold uppercase text-xs tracking-wider opacity-70">Identity</span>
                            </label>
                            <input type="text" id="username-input" placeholder="Display Name" class="input input-bordered w-full" maxlength="20" />
                        </div>
                        
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text font-bold uppercase text-xs tracking-wider opacity-70">Secure Frequency</span>
                            </label>
                            <div class="relative">
                                <i class="ph-bold ph-hash absolute left-3 top-1/2 -translate-y-1/2 opacity-50"></i>
                                <input type="text" id="room-input" placeholder="ROOM-CODE" class="input input-bordered w-full pl-9 font-mono uppercase" />
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button onclick="startSession('create')" class="btn btn-neutral gap-2">
                                <i class="ph-bold ph-broadcast"></i> Host
                            </button>
                            <button onclick="startSession('join')" class="btn btn-outline gap-2">
                                <i class="ph-bold ph-plugs-connected"></i> Join
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. CHAT INTERFACE -->
        <div id="chat-interface" class="hidden absolute inset-0 sm:static sm:h-full sm:rounded-2xl overflow-hidden flex flex-col bg-base-100 shadow-2xl ring-1 ring-base-300">
            
            <!-- Header -->
            <div class="navbar bg-base-100 border-b border-base-200 h-16 min-h-[4rem] px-4 shrink-0 z-40">
                <div class="flex-1 gap-3 overflow-hidden">
                    <div class="avatar online placeholder cursor-pointer" onclick="toggleSettings()">
                        <div class="bg-neutral text-neutral-content rounded-full w-10 ring-1 ring-base-content/10">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Init" id="remote-avatar">
                        </div>
                    </div>
                    <div class="flex flex-col overflow-hidden">
                        <h2 id="chat-title" class="font-bold text-sm sm:text-base leading-tight truncate">Waiting...</h2>
                        <span id="chat-status" class="text-xs text-base-content/60 truncate">Disconnected</span>
                    </div>
                </div>
                <div class="flex-none gap-1">
                    <button onclick="startCall(false)" class="btn btn-ghost btn-circle btn-sm" title="Voice Call">
                        <i class="ph-bold ph-phone text-lg"></i>
                    </button>
                    <button onclick="startCall(true)" class="btn btn-ghost btn-circle btn-sm text-success" title="Video Call">
                        <i class="ph-bold ph-video text-lg"></i>
                    </button>
                    <div class="divider divider-horizontal m-0 mx-1 h-6 self-center"></div>
                    <button onclick="toggleSettings()" class="btn btn-ghost btn-circle btn-sm">
                        <i class="ph-bold ph-dots-three-vertical text-lg"></i>
                    </button>
                    <button onclick="disconnect()" class="btn btn-ghost btn-circle btn-sm text-error" title="Disconnect">
                        <i class="ph-bold ph-power text-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Upload Bar -->
            <div id="upload-bar" class="hidden h-1 w-full bg-base-200 shrink-0">
                <div id="upload-progress" class="h-full bg-primary w-0"></div>
            </div>

            <!-- Messages Area -->
            <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="flex flex-col items-center justify-center mt-20 opacity-50 select-none text-center">
                    <div class="w-16 h-16 rounded-2xl bg-base-200 flex items-center justify-center mb-4">
                        <i class="ph-duotone ph-shield-check text-3xl"></i>
                    </div>
                    <p class="text-sm font-bold">End-to-End Encrypted</p>
                    <p class="text-xs mt-1 max-w-xs">Messages are peer-to-peer. No server storage.</p>
                </div>
                <!-- Spacer for bottom elements -->
                <div class="h-2"></div>
            </div>

            <!-- Indicators -->
            <div id="indicators-area" class="relative z-20 px-4">
                <div id="activity-indicator" class="hidden absolute bottom-2 left-6 bg-base-100/95 backdrop-blur px-3 py-1.5 rounded-full text-xs font-bold shadow-md border border-base-200 flex items-center gap-2 transform -translate-y-full">
                    <span class="loading loading-dots loading-xs text-primary"></span>
                    <span id="activity-text">Typing...</span>
                </div>

                <div id="reply-preview" class="hidden bg-base-200/80 border-t border-base-300 p-2 px-4 flex justify-between items-center text-sm backdrop-blur-sm rounded-t-xl mx-1 mb-[-1px]">
                    <div class="border-l-4 border-primary pl-3 py-1 overflow-hidden">
                        <span class="font-bold text-[10px] text-primary uppercase tracking-wider block">Replying to</span>
                        <p class="truncate max-w-[200px] text-xs opacity-70" id="reply-text">...</p>
                    </div>
                    <button onclick="cancelReply()" class="btn btn-ghost btn-xs btn-circle"><i class="ph-bold ph-x"></i></button>
                </div>
            </div>

            <!-- Input Area -->
            <footer class="p-2 sm:p-3 bg-base-100 border-t border-base-200 shrink-0 relative z-30">
                
                <!-- Expanded Tools -->
                <div id="media-drawer" class="hidden absolute bottom-full left-0 right-0 bg-base-100 border-t border-base-200 h-64 flex flex-col shadow-2xl rounded-t-2xl overflow-hidden z-50">
                    <div class="p-2 border-b border-base-200 bg-base-200/50">
                         <div class="relative">
                            <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 opacity-50"></i>
                            <input type="text" id="sticker-search" placeholder="Search stickers..." class="input input-sm input-bordered w-full pl-9" oninput="filterStickers()">
                         </div>
                    </div>
                    <div id="sticker-grid" class="flex-1 overflow-y-auto p-3 grid grid-cols-4 sm:grid-cols-5 gap-3 bg-base-100">
                        <!-- Populated via JS -->
                    </div>
                </div>

                <div class="flex items-end gap-2">
                    <!-- Left Buttons -->
                    <div class="join shrink-0">
                        <button onclick="document.getElementById('file-picker').click()" class="btn btn-square btn-ghost join-item text-base-content/70" title="Attach File">
                            <i class="ph-bold ph-paperclip text-xl"></i>
                        </button>
                        <button onclick="toggleMediaDrawer()" class="btn btn-square btn-ghost join-item text-base-content/70" title="Stickers">
                            <i class="ph-bold ph-sticker text-xl"></i>
                        </button>
                    </div>

                    <!-- Text Input Wrapper -->
                    <div class="flex-1 relative min-w-0">
                        <textarea id="msg-input" rows="1" class="textarea textarea-bordered w-full resize-none textarea-chat bg-base-200/50 focus:bg-base-100 transition-colors" placeholder="Message..."></textarea>
                        
                        <!-- Inside Textarea Actions -->
                        <div class="absolute right-2 bottom-1.5 flex gap-1 bg-transparent p-1 rounded-lg">
                             <button onclick="cycleEphemeral()" id="btn-timed" class="btn btn-ghost btn-xs btn-circle text-base-content/40 hover:text-primary transition-colors relative" title="Ephemeral Timer">
                                <i class="ph-bold ph-timer text-lg"></i>
                                <span id="timed-label" class="absolute -top-1 -right-1 badge badge-xs badge-primary hidden scale-75 border-none">OFF</span>
                            </button>
                            <button onclick="toggleEmojiPicker()" class="btn btn-ghost btn-xs btn-circle text-base-content/40 hover:text-warning transition-colors">
                                <i class="ph-fill ph-smiley text-lg"></i>
                            </button>
                        </div>

                        <!-- Emoji Popover -->
                        <div id="emoji-popover" class="hidden absolute bottom-14 right-0 w-72 sm:w-80 shadow-2xl border border-base-300 rounded-xl z-50 overflow-hidden">
                            <emoji-picker></emoji-picker>
                        </div>
                    </div>

                    <!-- Right Buttons -->
                    <div class="flex items-end gap-2 shrink-0">
                        <button id="btn-record" class="btn btn-circle btn-ghost text-base-content/70" title="Hold to Record">
                            <i class="ph-bold ph-microphone text-xl"></i>
                        </button>

                        <button onclick="sendMessage()" class="btn btn-circle btn-primary shadow-md">
                            <i class="ph-bold ph-paper-plane-right text-xl"></i>
                        </button>
                    </div>
                </div>
            </footer>
        </div>

        <!-- SETTINGS MODAL -->
        <dialog id="settings-modal" class="modal">
            <div class="modal-box border border-base-200 shadow-2xl">
                <h3 class="font-bold text-lg mb-4 flex justify-between items-center">
                    Settings
                    <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost">‚úï</button></form>
                </h3>
                
                <div class="flex flex-col gap-4">
                    <div class="form-control">
                        <label class="label cursor-pointer border border-base-200 rounded-lg p-3 hover:bg-base-200/50 transition-colors">
                            <span class="label-text flex items-center gap-3 font-medium">
                                <div class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center"><i class="ph-bold ph-bell"></i></div>
                                Notifications
                            </span>
                            <input type="checkbox" class="toggle toggle-primary" id="toggle-notif" onchange="toggleNotifs()" />
                        </label>
                    </div>

                    <div class="form-control">
                        <label class="label cursor-pointer border border-base-200 rounded-lg p-3 hover:bg-base-200/50 transition-colors">
                            <span class="label-text flex items-center gap-3 font-medium">
                                <div class="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center"><i class="ph-bold ph-speaker-high"></i></div>
                                Sound Effects
                            </span>
                            <input type="checkbox" class="toggle toggle-warning" id="toggle-sound" onchange="toggleSound()" checked />
                        </label>
                    </div>

                    <button onclick="clearChat()" class="btn btn-outline btn-error w-full mt-2">
                        <i class="ph-bold ph-trash"></i> Clear Chat History
                    </button>
                </div>
                <div class="mt-6 text-center text-xs opacity-50 font-mono select-all cursor-text">
                    ID: <span id="session-id-display">...</span>
                </div>
            </div>
            <form method="dialog" class="modal-backdrop"><button>close</button></form>
        </dialog>

        <!-- CALL OVERLAY (Fullscreen) -->
        <div id="call-overlay" class="hidden fixed inset-0 z-50 bg-neutral text-neutral-content flex flex-col">
            <div class="flex-1 relative group bg-black flex flex-col justify-center">
                <video id="remote-video" autoplay playsinline class="w-full h-full object-contain max-h-screen"></video>
                
                <!-- Local Video (Draggable) -->
                <div class="absolute top-4 right-4 w-28 md:w-48 aspect-[3/4] bg-base-300 rounded-xl overflow-hidden shadow-2xl border border-white/20 draggable cursor-grab active:cursor-grabbing hover:scale-105 transition-transform z-10">
                    <video id="local-video" autoplay playsinline muted class="w-full h-full object-cover transform scale-x-[-1]"></video>
                </div>

                <!-- Status Badge -->
                <div class="absolute top-8 left-1/2 -translate-x-1/2 text-center pointer-events-none z-10">
                    <div class="badge badge-neutral gap-2 py-3 px-4 shadow-lg border-white/10 backdrop-blur-md">
                        <div class="w-2 h-2 rounded-full bg-success animate-pulse"></div>
                        <span id="call-status-text" class="font-bold text-xs uppercase tracking-wide">Connected</span>
                        <div class="divider divider-horizontal m-0 h-3"></div>
                        <span id="call-timer" class="font-mono text-xs">00:00</span>
                    </div>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="bg-neutral/90 p-6 pb-8 safe-pb flex justify-center gap-4 sm:gap-6 backdrop-blur-md border-t border-white/5">
                <button onclick="toggleMute()" id="btn-mute" class="btn btn-circle btn-lg btn-outline border-white/20 text-white hover:bg-white/10 hover:border-white">
                    <i class="ph-fill ph-microphone text-2xl"></i>
                </button>
                <button onclick="endCall()" class="btn btn-circle btn-lg btn-error shadow-lg scale-110">
                    <i class="ph-fill ph-phone-slash text-2xl"></i>
                </button>
                <button onclick="toggleCamera()" id="btn-cam" class="btn btn-circle btn-lg btn-outline border-white/20 text-white hover:bg-white/10 hover:border-white">
                    <i class="ph-fill ph-video-camera text-2xl"></i>
                </button>
                <button onclick="toggleScreenShare()" id="btn-screen" class="btn btn-circle btn-lg btn-outline border-white/20 text-white hover:bg-white/10 hover:border-white hidden sm:flex">
                    <i class="ph-fill ph-monitor-play text-2xl"></i>
                </button>
            </div>
        </div>

        <!-- INCOMING CALL MODAL -->
        <dialog id="incoming-call-modal" class="modal">
            <div class="modal-box text-center shadow-2xl">
                <div class="avatar mb-4 animate-bounce">
                    <div class="w-24 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2 mx-auto">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" id="incoming-avatar" />
                    </div>
                </div>
                <h3 class="font-bold text-2xl">Incoming Call</h3>
                <p class="py-4 opacity-70">Peer is requesting a connection...</p>
                <div class="flex justify-center gap-8 mt-4">
                    <button onclick="rejectCall()" class="btn btn-circle btn-lg btn-error shadow-lg">
                        <i class="ph-bold ph-phone-slash text-2xl"></i>
                    </button>
                    <button onclick="answerCall()" class="btn btn-circle btn-lg btn-success shadow-lg">
                        <i class="ph-bold ph-phone text-2xl"></i>
                    </button>
                </div>
            </div>
        </dialog>

        <!-- CONTEXT MENU -->
        <div id="context-menu" class="hidden bg-base-100 border border-base-200 rounded-xl shadow-2xl overflow-hidden min-w-[180px] p-1 z-50">
            <div class="flex justify-between px-3 py-2 bg-base-200/50 rounded-lg mb-1">
                <span class="cursor-pointer hover:scale-125 transition-transform text-lg" onclick="sendReaction('üëç')">üëç</span>
                <span class="cursor-pointer hover:scale-125 transition-transform text-lg" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                <span class="cursor-pointer hover:scale-125 transition-transform text-lg" onclick="sendReaction('üòÇ')">üòÇ</span>
                <span class="cursor-pointer hover:scale-125 transition-transform text-lg" onclick="sendReaction('üî•')">üî•</span>
            </div>
            <ul class="menu menu-sm p-0 rounded-box">
                <li><a onclick="handleCtxAction('reply')"><i class="ph-bold ph-arrow-u-up-left"></i> Reply</a></li>
                <li><a onclick="handleCtxAction('copy')"><i class="ph-bold ph-copy"></i> Copy Text</a></li>
                <li id="ctx-edit" class="hidden"><a onclick="handleCtxAction('edit')"><i class="ph-bold ph-pencil-simple"></i> Edit</a></li>
                <li id="ctx-delete" class="hidden"><a onclick="handleCtxAction('delete')" class="text-error"><i class="ph-bold ph-trash"></i> Delete</a></li>
            </ul>
        </div>
    </div>

    <input type="file" id="file-picker" class="hidden">

    <script>
        // --- CONFIG & STATE ---
        const initialStickers = [
            { url: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExM3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3Zt/l0HlHJGHe3yAMhdQY/giphy.gif', tags: 'cat dance' },
            { url: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExM3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3Zt/JIX9t2j0ZTN9S/giphy.gif', tags: 'cat meme' },
            { url: 'https://media.giphy.com/media/3o7TKSjRrfIPjeiVyM/giphy.gif', tags: 'laugh' },
            { url: 'https://media.giphy.com/media/26tPplGWjN0xLybiU/giphy.gif', tags: 'yes' },
            { url: 'https://media.giphy.com/media/xT5LMHxhOfscxPfIfm/giphy.gif', tags: 'no' },
            { url: 'https://media.giphy.com/media/3o6UB3VhArvomJHtdK/giphy.gif', tags: 'wave' },
            { url: 'https://media.giphy.com/media/OPU6wzx8JrHna/giphy.gif', tags: 'sad' },
            { url: 'https://media.giphy.com/media/l3q2K5jinAlChoCLS/giphy.gif', tags: 'what' }
        ];

        let peer = null;
        let conn = null;
        let myId = '';
        let myName = '';
        let remoteName = 'Peer';
        let currentCall = null;
        let localStream = null;
        let screenStream = null;
        let typingTimeout = null;
        let replyContext = null; 
        let settings = { sound: true, notifs: false };
        let ctxTarget = null; 
        let isEditing = null; 
        
        const ephemeralTimes = [0, 5000, 15000, 30000, 60000];
        let ephemeralIndex = 0;
        
        let mediaRecorder = null;
        let audioChunks = [];

        const CHUNK_SIZE = 16 * 1024;
        let incomingFileBuffer = {};

        const sounds = {
            pop: new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.m4a'),
            msg: new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.m4a'),
            ring: new Audio('https://assets.mixkit.co/active_storage/sfx/2060/2060-preview.m4a')
        };
        sounds.pop.volume = 0.4;
        sounds.msg.volume = 0.3;
        sounds.ring.loop = true;

        // --- INIT ---

        document.addEventListener('DOMContentLoaded', () => {
            renderStickerGrid(initialStickers);
            const storedName = localStorage.getItem('tactile_name');
            const storedRoom = localStorage.getItem('tactile_room');
            if(storedName) document.getElementById('username-input').value = storedName;
            if(storedRoom) document.getElementById('room-input').value = storedRoom;

            if(window.autoAnimate) window.autoAnimate(document.getElementById('messages-container'));

            document.getElementById('msg-input').addEventListener('keydown', (e) => {
                if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
                sendTyping();
            });

            document.addEventListener('click', (e) => {
                const menu = document.getElementById('context-menu');
                if(!menu.classList.contains('hidden') && !menu.contains(e.target)) menu.classList.add('hidden');
                
                const popover = document.getElementById('emoji-popover');
                const trigger = document.querySelector('button[onclick="toggleEmojiPicker()"]');
                if (!popover.classList.contains('hidden') && !popover.contains(e.target) && !trigger.contains(e.target)) {
                    popover.classList.add('hidden');
                }
            });

            document.querySelector('emoji-picker').addEventListener('emoji-click', event => {
                const input = document.getElementById('msg-input');
                input.value += event.detail.unicode;
                input.focus();
            });
            
            setupVoiceRecording();
            if(Notification.permission === 'granted') { 
                settings.notifs = true; 
                document.getElementById('toggle-notif').checked = true;
            }
        });

        function showToast(msg, type = 'info') {
            const bg = type === 'error' ? '#f87171' : '#374151';
            Toastify({
                text: msg, duration: 3000, gravity: "top", position: "center",
                style: { background: bg, borderRadius: '8px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)' },
                offset: { y: 20 }
            }).showToast();
        }

        // --- UI & FEATURES ---

        function toggleEmojiPicker() {
            const popover = document.getElementById('emoji-popover');
            popover.classList.toggle('hidden');
        }

        function cycleEphemeral() {
            ephemeralIndex = (ephemeralIndex + 1) % ephemeralTimes.length;
            const time = ephemeralTimes[ephemeralIndex];
            const btn = document.getElementById('btn-timed');
            const label = document.getElementById('timed-label');
            
            if (time === 0) {
                btn.classList.remove('text-primary');
                label.classList.add('hidden');
                showToast("Ephemeral Mode OFF");
            } else {
                btn.classList.add('text-primary');
                label.classList.remove('hidden');
                const text = time >= 60000 ? (time/60000 + 'm') : (time/1000 + 's');
                label.innerText = text;
                showToast(`Messages vanish in ${text}`);
            }
        }

        function clearChat() {
            document.getElementById('messages-container').innerHTML = '';
            document.getElementById('settings-modal').close();
            showToast("Chat cleared.");
        }

        // --- FILE CHUNKING ---

        document.getElementById('file-picker').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            if(!conn || !conn.open) return showToast("Not connected!", "error");

            showToast("Processing...");
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                const arrayBuffer = e.target.result;
                const totalChunks = Math.ceil(arrayBuffer.byteLength / CHUNK_SIZE);
                const fileId = crypto.randomUUID();
                const mime = file.type;
                const name = file.name;

                conn.send({ type: 'file-start', id: fileId, name: name, mime: mime, totalChunks: totalChunks });
                document.getElementById('upload-bar').classList.remove('hidden');
                const progBar = document.getElementById('upload-progress');

                for (let i = 0; i < totalChunks; i++) {
                    const start = i * CHUNK_SIZE;
                    const end = Math.min(start + CHUNK_SIZE, arrayBuffer.byteLength);
                    const chunk = arrayBuffer.slice(start, end);
                    const chunkBase64 = await arrayBufferToBase64(chunk);

                    conn.send({ type: 'file-chunk', id: fileId, index: i, data: chunkBase64 });
                    
                    const percent = Math.round(((i + 1) / totalChunks) * 100);
                    progBar.style.width = percent + '%';
                    if(i % 20 === 0) await new Promise(r => setTimeout(r, 1));
                }

                document.getElementById('upload-bar').classList.add('hidden');
                progBar.style.width = '0%';
                
                const blob = new Blob([arrayBuffer], { type: mime });
                const localUrl = URL.createObjectURL(blob);
                renderFile(fileId, name, localUrl, mime, 'me');
                showToast("Sent!");
            };
            reader.readAsArrayBuffer(file);
        });

        function arrayBufferToBase64(buffer) {
            return new Promise((resolve) => {
                const blob = new Blob([buffer]);
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(blob);
            });
        }

        // --- PEERJS & CALLING ---

        function startSession(role) {
            const userIn = document.getElementById('username-input').value.trim();
            const roomIn = document.getElementById('room-input').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '-');
            if(!userIn || !roomIn) return showToast("Enter Name and Room.", "error");
            
            localStorage.setItem('tactile_name', userIn);
            localStorage.setItem('tactile_room', roomIn);
            myName = userIn;
            
            myId = (role === 'create') ? `tactile-${roomIn}-host` : `tactile-${roomIn}-guest`;
            const targetId = (role === 'create') ? `tactile-${roomIn}-guest` : `tactile-${roomIn}-host`;

            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('chat-interface').classList.remove('hidden');
            document.getElementById('chat-title').innerText = roomIn.toUpperCase();
            document.getElementById('session-id-display').innerText = myId;

            initPeer(myId, targetId, role);
        }

        function initPeer(id, targetId, role) {
            peer = new Peer(id);
            peer.on('open', () => {
                if (role === 'join') { showToast("Connecting..."); connectToPeer(targetId); }
                else { showToast("Waiting for guest...", "success"); document.getElementById('chat-status').innerText = "Waiting..."; }
            });
            peer.on('connection', c => { if(conn) c.close(); else setupConnection(c); });
            
            peer.on('call', call => {
                document.getElementById('incoming-call-modal').showModal();
                playSound('ring');
                
                window.answerCall = () => {
                    stopSound('ring');
                    document.getElementById('incoming-call-modal').close();
                    
                    // Robust Device Check
                    navigator.mediaDevices.enumerateDevices().then(devices => {
                        const hasVideo = devices.some(d => d.kind === 'videoinput');
                        const constraints = hasVideo ? {video: true, audio: true} : {audio: true};
                        
                        navigator.mediaDevices.getUserMedia(constraints)
                        .then(stream => handleCallStart(call, stream))
                        .catch(err => {
                            console.warn("Media failed", err);
                            conn.send({ type: 'call-rejected' });
                            showToast("Could not access media devices.", "error");
                        });
                    });
                };
                
                window.rejectCall = () => {
                    stopSound('ring');
                    document.getElementById('incoming-call-modal').close();
                    call.close();
                    conn.send({ type: 'call-rejected' });
                };
            });

            peer.on('error', err => {
                if(err.type === 'unavailable-id') { showToast("Room occupied!", "error"); setTimeout(()=>location.reload(), 2000); }
                else if(err.type === 'network') showToast("Network error", "error");
            });
        }

        function connectToPeer(targetId) {
            setupConnection(peer.connect(targetId));
        }

        function setupConnection(connection) {
            conn = connection;
            conn.on('open', () => {
                document.getElementById('chat-status').innerText = "Online";
                document.getElementById('chat-status').className = "text-xs font-bold text-success";
                document.getElementById('status-dot').className = "absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white bg-success";
                conn.send({ type: 'info', name: myName });
                playSound('pop');
            });
            conn.on('data', handleData);
            conn.on('close', () => {
                document.getElementById('chat-status').innerText = "Offline";
                document.getElementById('status-dot').className = "absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white bg-error";
                showToast("Disconnected", "error");
                conn = null;
            });
        }

        function handleData(data) {
            const ind = document.getElementById('activity-indicator');
            switch(data.type) {
                case 'info':
                    remoteName = data.name;
                    document.getElementById('chat-title').innerText = remoteName;
                    break;
                case 'text':
                case 'timed-text':
                    renderMessage(data.id, data.content, 'other', data.replyTo, data.type==='timed-text', data.duration);
                    ind.classList.add('hidden');
                    playSound('msg');
                    break;
                case 'file-start':
                    incomingFileBuffer[data.id] = { name: data.name, mime: data.mime, chunks: [], count: 0, total: data.totalChunks };
                    break;
                case 'file-chunk':
                    const f = incomingFileBuffer[data.id];
                    if(f) {
                        f.chunks[data.index] = data.data;
                        f.count++;
                        if(f.count === f.total) {
                            renderFile(data.id, f.name, `data:${f.mime};base64,${f.chunks.join('')}`, f.mime, 'other');
                            playSound('msg');
                            delete incomingFileBuffer[data.id];
                        }
                    }
                    break;
                case 'audio':
                case 'timed-audio':
                    renderAudio(data.id, data.data, 'other', data.type==='timed-audio');
                    ind.classList.add('hidden');
                    playSound('msg');
                    break;
                case 'typing':
                    ind.classList.remove('hidden');
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => ind.classList.add('hidden'), 3000);
                    break;
                case 'call-rejected':
                    stopSound('ring');
                    document.getElementById('call-overlay').classList.add('hidden');
                    if(localStream) localStream.getTracks().forEach(t => t.stop());
                    showToast("Call ended.");
                    break;
                case 'sticker':
                    renderSticker(data.url, 'other');
                    ind.classList.add('hidden');
                    playSound('msg');
                    break;
            }
        }

        // --- CALLING LOGIC (UPDATED) ---
        
        function startCall(isVideo) {
            if(!conn || !conn.open) return showToast("Connect first!", "error");
            
            // Explicit Permission Request Check with Fallback
            // Request audio first as baseline, then video if requested
            
            const constraints = isVideo ? {video: true, audio: true} : {audio: true};

            navigator.mediaDevices.getUserMedia(constraints)
            .then(stream => {
                const call = peer.call(conn.peer, stream);
                handleCallStart(call, stream);
            })
            .catch(e => {
                if(isVideo && (e.name === 'NotFoundError' || e.name === 'DevicesNotFoundError')) {
                    // Try fallback to audio only
                    showToast("Camera not found. Switching to audio call...");
                    navigator.mediaDevices.getUserMedia({audio: true})
                    .then(stream => {
                        const call = peer.call(conn.peer, stream);
                        handleCallStart(call, stream);
                    })
                    .catch(err2 => showToast("Microphone access failed.", "error"));
                } else if (e.name === 'NotAllowedError') {
                    showToast("Permission denied! Please allow access in browser settings.", "error");
                } else {
                    showToast("Call Error: " + e.message, "error");
                }
            });
        }

        function handleCallStart(call, stream) {
            localStream = stream;
            document.getElementById('call-overlay').classList.remove('hidden');
            document.getElementById('local-video').srcObject = stream;
            currentCall = call;
            
            call.on('stream', remoteStream => {
                document.getElementById('remote-video').srcObject = remoteStream;
                startCallTimer();
                document.getElementById('call-status-text').innerText = "Connected";
            });
            call.on('close', () => endCall());
        }

        function endCall() {
            if(currentCall) currentCall.close();
            if(conn && conn.open) conn.send({type: 'call-rejected'});
            document.getElementById('call-overlay').classList.add('hidden');
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            if(screenStream) screenStream.getTracks().forEach(t => t.stop());
            stopCallTimer();
        }

        function toggleScreenShare() {
            if (!currentCall) return;
            
            if (screenStream) {
                // Stop share, revert to camera
                const videoTrack = localStream.getVideoTracks()[0];
                const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
                if (sender) sender.replaceTrack(videoTrack);
                
                screenStream.getTracks().forEach(t => t.stop());
                screenStream = null;
                document.getElementById('btn-screen').classList.remove('btn-active');
            } else {
                navigator.mediaDevices.getDisplayMedia({ video: true }).then(stream => {
                    screenStream = stream;
                    const videoTrack = stream.getVideoTracks()[0];
                    
                    videoTrack.onended = () => {
                         const camTrack = localStream.getVideoTracks()[0];
                         const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
                         if(sender) sender.replaceTrack(camTrack);
                         screenStream = null;
                         document.getElementById('btn-screen').classList.remove('btn-active');
                    };

                    const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
                    if(sender) sender.replaceTrack(videoTrack);
                    
                    document.getElementById('btn-screen').classList.add('btn-active');
                }).catch(err => console.log("Screen share cancelled", err));
            }
        }

        function toggleMute() {
            if(localStream) {
                const t = localStream.getAudioTracks()[0];
                t.enabled = !t.enabled;
                document.getElementById('btn-mute').classList.toggle('btn-error', !t.enabled);
                document.getElementById('btn-mute').classList.toggle('btn-outline', t.enabled);
            }
        }

        function toggleCamera() {
             if(localStream) {
                const t = localStream.getVideoTracks()[0];
                if(t) {
                    t.enabled = !t.enabled;
                    document.getElementById('btn-cam').classList.toggle('btn-error', !t.enabled);
                    document.getElementById('btn-cam').classList.toggle('btn-outline', t.enabled);
                }
            }
        }

        // --- MESSAGING ---

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;

            if(conn && conn.open) {
                const id = crypto.randomUUID();
                const time = ephemeralTimes[ephemeralIndex];
                const payload = { type: time > 0 ? 'timed-text' : 'text', id, content: text, replyTo: replyContext, duration: time };
                
                conn.send(payload);
                renderMessage(id, text, 'me', replyContext, time > 0, time);
                playSound('pop');
                input.value = '';
                cancelReply();
            } else showToast("Offline", "error");
        }

        function sendSticker(url) {
            if(conn && conn.open) {
                const id = crypto.randomUUID();
                conn.send({ type: 'sticker', id: id, url: url });
                renderSticker(url, 'me');
            } else {
                showToast("Not connected!", "error");
            }
        }

        function renderFile(id, name, data, mime, sender) {
            const div = document.createElement('div');
            const isMe = sender === 'me';
            div.className = `chat ${isMe ? 'chat-end' : 'chat-start'}`;
            
            let content = '';
            if(mime.startsWith('image/')) {
                content = `<img src="${data}" class="chat-image-content" onclick="window.open(this.src)">`;
            } else {
                content = `
                    <div class="flex items-center gap-3 bg-base-200 p-3 rounded-lg cursor-pointer hover:bg-base-300 transition-colors" onclick="const a = document.createElement('a'); a.href='${data}'; a.download='${name}'; a.click();">
                        <div class="w-10 h-10 rounded bg-primary/10 flex items-center justify-center text-primary"><i class="ph-bold ph-file text-xl"></i></div>
                        <div class="overflow-hidden text-left">
                            <div class="font-bold text-sm truncate w-32">${name}</div>
                            <div class="text-xs opacity-60">Tap to download</div>
                        </div>
                    </div>`;
            }

            div.innerHTML = `
                <div class="chat-bubble ${isMe ? 'chat-bubble-primary' : 'bg-base-100 text-base-content'} !p-2 !bg-transparent shadow-none">
                    ${content}
                </div>
                <div class="chat-footer opacity-50 text-xs mt-1">
                    ${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
                </div>
            `;
            
            document.getElementById('messages-container').appendChild(div);
            scrollToBottom();
        }

        // Helpers
        function sendTyping() { if(conn && conn.open) conn.send({ type: 'typing' }); }
        function cancelReply() { replyContext = null; document.getElementById('reply-preview').classList.add('hidden'); }
        function toggleSettings() { document.getElementById('settings-modal').showModal(); }
        function toggleMediaDrawer() { document.getElementById('media-drawer').classList.toggle('hidden'); }
        function playSound(t) { if(settings.sound) sounds[t].play().catch(()=>{}); }
        function stopSound(t) { sounds[t].pause(); sounds[t].currentTime = 0; }
        
        function renderMessage(id, text, sender, replyTo, isTimed, duration) {
            const div = document.createElement('div');
            const isMe = sender === 'me';
            const link = linkifyHtml(text, { target: '_blank', className: 'underline font-bold' });
            
            let replyHtml = replyTo ? `<div class="text-xs opacity-70 mb-1 border-l-2 pl-2 border-current">Replying...</div>` : '';
            let timerHtml = isTimed ? `<div class="absolute -top-3 -right-2 badge badge-xs badge-secondary">15s</div>` : '';

            div.className = `chat ${isMe ? 'chat-end' : 'chat-start'} ${isTimed ? 'msg-timed' : ''}`;
            div.dataset.id = id;
            div.innerHTML = `
                <div class="chat-bubble ${isMe ? 'chat-bubble-primary' : 'bg-base-100 text-base-content shadow-sm'} relative group">
                    ${timerHtml}
                    ${replyHtml}
                    <div class="break-words">${link}</div>
                </div>
                <div class="chat-footer opacity-50 text-xs mt-1">
                    ${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
                </div>
            `;
            
            // Context Menu Bindings
            div.querySelector('.chat-bubble').oncontextmenu = (e) => showContextMenu(e, div, isMe);
            // Mobile Long Press
            let t;
            div.querySelector('.chat-bubble').addEventListener('touchstart', (e) => { t = setTimeout(() => showContextMenu(e.touches[0], div, isMe), 500); });
            div.querySelector('.chat-bubble').addEventListener('touchend', () => clearTimeout(t));

            document.getElementById('messages-container').appendChild(div);
            scrollToBottom();
            if(isTimed) setTimeout(() => { div.style.opacity='0'; setTimeout(()=>div.remove(),500); }, duration||15000);
        }

        function scrollToBottom() {
            const c = document.getElementById('messages-container');
            c.scrollTop = c.scrollHeight;
            setTimeout(() => c.scrollTop = c.scrollHeight, 100);
        }

        function setupVoiceRecording() {
            const btn = document.getElementById('btn-record');
            const start = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({audio: true});
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const reader = new FileReader();
                        reader.readAsDataURL(new Blob(audioChunks));
                        reader.onloadend = () => {
                            const id = crypto.randomUUID();
                            const time = ephemeralTimes[ephemeralIndex];
                            const payload = { type: time > 0 ? 'timed-audio' : 'audio', id, data: reader.result, duration: time };
                            conn.send(payload);
                            renderAudio(id, reader.result, 'me', time > 0);
                        };
                        stream.getTracks().forEach(t=>t.stop());
                    };
                    mediaRecorder.start();
                    btn.classList.add('recording-active');
                } catch(e) { showToast("Mic permission required", "error"); }
            };
            const stop = () => { if(mediaRecorder && mediaRecorder.state === 'recording') { mediaRecorder.stop(); btn.classList.remove('recording-active'); } };
            btn.onmousedown = start; btn.onmouseup = stop; btn.ontouchstart = start; btn.ontouchend = stop;
        }

        function renderAudio(id, data, sender, isTimed) {
            const div = document.createElement('div');
            const isMe = sender === 'me';
            div.className = `chat ${isMe ? 'chat-end' : 'chat-start'} ${isTimed ? 'msg-timed' : ''}`;
            const aid = `aud-${id}`;
            div.innerHTML = `
                <div class="chat-bubble ${isMe ? 'chat-bubble-primary' : 'bg-base-100 text-base-content'} flex items-center gap-3 min-w-[150px]">
                    <button onclick="document.getElementById('${aid}').play()" class="btn btn-circle btn-sm btn-ghost bg-black/10 hover:bg-black/20 border-none text-current">
                        <i class="ph-fill ph-play"></i>
                    </button>
                    <div class="flex flex-col">
                        <span class="text-xs font-bold opacity-70 uppercase">Voice Note</span>
                        <div class="w-24 h-1 bg-current opacity-20 rounded-full mt-1"></div>
                    </div>
                </div>
                <audio id="${aid}" src="${data}"></audio>
            `;
            document.getElementById('messages-container').appendChild(div);
            scrollToBottom();
            if(isTimed) setTimeout(() => { div.style.opacity='0'; setTimeout(()=>div.remove(),500); }, 15000);
        }

        function renderSticker(url, sender) {
            const div = document.createElement('div');
            const isMe = sender === 'me';
            div.className = `chat ${isMe ? 'chat-end' : 'chat-start'}`;
            div.innerHTML = `
                <div class="chat-bubble bg-transparent p-0 shadow-none">
                    <img src="${url}" class="chat-image-content border-2 border-base-300 bg-base-100" onload="scrollToBottom()">
                </div>
            `;
            
            div.querySelector('img').oncontextmenu = (e) => showContextMenu(e, div, isMe);
            document.getElementById('messages-container').appendChild(div);
            scrollToBottom();
        }

        function renderStickerGrid(list) {
            const grid = document.getElementById('sticker-grid');
            if(!grid) return;
            grid.innerHTML = '';
            list.forEach(item => {
                const img = document.createElement('img');
                img.src = item.url;
                img.className = 'w-full h-20 object-contain bg-base-100 rounded-lg border border-base-200 cursor-pointer hover:border-primary transition-colors';
                img.onclick = () => {
                    sendSticker(item.url);
                    toggleMediaDrawer();
                };
                grid.appendChild(img);
            });
        }

        function filterStickers() {
            const query = document.getElementById('sticker-search').value.toLowerCase();
            const filtered = initialStickers.filter(s => s.tags.includes(query));
            renderStickerGrid(filtered);
        }

        // --- CONTEXT MENU ---
        function showContextMenu(e, element, isMe) {
            e.preventDefault();
            e.stopPropagation();
            
            ctxTarget = element;
            const menu = document.getElementById('context-menu');
            document.getElementById('ctx-edit').classList.toggle('hidden', !isMe || element.dataset.type === 'media');
            document.getElementById('ctx-delete').classList.toggle('hidden', !isMe);

            const x = e.clientX;
            const y = e.clientY;
            const menuW = 180;
            const menuH = 200;
            
            const left = (x + menuW > window.innerWidth) ? window.innerWidth - menuW - 10 : x;
            const top = (y + menuH > window.innerHeight) ? y - menuH : y;
            
            menu.style.left = left + 'px';
            menu.style.top = top + 'px';
            menu.classList.remove('hidden');
        }

        function handleCtxAction(action) {
            document.getElementById('context-menu').classList.add('hidden');
            if(!ctxTarget) return;

            const id = ctxTarget.dataset.id;
            // Try to find text within chat bubble
            const textEl = ctxTarget.querySelector('.break-words') || ctxTarget.querySelector('.chat-bubble');
            const text = textEl ? textEl.innerText : "";

            if(action === 'copy') { navigator.clipboard.writeText(text); showToast("Copied"); }
            else if(action === 'reply') setReply(id, text);
            else if(action === 'delete') {
                ctxTarget.remove();
                if(conn && conn.open) conn.send({type: 'delete', id: id});
            } else if(action === 'edit') {
                isEditing = id;
                const input = document.getElementById('msg-input');
                input.value = text;
                input.focus();
            }
        }

        function setReply(id, text) {
            replyContext = { id, text: text.substring(0, 50) + (text.length>50?'...':'') };
            document.getElementById('reply-preview').classList.remove('hidden');
            document.getElementById('reply-text').innerText = replyContext.text;
            document.getElementById('msg-input').focus();
        }

        function sendReaction(emoji) {
            // Implementation left simple for brevity
            showToast("Reaction sent: " + emoji);
            document.getElementById('context-menu').classList.add('hidden');
        }

        function toggleNotifs() {
            settings.notifs = document.getElementById('toggle-notif').checked;
        }
        
        function toggleSound() {
            settings.sound = document.getElementById('toggle-sound').checked;
        }

        let callInterval;
        function startCallTimer() {
            let sec = 0;
            const el = document.getElementById('call-timer');
            clearInterval(callInterval);
            callInterval = setInterval(() => {
                sec++;
                el.innerText = `${Math.floor(sec/60).toString().padStart(2,'0')}:${(sec%60).toString().padStart(2,'0')}`;
            }, 1000);
        }
        function stopCallTimer() { clearInterval(callInterval); document.getElementById('call-timer').innerText = "00:00"; }
        function disconnect() { if(conn) conn.close(); if(peer) peer.destroy(); location.reload(); }

    </script>
</body>
</html>
