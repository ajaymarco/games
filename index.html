<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tactile.io - Pro P2P Chat</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Emoji Picker -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.18.3/index.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Linkify -->
    <script src="https://cdn.jsdelivr.net/npm/linkifyjs@4.1.3/dist/linkify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/linkify-html@4.1.3/dist/linkify-html.min.js"></script>

    <!-- Toastify JS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- AutoAnimate -->
    <script type="module">
        import autoAnimate from 'https://cdn.jsdelivr.net/npm/@formkit/auto-animate@1.0.0/index.min.js';
        window.autoAnimate = autoAnimate;
    </script>

    <style>
        :root {
            /* Modern Chat Palette */
            --bg-chat: #efeae2; /* Telegram/WhatsApp-ish warm grey */
            --bg-bubble-me: #dcf8c6; /* Classic reliable green/blue tint */
            --bg-bubble-other: #ffffff;
            
            --accent-primary: #0088cc;
            --accent-ephemeral: #8b5cf6; 
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: #f0f2f5;
            height: 100dvh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            color: #111b21;
        }

        .font-display { font-family: 'Space Grotesk', sans-serif; }

        /* Background Pattern */
        #messages-container {
            background-color: var(--bg-chat);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239c92ac' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            flex: 1 1 0;
            min-height: 0;
            overflow-y: auto;
            scroll-behavior: smooth;
            padding-bottom: 20px;
        }

        /* Tactile/Glass Elements */
        .tactile-box {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            border-radius: 20px;
        }
        
        /* Buttons */
        .tactile-btn {
            background: #fff;
            border: 1px solid #e5e7eb;
            color: #4b5563;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .tactile-btn:hover { background: #f9fafb; color: #111827; }
        .tactile-btn:active { transform: scale(0.95); background: #f3f4f6; }

        .tactile-btn.active-mode {
            background-color: #ede9fe;
            color: #7c3aed;
            border-color: #7c3aed;
        }

        /* Inputs */
        .tactile-input {
            border: 1px solid #e5e7eb;
            background: #fff;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }
        .tactile-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.1);
            outline: none;
        }

        /* Chat Bubbles - Improved Aesthetics */
        .msg-bubble {
            max-width: 75%;
            padding: 8px 12px;
            border-radius: 12px;
            position: relative;
            word-wrap: break-word;
            margin-bottom: 8px;
            font-size: 0.95rem;
            line-height: 1.4;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: opacity 0.5s ease-out;
        }

        @media (min-width: 640px) {
            .msg-bubble { max-width: 60%; }
        }

        .msg-me {
            background: #e0f2fe; /* Soft blue */
            color: #1e3a8a;
            border-top-right-radius: 0;
            margin-left: auto;
        }
        
        .msg-me a { color: #2563eb !important; text-decoration: underline; }

        .msg-other {
            background: #ffffff;
            color: #1f2937;
            border-top-left-radius: 0;
            margin-right: auto;
        }

        /* File Attachments - Card Style */
        .file-card {
            background: rgba(0,0,0,0.03);
            border-radius: 8px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 4px;
            border: 1px solid rgba(0,0,0,0.05);
            transition: background 0.2s;
        }
        .msg-me .file-card { background: rgba(255,255,255,0.4); border-color: rgba(255,255,255,0.5); }
        .msg-me .file-card:hover { background: rgba(255,255,255,0.6); }

        /* Image Constraints */
        .chat-image {
            max-height: 200px;
            max-width: 100%;
            height: auto;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 4px;
            display: block;
            cursor: pointer;
        }

        /* Ephemeral Message */
        .msg-timed {
            border-left: 3px solid var(--accent-ephemeral);
        }
        
        /* Reactions */
        .reactions-container {
            position: absolute;
            bottom: -8px;
            display: flex;
            gap: 2px;
            z-index: 5;
        }
        .msg-me .reactions-container { right: 4px; }
        .msg-other .reactions-container { left: 4px; }

        .reaction-pill {
            background: #fff;
            border: 1px solid #f3f4f6;
            border-radius: 10px;
            padding: 1px 5px;
            font-size: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            animation: popIn 0.2s;
        }

        /* Animations */
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .recording-active {
            background-color: #fee2e2 !important;
            color: #dc2626 !important;
            border-color: #dc2626 !important;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Toastify Override */
        .toastify {
            background: #1f2937;
            color: #fff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            padding: 10px 16px;
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Emoji Picker */
        emoji-picker {
            width: 100%;
            height: 300px;
            --background: #fff;
            --border-color: #e5e7eb;
        }
        
        #context-menu {
            position: fixed;
            z-index: 1000;
        }
        
        #upload-progress { transition: width 0.1s linear; }
    </style>
</head>
<body class="text-gray-900">

    <div id="app" class="relative w-full h-full max-w-5xl mx-auto flex flex-col sm:p-4 lg:p-6">
        
        <!-- 1. LANDING PAGE -->
        <div id="landing-page" class="flex-1 w-full h-full flex flex-col items-center justify-center p-4 z-20">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-4xl">
                
                <div class="tactile-box p-12 md:col-span-2 flex flex-col items-center text-center bg-white shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-purple-500"></div>
                    <h1 class="text-6xl font-bold mb-2 tracking-tight font-display text-gray-900">TACTILE</h1>
                    <p class="text-lg text-gray-500 font-medium">Secure P2P Messaging</p>
                </div>

                <div class="tactile-box p-8 bg-white flex flex-col justify-center gap-6">
                    <div>
                        <label class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-2 block">Your Name</label>
                        <input type="text" id="username-input" placeholder="Display Name" class="tactile-input w-full p-4 rounded-xl text-lg bg-gray-50" maxlength="20">
                    </div>
                    
                    <div>
                        <label class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-2 block">Room Code</label>
                        <div class="relative">
                            <i class="ph-bold ph-hash absolute left-4 top-1/2 -translate-y-1/2 text-xl text-gray-400"></i>
                            <input type="text" id="room-input" placeholder="secret-room" class="tactile-input w-full p-4 pl-12 rounded-xl text-lg font-mono uppercase tracking-widest text-gray-700 bg-gray-50">
                        </div>
                    </div>
                </div>

                <div class="tactile-box p-8 bg-white flex flex-col justify-center gap-4">
                    <div class="grid grid-cols-2 gap-4 h-full">
                        <button onclick="startSession('create')" class="tactile-btn rounded-xl flex flex-col items-center justify-center p-4 hover:bg-emerald-50 hover:border-emerald-200 hover:text-emerald-700 group transition-all shadow-sm">
                            <i class="ph-fill ph-broadcast text-3xl mb-3 text-emerald-500 group-hover:scale-110 transition-transform"></i>
                            <span class="font-bold">Host</span>
                        </button>
                        <button onclick="startSession('join')" class="tactile-btn rounded-xl flex flex-col items-center justify-center p-4 hover:bg-blue-50 hover:border-blue-200 hover:text-blue-700 group transition-all shadow-sm">
                            <i class="ph-fill ph-plugs-connected text-3xl mb-3 text-blue-500 group-hover:scale-110 transition-transform"></i>
                            <span class="font-bold">Join</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. CHAT INTERFACE -->
        <div id="chat-interface" class="hidden absolute inset-0 sm:static sm:h-full sm:rounded-2xl tactile-box overflow-hidden flex flex-col bg-white shadow-2xl ring-1 ring-black/5">
            
            <!-- Header -->
            <header class="h-16 border-b border-gray-100 bg-white flex items-center justify-between px-4 z-30 shrink-0">
                <div class="flex items-center gap-3">
                    <div class="relative cursor-pointer hover:opacity-80 transition active:scale-95" onclick="toggleSettings()">
                        <div class="w-10 h-10 rounded-full bg-gray-100 overflow-hidden ring-1 ring-gray-200">
                             <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Init" id="remote-avatar" class="w-full h-full object-cover">
                        </div>
                        <div id="status-dot" class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white bg-gray-300"></div>
                    </div>
                    <div>
                        <h2 id="chat-title" class="font-bold text-base leading-tight truncate max-w-[140px] text-gray-900">Waiting...</h2>
                        <div class="flex items-center gap-1.5">
                            <span id="chat-status" class="text-xs font-medium text-gray-500">Disconnected</span>
                        </div>
                    </div>
                </div>

                <div class="flex gap-1 items-center">
                    <button onclick="startCall(false)" class="w-9 h-9 rounded-lg flex items-center justify-center hover:bg-blue-50 text-gray-600 hover:text-blue-600 transition-colors" title="Voice Call">
                        <i class="ph-bold ph-phone text-lg"></i>
                    </button>
                    <button onclick="startCall(true)" class="w-9 h-9 rounded-lg flex items-center justify-center hover:bg-emerald-50 text-gray-600 hover:text-emerald-600 transition-colors" title="Video Call">
                        <i class="ph-bold ph-video text-lg"></i>
                    </button>
                    <div class="w-px h-5 bg-gray-200 mx-1"></div>
                    <button onclick="toggleSettings()" class="w-9 h-9 rounded-lg flex items-center justify-center hover:bg-gray-100 text-gray-600 transition-colors" title="Settings">
                        <i class="ph-bold ph-dots-three-vertical text-lg"></i>
                    </button>
                    <button onclick="disconnect()" class="w-9 h-9 rounded-lg flex items-center justify-center hover:bg-red-50 text-red-500 transition-colors" title="Disconnect">
                        <i class="ph-bold ph-power text-lg"></i>
                    </button>
                </div>
            </header>

            <!-- Upload Bar -->
            <div id="upload-bar" class="hidden h-1 bg-gray-100 w-full relative">
                <div id="upload-progress" class="h-full bg-blue-500 w-0"></div>
            </div>

            <!-- Messages Area -->
            <div id="messages-container">
                <div class="flex flex-col items-center justify-center mt-12 opacity-50 select-none text-center px-6">
                    <div class="w-12 h-12 rounded-xl bg-gray-200 flex items-center justify-center mb-3">
                        <i class="ph-duotone ph-lock-key text-2xl text-gray-500"></i>
                    </div>
                    <p class="text-xs font-bold uppercase tracking-wider text-gray-500">End-to-End Encrypted</p>
                    <p class="text-xs mt-1 text-gray-400">Messages are peer-to-peer.</p>
                </div>
            </div>

            <!-- Indicators -->
            <div id="indicators-area" class="relative z-20">
                <div id="activity-indicator" class="hidden absolute bottom-2 left-4 bg-white/90 backdrop-blur px-3 py-1.5 rounded-full text-xs font-bold shadow-sm border border-gray-100 flex items-center gap-2 text-gray-600 transform -translate-y-full">
                    <div class="flex gap-1">
                        <div class="w-1 h-1 bg-gray-500 rounded-full animate-bounce"></div>
                        <div class="w-1 h-1 bg-gray-500 rounded-full animate-bounce delay-75"></div>
                        <div class="w-1 h-1 bg-gray-500 rounded-full animate-bounce delay-150"></div>
                    </div>
                    <span id="activity-text">Typing...</span>
                </div>

                <div id="reply-preview" class="hidden bg-white border-t border-gray-100 p-2 px-4 flex justify-between items-center text-sm">
                    <div class="border-l-4 border-blue-500 pl-3 py-1">
                        <span class="font-bold text-[10px] text-blue-600 uppercase tracking-wider">Replying to</span>
                        <p class="truncate max-w-[200px] font-medium text-gray-700 text-xs" id="reply-text">...</p>
                    </div>
                    <button onclick="cancelReply()" class="p-1.5 hover:bg-gray-100 rounded-full transition-colors"><i class="ph-bold ph-x text-gray-500"></i></button>
                </div>
            </div>

            <!-- Input Area -->
            <footer class="p-3 bg-white border-t border-gray-100 shrink-0 relative z-30 safe-pb">
                
                <!-- Expanded Tools -->
                <div id="media-drawer" class="hidden absolute bottom-full left-0 right-0 bg-white/95 border-t border-gray-100 h-64 flex flex-col shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] backdrop-blur-xl">
                    <div class="p-3 border-b border-gray-100 bg-gray-50/50">
                         <div class="relative">
                            <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="sticker-search" placeholder="Search stickers..." class="w-full p-2 pl-9 bg-white border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-blue-500 transition-colors" oninput="filterStickers()">
                         </div>
                    </div>
                    <div id="sticker-grid" class="flex-1 overflow-y-auto p-3 grid grid-cols-4 sm:grid-cols-5 gap-3 bg-gray-50/30">
                        <!-- Populated via JS -->
                    </div>
                </div>

                <div class="flex gap-2 items-end">
                    <button onclick="document.getElementById('file-picker').click()" class="tactile-btn w-10 h-10 rounded-full flex items-center justify-center text-gray-500 hover:text-gray-700 shrink-0" title="Attach File">
                        <i class="ph-bold ph-paperclip text-xl"></i>
                    </button>
                    
                    <button onclick="toggleMediaDrawer()" class="tactile-btn w-10 h-10 rounded-full flex items-center justify-center text-gray-500 hover:text-gray-700 shrink-0" title="Stickers">
                        <i class="ph-bold ph-sticker text-xl"></i>
                    </button>

                    <div class="flex-1 relative">
                        <textarea id="msg-input" rows="1" class="w-full tactile-input p-2.5 px-4 pr-10 rounded-2xl resize-none max-h-32 min-h-[42px] text-[15px] leading-relaxed bg-gray-50 border-transparent focus:bg-white" placeholder="Message..."></textarea>
                        
                        <!-- Inside Textarea Actions -->
                        <div class="absolute right-2 bottom-1.5 flex gap-1">
                             <button onclick="cycleEphemeral()" id="btn-timed" class="p-1.5 rounded-full text-gray-400 hover:text-purple-600 transition-colors" title="Ephemeral Timer">
                                <i class="ph-bold ph-timer text-lg"></i>
                                <span id="timed-label" class="absolute -top-1 -right-1 text-[8px] font-bold bg-purple-100 text-purple-600 px-1 rounded-full hidden">OFF</span>
                            </button>
                            <button onclick="toggleEmojiPicker()" class="p-1.5 rounded-full text-gray-400 hover:text-yellow-500 transition-colors">
                                <i class="ph-fill ph-smiley text-lg"></i>
                            </button>
                        </div>

                        <div id="emoji-popover" class="hidden absolute bottom-14 right-0 w-80 shadow-xl border border-gray-200 rounded-xl z-50 overflow-hidden animate-[popIn_0.1s]">
                            <emoji-picker></emoji-picker>
                        </div>
                    </div>

                    <button id="btn-record" class="tactile-btn w-10 h-10 rounded-full flex items-center justify-center text-gray-500 hover:bg-red-50 hover:text-red-500 shrink-0 transition-colors" title="Hold to Record">
                        <i class="ph-bold ph-microphone text-xl"></i>
                    </button>

                    <button onclick="sendMessage()" class="w-10 h-10 rounded-full flex items-center justify-center bg-blue-500 text-white hover:bg-blue-600 active:scale-95 transition-transform shadow-md shrink-0">
                        <i class="ph-bold ph-paper-plane-right text-lg"></i>
                    </button>
                </div>
            </footer>
        </div>

        <!-- SETTINGS MODAL -->
        <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/20 backdrop-blur-sm p-4">
            <div class="tactile-box bg-white p-6 max-w-sm w-full animate-[popIn_0.2s] shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold">Settings</h3>
                    <button onclick="toggleSettings()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100"><i class="ph-bold ph-x text-lg"></i></button>
                </div>
                
                <div class="space-y-2">
                    <div class="flex justify-between items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer" onclick="toggleNotifs()">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600"><i class="ph-duotone ph-bell"></i></div>
                            <span class="font-medium text-sm">Notifications</span>
                        </div>
                        <div id="btn-notif" class="w-9 h-5 bg-gray-200 rounded-full relative transition-colors duration-200 pointer-events-none">
                            <div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-transform duration-200 shadow-sm"></div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer" onclick="toggleSound()">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-600"><i class="ph-duotone ph-speaker-high"></i></div>
                            <span class="font-medium text-sm">Sounds</span>
                        </div>
                        <div id="btn-sound" class="w-9 h-5 bg-gray-800 rounded-full relative transition-colors duration-200 pointer-events-none">
                            <div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 translate-x-4 transition-transform duration-200 shadow-sm"></div>
                        </div>
                    </div>

                    <button onclick="clearChat()" class="w-full p-3 mt-2 text-red-600 hover:bg-red-50 rounded-lg font-medium text-sm transition-colors flex items-center justify-center gap-2">
                        <i class="ph-bold ph-trash"></i> Clear Chat History
                    </button>
                </div>
                <div class="mt-4 text-center text-[10px] text-gray-400 font-mono">
                    ID: <span id="session-id-display">...</span>
                </div>
            </div>
        </div>

        <!-- CALL OVERLAY -->
        <div id="call-overlay" class="hidden fixed inset-0 z-50 bg-gray-900 flex flex-col">
            <div class="flex-1 relative group">
                <video id="remote-video" autoplay playsinline class="w-full h-full object-contain"></video>
                <div class="absolute top-6 right-6 w-32 h-48 bg-black rounded-xl overflow-hidden shadow-2xl border border-white/10 draggable cursor-grab active:cursor-grabbing">
                    <video id="local-video" autoplay playsinline muted class="w-full h-full object-cover transform scale-x-[-1]"></video>
                </div>
                <div class="absolute top-10 left-1/2 -translate-x-1/2 text-center pointer-events-none">
                    <div class="bg-black/40 backdrop-blur-md px-4 py-1.5 rounded-full text-white border border-white/5 shadow-sm flex items-center gap-2">
                        <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                        <span id="call-timer" class="font-mono text-xs">00:00</span>
                    </div>
                </div>
            </div>
            <div class="h-24 bg-gray-900 flex items-center justify-center gap-8 pb-4 safe-area-pb">
                <button onclick="toggleMute()" id="btn-mute" class="w-12 h-12 rounded-full bg-gray-800 text-white flex items-center justify-center hover:bg-gray-700 transition" title="Toggle Mic"><i class="ph-fill ph-microphone text-xl"></i></button>
                <button onclick="endCall()" class="w-16 h-16 rounded-full bg-red-500 text-white flex items-center justify-center shadow-lg hover:bg-red-600 transform hover:scale-105 transition" title="End Call"><i class="ph-fill ph-phone-slash text-2xl"></i></button>
                <button onclick="toggleCamera()" id="btn-cam" class="w-12 h-12 rounded-full bg-gray-800 text-white flex items-center justify-center hover:bg-gray-700 transition" title="Toggle Cam"><i class="ph-fill ph-video-camera text-xl"></i></button>
            </div>
        </div>

        <!-- INCOMING CALL MODAL -->
        <div id="incoming-call-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
            <div class="bg-white p-8 max-w-sm w-full text-center rounded-2xl shadow-2xl animate-[popIn_0.3s]">
                <div class="w-20 h-20 rounded-full overflow-hidden mx-auto mb-4 bg-gray-100">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" id="incoming-avatar" class="w-full h-full object-cover">
                </div>
                <h3 class="text-xl font-bold mb-1 text-gray-900">Incoming Call</h3>
                <p class="text-gray-500 mb-8 text-sm">Peer is calling...</p>
                <div class="flex justify-center gap-8">
                    <button onclick="rejectCall()" class="w-14 h-14 rounded-full bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200 transition-colors"><i class="ph-bold ph-phone-slash text-2xl"></i></button>
                    <button onclick="answerCall()" class="w-14 h-14 rounded-full bg-green-500 text-white flex items-center justify-center animate-bounce shadow-lg hover:bg-green-600"><i class="ph-bold ph-phone text-2xl"></i></button>
                </div>
            </div>
        </div>

        <!-- CONTEXT MENU -->
        <div id="context-menu" class="hidden bg-white/95 backdrop-blur border border-gray-100 rounded-xl shadow-xl overflow-hidden min-w-[160px]">
            <div class="flex justify-between px-4 py-3 bg-gray-50 border-b border-gray-100">
                <span class="cursor-pointer hover:scale-125 transition-transform text-lg" onclick="sendReaction('üëç')">üëç</span>
                <span class="cursor-pointer hover:scale-125 transition-transform text-lg" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                <span class="cursor-pointer hover:scale-125 transition-transform text-lg" onclick="sendReaction('üòÇ')">üòÇ</span>
                <span class="cursor-pointer hover:scale-125 transition-transform text-lg" onclick="sendReaction('üî•')">üî•</span>
            </div>
            <div class="p-1">
                <div class="px-3 py-2 hover:bg-gray-100 rounded-lg cursor-pointer flex items-center gap-3 text-sm text-gray-700" onclick="handleCtxAction('reply')"><i class="ph-bold ph-arrow-u-up-left"></i> Reply</div>
                <div class="px-3 py-2 hover:bg-gray-100 rounded-lg cursor-pointer flex items-center gap-3 text-sm text-gray-700" onclick="handleCtxAction('copy')"><i class="ph-bold ph-copy"></i> Copy</div>
                <div class="px-3 py-2 hover:bg-gray-100 rounded-lg cursor-pointer flex items-center gap-3 text-sm text-gray-700 hidden" id="ctx-edit" onclick="handleCtxAction('edit')"><i class="ph-bold ph-pencil-simple"></i> Edit</div>
                <div class="px-3 py-2 hover:bg-red-50 rounded-lg cursor-pointer flex items-center gap-3 text-sm text-red-600 hidden" id="ctx-delete" onclick="handleCtxAction('delete')"><i class="ph-bold ph-trash"></i> Delete</div>
            </div>
        </div>
    </div>

    <input type="file" id="file-picker" class="hidden">

    <script>
        // --- CONFIG & STATE ---
        const initialStickers = [
            { url: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExM3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3Zt/l0HlHJGHe3yAMhdQY/giphy.gif', tags: 'cat dance' },
            { url: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExM3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3ZtZ3Zt/JIX9t2j0ZTN9S/giphy.gif', tags: 'cat meme' },
            { url: 'https://media.giphy.com/media/3o7TKSjRrfIPjeiVyM/giphy.gif', tags: 'laugh' },
            { url: 'https://media.giphy.com/media/26tPplGWjN0xLybiU/giphy.gif', tags: 'yes' },
            { url: 'https://media.giphy.com/media/xT5LMHxhOfscxPfIfm/giphy.gif', tags: 'no' },
            { url: 'https://media.giphy.com/media/3o6UB3VhArvomJHtdK/giphy.gif', tags: 'wave' },
            { url: 'https://media.giphy.com/media/OPU6wzx8JrHna/giphy.gif', tags: 'sad' },
            { url: 'https://media.giphy.com/media/l3q2K5jinAlChoCLS/giphy.gif', tags: 'what' }
        ];

        let peer = null;
        let conn = null;
        let myId = '';
        let myName = '';
        let remoteName = 'Peer';
        let currentCall = null;
        let localStream = null;
        let typingTimeout = null;
        let replyContext = null; 
        let settings = { sound: true, notifs: false };
        let ctxTarget = null; 
        let isEditing = null; 
        
        const ephemeralTimes = [0, 5000, 15000, 30000, 60000];
        let ephemeralIndex = 0;
        
        let mediaRecorder = null;
        let audioChunks = [];

        const CHUNK_SIZE = 16 * 1024;
        let incomingFileBuffer = {};

        const sounds = {
            pop: new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.m4a'),
            msg: new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.m4a'),
            ring: new Audio('https://assets.mixkit.co/active_storage/sfx/2060/2060-preview.m4a')
        };
        sounds.pop.volume = 0.4;
        sounds.msg.volume = 0.3;
        sounds.ring.loop = true;

        // --- INIT ---

        document.addEventListener('DOMContentLoaded', () => {
            renderStickerGrid(initialStickers);
            const storedName = localStorage.getItem('tactile_name');
            const storedRoom = localStorage.getItem('tactile_room');
            if(storedName) document.getElementById('username-input').value = storedName;
            if(storedRoom) document.getElementById('room-input').value = storedRoom;

            if(window.autoAnimate) window.autoAnimate(document.getElementById('messages-container'));

            document.getElementById('msg-input').addEventListener('keydown', (e) => {
                if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
                sendTyping();
            });

            document.addEventListener('click', (e) => {
                const menu = document.getElementById('context-menu');
                if(!menu.classList.contains('hidden') && !menu.contains(e.target)) menu.classList.add('hidden');
                
                const popover = document.getElementById('emoji-popover');
                const trigger = document.querySelector('button[onclick="toggleEmojiPicker()"]');
                if (!popover.classList.contains('hidden') && !popover.contains(e.target) && !trigger.contains(e.target)) {
                    popover.classList.add('hidden');
                }
            });

            document.querySelector('emoji-picker').addEventListener('emoji-click', event => {
                const input = document.getElementById('msg-input');
                input.value += event.detail.unicode;
                input.focus();
            });
            
            setupVoiceRecording();
            if(Notification.permission === 'granted') { settings.notifs = true; updateSettingsUI(); }
        });

        function showToast(msg, type = 'info') {
            const bg = type === 'error' ? '#fee2e2' : '#333';
            const color = type === 'error' ? '#dc2626' : '#fff';
            Toastify({
                text: msg, duration: 3000, gravity: "top", position: "center",
                style: { background: bg, color: color, boxShadow: '0 4px 10px rgba(0,0,0,0.1)' },
                offset: { y: 20 }
            }).showToast();
        }

        // --- UI & FEATURES ---

        function cycleEphemeral() {
            ephemeralIndex = (ephemeralIndex + 1) % ephemeralTimes.length;
            const time = ephemeralTimes[ephemeralIndex];
            const btn = document.getElementById('btn-timed');
            const label = document.getElementById('timed-label');
            
            if (time === 0) {
                btn.classList.remove('text-purple-600');
                btn.classList.add('text-gray-400');
                label.classList.add('hidden');
                showToast("Ephemeral Mode OFF");
            } else {
                btn.classList.remove('text-gray-400');
                btn.classList.add('text-purple-600');
                label.classList.remove('hidden');
                const text = time >= 60000 ? (time/60000 + 'm') : (time/1000 + 's');
                label.innerText = text;
                showToast(`Messages vanish in ${text}`);
            }
        }

        function clearChat() {
            document.getElementById('messages-container').innerHTML = '';
            toggleSettings();
            showToast("Chat cleared.");
        }

        // --- FILE CHUNKING ---

        document.getElementById('file-picker').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            if(!conn || !conn.open) return showToast("Not connected!", "error");

            showToast("Processing...");
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                const arrayBuffer = e.target.result;
                const totalChunks = Math.ceil(arrayBuffer.byteLength / CHUNK_SIZE);
                const fileId = crypto.randomUUID();
                const mime = file.type;
                const name = file.name;

                conn.send({ type: 'file-start', id: fileId, name: name, mime: mime, totalChunks: totalChunks });
                document.getElementById('upload-bar').classList.remove('hidden');
                const progBar = document.getElementById('upload-progress');

                for (let i = 0; i < totalChunks; i++) {
                    const start = i * CHUNK_SIZE;
                    const end = Math.min(start + CHUNK_SIZE, arrayBuffer.byteLength);
                    const chunk = arrayBuffer.slice(start, end);
                    const chunkBase64 = await arrayBufferToBase64(chunk);

                    conn.send({ type: 'file-chunk', id: fileId, index: i, data: chunkBase64 });
                    
                    const percent = Math.round(((i + 1) / totalChunks) * 100);
                    progBar.style.width = percent + '%';
                    if(i % 20 === 0) await new Promise(r => setTimeout(r, 1));
                }

                document.getElementById('upload-bar').classList.add('hidden');
                progBar.style.width = '0%';
                
                const blob = new Blob([arrayBuffer], { type: mime });
                const localUrl = URL.createObjectURL(blob);
                renderFile(fileId, name, localUrl, mime, 'me');
                showToast("Sent!");
            };
            reader.readAsArrayBuffer(file);
        });

        function arrayBufferToBase64(buffer) {
            return new Promise((resolve) => {
                const blob = new Blob([buffer]);
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(blob);
            });
        }

        // --- PEERJS & CALLING ---

        function startSession(role) {
            const userIn = document.getElementById('username-input').value.trim();
            const roomIn = document.getElementById('room-input').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '-');
            if(!userIn || !roomIn) return showToast("Enter Name and Room.", "error");
            
            localStorage.setItem('tactile_name', userIn);
            localStorage.setItem('tactile_room', roomIn);
            myName = userIn;
            
            myId = (role === 'create') ? `tactile-${roomIn}-host` : `tactile-${roomIn}-guest`;
            const targetId = (role === 'create') ? `tactile-${roomIn}-guest` : `tactile-${roomIn}-host`;

            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('chat-interface').classList.remove('hidden');
            document.getElementById('chat-title').innerText = roomIn.toUpperCase();

            initPeer(myId, targetId, role);
        }

        function initPeer(id, targetId, role) {
            peer = new Peer(id);
            peer.on('open', () => {
                if (role === 'join') { showToast("Connecting..."); connectToPeer(targetId); }
                else { showToast("Waiting for guest...", "success"); document.getElementById('chat-status').innerText = "Waiting..."; }
            });
            peer.on('connection', c => { if(conn) c.close(); else setupConnection(c); });
            
            peer.on('call', call => {
                document.getElementById('incoming-call-modal').classList.remove('hidden');
                playSound('ring');
                
                window.answerCall = () => {
                    stopSound('ring');
                    document.getElementById('incoming-call-modal').classList.add('hidden');
                    
                    navigator.mediaDevices.getUserMedia({video: true, audio: true})
                    .then(stream => handleCallStart(call, stream))
                    .catch(err => {
                        console.warn("Video failed, trying audio only");
                        navigator.mediaDevices.getUserMedia({audio: true})
                        .then(stream => handleCallStart(call, stream))
                        .catch(err2 => {
                            showToast("No Microphone Found!", "error");
                            conn.send({ type: 'call-rejected' });
                        });
                    });
                };
                
                window.rejectCall = () => {
                    stopSound('ring');
                    document.getElementById('incoming-call-modal').classList.add('hidden');
                    call.close();
                    conn.send({ type: 'call-rejected' });
                };
            });

            peer.on('error', err => {
                if(err.type === 'unavailable-id') { showToast("Room occupied!", "error"); setTimeout(()=>location.reload(), 2000); }
                else if(err.type === 'network') showToast("Network error", "error");
            });
        }

        function connectToPeer(targetId) {
            setupConnection(peer.connect(targetId));
        }

        function setupConnection(connection) {
            conn = connection;
            conn.on('open', () => {
                document.getElementById('chat-status').innerText = "Online";
                document.getElementById('chat-status').className = "text-xs font-bold text-green-600";
                document.getElementById('status-dot').className = "absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white bg-green-500";
                conn.send({ type: 'info', name: myName });
                playSound('pop');
            });
            conn.on('data', handleData);
            conn.on('close', () => {
                document.getElementById('chat-status').innerText = "Offline";
                document.getElementById('status-dot').className = "absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white bg-red-500";
                showToast("Disconnected", "error");
                conn = null;
            });
        }

        function handleData(data) {
            const ind = document.getElementById('activity-indicator');
            switch(data.type) {
                case 'info':
                    remoteName = data.name;
                    document.getElementById('chat-title').innerText = remoteName;
                    break;
                case 'text':
                case 'timed-text':
                    renderMessage(data.id, data.content, 'other', data.replyTo, data.type==='timed-text', data.duration);
                    ind.classList.add('hidden');
                    playSound('msg');
                    break;
                case 'file-start':
                    incomingFileBuffer[data.id] = { name: data.name, mime: data.mime, chunks: [], count: 0, total: data.totalChunks };
                    break;
                case 'file-chunk':
                    const f = incomingFileBuffer[data.id];
                    if(f) {
                        f.chunks[data.index] = data.data;
                        f.count++;
                        if(f.count === f.total) {
                            renderFile(data.id, f.name, `data:${f.mime};base64,${f.chunks.join('')}`, f.mime, 'other');
                            playSound('msg');
                            delete incomingFileBuffer[data.id];
                        }
                    }
                    break;
                case 'audio':
                case 'timed-audio':
                    renderAudio(data.id, data.data, 'other', data.type==='timed-audio');
                    ind.classList.add('hidden');
                    playSound('msg');
                    break;
                case 'typing':
                    ind.classList.remove('hidden');
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => ind.classList.add('hidden'), 3000);
                    break;
                case 'call-rejected':
                    stopSound('ring');
                    document.getElementById('call-overlay').classList.add('hidden');
                    if(localStream) localStream.getTracks().forEach(t => t.stop());
                    showToast("Call ended.");
                    break;
                case 'sticker':
                    renderSticker(data.url, 'other');
                    ind.classList.add('hidden');
                    playSound('msg');
                    break;
            }
        }

        // --- CALLING LOGIC (UPDATED) ---
        
        function startCall(isVideo) {
            if(!conn || !conn.open) return showToast("Connect first!", "error");
            
            // Explicit Permission Request Check
            navigator.mediaDevices.getUserMedia(isVideo ? {video: true, audio: true} : {audio: true})
            .then(stream => {
                const call = peer.call(conn.peer, stream);
                handleCallStart(call, stream);
            })
            .catch(e => {
                if (e.name === 'NotFoundError' || e.name === 'DevicesNotFoundError') {
                    showToast("No Camera/Microphone found on this device.", "error");
                } else if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
                    showToast("Permission denied! Please allow access in browser settings.", "error");
                } else if(isVideo) {
                    // Fallback to audio
                    showToast("Video failed. Trying Audio only...");
                    startCall(false);
                } else {
                    showToast("Media Error: " + e.message, "error");
                }
            });
        }

        function handleCallStart(call, stream) {
            localStream = stream;
            document.getElementById('call-overlay').classList.remove('hidden');
            document.getElementById('local-video').srcObject = stream;
            currentCall = call;
            
            call.on('stream', remoteStream => {
                document.getElementById('remote-video').srcObject = remoteStream;
                startCallTimer();
                document.getElementById('call-status-text').innerText = "Connected";
            });
            call.on('close', () => endCall());
        }

        function endCall() {
            if(currentCall) currentCall.close();
            if(conn && conn.open) conn.send({type: 'call-rejected'});
            document.getElementById('call-overlay').classList.add('hidden');
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            stopCallTimer();
        }

        // --- MESSAGING ---

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;

            if(conn && conn.open) {
                const id = crypto.randomUUID();
                const time = ephemeralTimes[ephemeralIndex];
                const payload = { type: time > 0 ? 'timed-text' : 'text', id, content: text, replyTo: replyContext, duration: time };
                
                conn.send(payload);
                renderMessage(id, text, 'me', replyContext, time > 0, time);
                playSound('pop');
                input.value = '';
                cancelReply();
            } else showToast("Offline", "error");
        }

        function sendSticker(url) {
            if(conn && conn.open) {
                const id = crypto.randomUUID();
                conn.send({ type: 'sticker', id: id, url: url });
                renderSticker(url, 'me');
            } else {
                showToast("Not connected!", "error");
            }
        }

        function renderFile(id, name, data, mime, sender) {
            const div = document.createElement('div');
            const isMe = sender === 'me';
            div.className = `msg-bubble ${isMe ? 'msg-me' : 'msg-other'}`;
            
            let content = '';
            if(mime.startsWith('image/')) {
                content = `<img src="${data}" class="chat-image" onclick="window.open(this.src)">`;
            } else {
                content = `
                    <div class="file-card">
                        <div class="w-10 h-10 rounded bg-blue-100 flex items-center justify-center text-blue-600"><i class="ph-bold ph-file"></i></div>
                        <div class="overflow-hidden">
                            <div class="text-sm font-bold truncate w-40">${name}</div>
                            <div class="text-xs opacity-60">Tap to download</div>
                        </div>
                    </div>`;
            }

            div.innerHTML = `${content} <div class="text-[10px] text-right mt-1 opacity-60">${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>`;
            if(!mime.startsWith('image/')) div.onclick = () => { const a = document.createElement('a'); a.href = data; a.download = name; a.click(); };
            
            document.getElementById('messages-container').appendChild(div);
            scrollToBottom();
        }

        // Helpers
        function sendTyping() { if(conn && conn.open) conn.send({ type: 'typing' }); }
        function cancelReply() { replyContext = null; document.getElementById('reply-preview').classList.add('hidden'); }
        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
        function toggleMediaDrawer() { document.getElementById('media-drawer').classList.toggle('hidden'); }
        function playSound(t) { if(settings.sound) sounds[t].play().catch(()=>{}); }
        function stopSound(t) { sounds[t].pause(); sounds[t].currentTime = 0; }
        
        function renderMessage(id, text, sender, replyTo, isTimed, duration) {
            const div = document.createElement('div');
            const isMe = sender === 'me';
            const link = linkifyHtml(text, { target: '_blank', className: 'underline font-bold' });
            
            let replyHtml = replyTo ? `<div class="text-xs opacity-70 mb-1 border-l-2 pl-2 border-current">Replying...</div>` : '';
            let timerHtml = isTimed ? `<div class="absolute -top-2 -right-2 bg-purple-100 text-purple-700 text-[10px] px-1.5 py-0.5 rounded-full border border-purple-200">‚è≥ 15s</div>` : '';

            div.className = `msg-bubble ${isMe ? 'msg-me' : 'msg-other'} ${isTimed ? 'msg-timed' : ''}`;
            div.innerHTML = `${timerHtml}${replyHtml}<div class="break-words">${link}</div><div class="text-[10px] text-right mt-1 opacity-60">${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>`;
            
            document.getElementById('messages-container').appendChild(div);
            scrollToBottom();
            if(isTimed) setTimeout(() => { div.style.opacity='0'; setTimeout(()=>div.remove(),500); }, duration||15000);
        }

        function scrollToBottom() {
            const c = document.getElementById('messages-container');
            c.scrollTop = c.scrollHeight;
            setTimeout(() => c.scrollTop = c.scrollHeight, 100);
        }

        function setupVoiceRecording() {
            const btn = document.getElementById('btn-record');
            const start = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({audio: true});
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const reader = new FileReader();
                        reader.readAsDataURL(new Blob(audioChunks));
                        reader.onloadend = () => {
                            const id = crypto.randomUUID();
                            const time = ephemeralTimes[ephemeralIndex];
                            const payload = { type: time > 0 ? 'timed-audio' : 'audio', id, data: reader.result, duration: time };
                            conn.send(payload);
                            renderAudio(id, reader.result, 'me', time > 0);
                        };
                        stream.getTracks().forEach(t=>t.stop());
                    };
                    mediaRecorder.start();
                    btn.classList.add('recording-active');
                } catch(e) { showToast("Mic permission required", "error"); }
            };
            const stop = () => { if(mediaRecorder && mediaRecorder.state === 'recording') { mediaRecorder.stop(); btn.classList.remove('recording-active'); } };
            btn.onmousedown = start; btn.onmouseup = stop; btn.ontouchstart = start; btn.ontouchend = stop;
        }

        function renderAudio(id, data, sender, isTimed) {
            const div = document.createElement('div');
            const isMe = sender === 'me';
            div.className = `msg-bubble ${isMe ? 'msg-me' : 'msg-other'} ${isTimed ? 'msg-timed' : ''}`;
            const aid = `aud-${id}`;
            div.innerHTML = `<div class="flex items-center gap-2"><button onclick="document.getElementById('${aid}').play()" class="w-8 h-8 bg-black/10 rounded-full flex items-center justify-center"><i class="ph-fill ph-play"></i></button><div class="text-xs font-bold opacity-70">Voice Note</div></div><audio id="${aid}" src="${data}"></audio>`;
            document.getElementById('messages-container').appendChild(div);
            scrollToBottom();
            if(isTimed) setTimeout(() => { div.style.opacity='0'; setTimeout(()=>div.remove(),500); }, 15000);
        }

        function renderSticker(url, sender) {
            const container = document.getElementById('messages-container');
            const div = document.createElement('div');
            const isMe = sender === 'me';
            div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-6 relative`;
            div.dataset.type = 'media';
            div.dataset.id = crypto.randomUUID(); 
            div.innerHTML = `<img src="${url}" class="sticker-img shadow-lg" onload="scrollToBottom()" onerror="this.src='https://via.placeholder.com/150?text=Error'">`;
            
            div.oncontextmenu = (e) => showContextMenu(e, div, isMe);
            container.appendChild(div);
            scrollToBottom();
        }

        // --- MISSING FUNCTIONS RESTORED ---
        
        function renderStickerGrid(list) {
            const grid = document.getElementById('sticker-grid');
            if(!grid) return;
            grid.innerHTML = '';
            list.forEach(item => {
                const img = document.createElement('img');
                img.src = item.url;
                img.className = 'sticker-img cursor-pointer object-contain h-20 w-full rounded-lg border border-transparent hover:border-gray-300 transition-all bg-white';
                img.onclick = () => {
                    sendSticker(item.url);
                    toggleMediaDrawer();
                };
                grid.appendChild(img);
            });
        }

        function filterStickers() {
            const query = document.getElementById('sticker-search').value.toLowerCase();
            const filtered = initialStickers.filter(s => s.tags.includes(query));
            renderStickerGrid(filtered);
        }

    </script>
</body>
</html>
