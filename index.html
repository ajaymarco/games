<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DoodleChain</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #6366f1; overscroll-behavior: none; }
        .pattern-grid { background-image: radial-gradient(#818cf8 2px, transparent 2px); background-size: 24px 24px; }
        .canvas-container { touch-action: none; cursor: crosshair; background-image: linear-gradient(#e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px); background-size: 20px 20px; }
        .card-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .modal-backdrop { background-color: rgba(17, 24, 39, 0.7); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col pattern-grid text-gray-800">

    <header class="bg-white/95 backdrop-blur shadow-lg px-4 py-2 flex justify-between items-center z-10 shrink-0 border-b-4 border-indigo-200">
        <div class="flex items-center gap-2">
            <div class="bg-indigo-600 text-white w-8 h-8 rounded-lg flex items-center justify-center shadow"><i class="fa-solid fa-link"></i></div>
            <h1 class="text-2xl font-black text-indigo-700 tracking-tight">Doodle<span class="text-orange-500">Chain</span></h1>
        </div>
        <div class="flex items-center gap-2">
             <button onclick="toggleHowTo()" class="bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-100 transition border border-indigo-100">Help</button>
            <div id="status-indicator" class="text-xs font-bold px-3 py-1.5 rounded-lg bg-gray-100 text-gray-500 border border-gray-200">Offline</div>
        </div>
    </header>

    <main class="flex-1 relative overflow-y-auto overflow-x-hidden w-full flex flex-col items-center justify-center p-4">
        
        <div id="scene-lobby" class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-6 card-pop flex flex-col gap-5 border-4 border-indigo-50">
            <div class="space-y-2">
                <label class="block text-xs font-black text-gray-400 uppercase tracking-wider ml-1">Your Nickname</label>
                <div class="relative">
                    <input type="text" id="input-name" placeholder="Enter name" maxlength="12" class="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-indigo-500 focus:bg-white transition font-bold text-gray-700 pl-10">
                    <i class="fa-solid fa-user absolute left-4 top-4 text-gray-400"></i>
                </div>
            </div>

            <div class="bg-gray-100 p-1.5 rounded-xl flex font-bold text-sm">
                <button onclick="switchLobbyTab('host')" id="tab-host" class="flex-1 py-2.5 rounded-lg shadow-sm bg-white text-indigo-600 transition">Host Game</button>
                <button onclick="switchLobbyTab('join')" id="tab-join" class="flex-1 py-2.5 rounded-lg text-gray-500 hover:text-gray-700 transition">Join Game</button>
            </div>

            <div id="section-host" class="space-y-5">
                <div class="bg-indigo-50 border-2 border-indigo-100 rounded-2xl p-4 text-center relative">
                    <p class="text-xs text-indigo-500 font-black uppercase tracking-wider mb-1">Room Key</p>
                    <div class="flex items-center justify-center gap-3">
                        <input type="text" id="host-key-display" value="..." class="text-3xl font-black text-indigo-700 bg-transparent text-center w-32 uppercase focus:outline-none border-b-2 border-transparent focus:border-indigo-500" maxlength="4" onchange="updateCustomKey(this.value)">
                        <button onclick="copyInviteLink()" class="w-10 h-10 rounded-full bg-indigo-200 text-indigo-700 hover:bg-indigo-300 transition flex items-center justify-center"><i class="fa-solid fa-share-nodes"></i></button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Mode</label>
                        <select id="game-mode-select" class="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-3 py-2 text-sm font-bold text-gray-700 outline-none">
                            <option value="CLASSIC">Classic (Write First)</option>
                            <option value="ART_START">Art First (Draw First)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Timer</label>
                        <select id="game-timer-select" class="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-3 py-2 text-sm font-bold text-gray-700 outline-none">
                            <option value="0">No Limit</option>
                            <option value="30">30s</option>
                            <option value="60">60s</option>
                        </select>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-xl p-3 border border-gray-100 min-h-[80px]">
                    <p class="text-xs font-bold text-gray-400 mb-2 uppercase flex justify-between">Players <span id="player-count">1</span></p>
                    <div id="lobby-player-list" class="flex flex-wrap gap-2"></div>
                </div>

                <button onclick="startGame()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-xl shadow-[0_4px_0_rgb(67,56,202)] active:shadow-none active:translate-y-[4px] transition text-lg uppercase tracking-wide">Start Game</button>
            </div>

            <div id="section-join" class="hidden space-y-4 pt-2">
                <input type="text" id="input-host-id" placeholder="ABCD" maxlength="4" class="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-4 focus:outline-none focus:border-indigo-500 font-mono text-center text-3xl uppercase tracking-[0.2em] font-bold">
                <button onclick="joinGame()" class="w-full bg-green-500 hover:bg-green-600 text-white font-black py-4 rounded-xl shadow-[0_4px_0_rgb(21,128,61)] active:shadow-none active:translate-y-[4px] transition text-lg uppercase">Join Room</button>
            </div>
        </div>

        <div id="scene-waiting" class="hidden text-center card-pop">
            <div class="bg-white p-8 rounded-3xl shadow-xl max-w-sm border-4 border-indigo-50">
                <div class="relative w-16 h-16 mx-auto mb-4">
                    <div class="absolute inset-0 border-4 border-indigo-500 rounded-full border-t-transparent animate-spin"></div>
                </div>
                <h2 class="text-xl font-black text-gray-800">Waiting...</h2>
                <p id="waiting-msg" class="text-gray-500 font-bold mt-2">Connecting to other players</p>
            </div>
        </div>

        <div id="scene-input" class="hidden w-full max-w-lg card-pop">
            <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border-4 border-indigo-50">
                <div class="bg-indigo-600 p-4 text-white flex justify-between items-center">
                    <p id="input-instruction" class="font-bold text-lg">Write something</p>
                    <div id="timer-text-input" class="font-mono font-bold bg-indigo-800 px-3 py-1 rounded-lg text-sm hidden">0s</div>
                </div>
                <div id="input-image-preview" class="hidden p-4 bg-gray-100 flex justify-center border-b-2 border-dashed border-gray-300">
                    <img id="img-to-guess" src="" class="max-h-56 rounded-lg shadow-sm bg-white border-4 border-white">
                </div>
                <div class="p-6">
                    <textarea id="game-text-input" class="w-full h-32 bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4 text-xl font-bold focus:outline-none focus:border-yellow-400 resize-none" placeholder="Type here..."></textarea>
                    <button onclick="submitRound()" class="w-full mt-4 bg-gray-900 text-white font-black py-4 rounded-xl shadow-lg hover:bg-black transition">Submit</button>
                </div>
            </div>
        </div>

        <div id="scene-canvas" class="hidden w-full max-w-2xl h-full flex flex-col pb-2">
            <div class="bg-white rounded-2xl shadow-lg p-2 mb-3 flex items-center justify-between shrink-0 border-2 border-indigo-50">
                <p class="font-bold text-gray-800 text-sm truncate" id="draw-prompt">Draw: Something</p>
                <div class="bg-red-50 text-red-600 px-3 py-1 rounded-xl font-mono font-bold hidden" id="timer-canvas">30s</div>
            </div>
            <div class="flex-1 relative bg-white rounded-2xl shadow-inner border-4 border-gray-200 overflow-hidden canvas-container" id="canvas-wrapper">
                <canvas id="drawing-canvas"></canvas>
            </div>
            <div class="bg-white rounded-2xl shadow-lg p-3 mt-3 shrink-0">
                <div class="flex justify-between items-center gap-2">
                    <div class="flex gap-2 py-1">
                        <button class="w-8 h-8 rounded-full bg-black" onclick="setColor('#000000')"></button>
                        <button class="w-8 h-8 rounded-full bg-red-500" onclick="setColor('#ef4444')"></button>
                        <button class="w-8 h-8 rounded-full bg-blue-500" onclick="setColor('#3b82f6')"></button>
                        <button class="w-8 h-8 rounded-full bg-white border border-gray-300 flex items-center justify-center" onclick="setColor('#ffffff', true)"><i class="fa-solid fa-eraser"></i></button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="clearCanvas()" class="w-10 h-10 rounded-xl bg-gray-100 text-gray-400"><i class="fa-solid fa-trash"></i></button>
                        <button onclick="submitRound()" class="px-6 h-10 rounded-xl bg-indigo-600 text-white font-bold">Done</button>
                    </div>
                </div>
                <input type="range" min="2" max="25" value="5" class="w-full mt-3 accent-indigo-600" oninput="setLineWidth(this.value)">
            </div>
        </div>

        <div id="scene-showcase" class="hidden w-full max-w-4xl h-full flex flex-col p-4">
            <h2 class="text-3xl font-black text-white text-center mb-6">Results</h2>
            <div id="showcase-container" class="flex-1 overflow-y-auto space-y-8 no-scrollbar pb-24"></div>
            <div class="fixed bottom-6 left-1/2 -translate-x-1/2 flex gap-4">
                 <button onclick="location.reload()" class="bg-white text-indigo-600 px-8 py-3 rounded-full font-black shadow-xl uppercase">Play Again</button>
            </div>
        </div>
    </main>

    <script>
        const APP_STATE = {
            peer: null, conn: null, connections: [], myId: null, hostId: null, myName: '', isHost: false, players: [],
            game: { phase: 'LOBBY', mode: 'CLASSIC', timerDuration: 0, round: 0, totalPlayers: 0, books: [], timerInterval: null }
        };

        const scenes = { lobby: document.getElementById('scene-lobby'), waiting: document.getElementById('scene-waiting'), input: document.getElementById('scene-input'), canvas: document.getElementById('scene-canvas'), showcase: document.getElementById('scene-showcase') };
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');

        function generateShortId() { return Math.random().toString(36).substring(2, 6).toUpperCase(); }

        function initPeer(customId = null) {
            const idToUse = customId || generateShortId();
            if (APP_STATE.peer) APP_STATE.peer.destroy();
            APP_STATE.peer = new Peer(idToUse);
            APP_STATE.peer.on('open', (id) => {
                APP_STATE.myId = id;
                document.getElementById('host-key-display').value = id;
                document.getElementById('status-indicator').textContent = "Online";
                if (APP_STATE.isHost) window.location.hash = id;
            });
            APP_STATE.peer.on('connection', (conn) => {
                if (!APP_STATE.isHost) return conn.close();
                APP_STATE.connections.push(conn);
                conn.on('data', (data) => handleDataPacket(data, conn.peer));
                conn.on('close', () => {
                    APP_STATE.connections = APP_STATE.connections.filter(c => c !== conn);
                    APP_STATE.players = APP_STATE.players.filter(p => p.peerId !== conn.peer);
                    renderPlayerList();
                    broadcast('PLAYER_LIST', APP_STATE.players);
                });
            });
        }

        function switchLobbyTab(tab) {
            APP_STATE.isHost = (tab === 'host');
            document.getElementById('section-host').classList.toggle('hidden', !APP_STATE.isHost);
            document.getElementById('section-join').classList.toggle('hidden', APP_STATE.isHost);
            document.getElementById('tab-host').className = APP_STATE.isHost ? "flex-1 py-2.5 rounded-lg shadow-sm bg-white text-indigo-600 transition" : "flex-1 py-2.5 rounded-lg text-gray-500 transition";
            document.getElementById('tab-join').className = !APP_STATE.isHost ? "flex-1 py-2.5 rounded-lg shadow-sm bg-white text-indigo-600 transition" : "flex-1 py-2.5 rounded-lg text-gray-500 transition";
        }

        function updateCustomKey(val) { initPeer(val.toUpperCase()); }

        function joinGame() {
            APP_STATE.myName = document.getElementById('input-name').value.trim() || "Player";
            const hostId = document.getElementById('input-host-id').value.trim().toUpperCase();
            APP_STATE.hostId = hostId;
            APP_STATE.conn = APP_STATE.peer.connect(hostId);
            APP_STATE.conn.on('open', () => {
                APP_STATE.conn.send({ type: 'JOIN', payload: { name: APP_STATE.myName } });
                showScene('waiting');
            });
            APP_STATE.conn.on('data', (data) => handleDataPacket(data));
        }

        function broadcast(type, payload) {
            const msg = { type, payload };
            APP_STATE.connections.forEach(c => c.send(msg));
        }

        function startGame() {
            if (APP_STATE.players.length < 2) return alert("Need 2+ players!");
            APP_STATE.myName = document.getElementById('input-name').value.trim() || "Host";
            APP_STATE.players[0].name = APP_STATE.myName; // Host is always first
            APP_STATE.game.mode = document.getElementById('game-mode-select').value;
            APP_STATE.game.timerDuration = parseInt(document.getElementById('game-timer-select').value);
            APP_STATE.game.totalPlayers = APP_STATE.players.length;
            APP_STATE.game.books = APP_STATE.players.map(p => ({ ownerId: p.peerId, ownerName: p.name, pages: [] }));
            
            const pld = { totalPlayers: APP_STATE.players.length, mode: APP_STATE.game.mode, timerDuration: APP_STATE.game.timerDuration, players: APP_STATE.players };
            broadcast('GAME_START', pld);
            handleGameStart(pld);
        }

        function handleDataPacket(data, senderId) {
            if (data.type === 'JOIN') {
                APP_STATE.players.push({ name: data.payload.name, peerId: senderId, isHost: false });
                renderPlayerList();
                broadcast('PLAYER_LIST', APP_STATE.players);
            } else if (data.type === 'PLAYER_LIST') {
                APP_STATE.players = data.payload;
                renderPlayerList();
            } else if (data.type === 'GAME_START') {
                handleGameStart(data.payload);
            } else if (data.type === 'SUBMIT_ROUND') {
                handleRoundSubmission(senderId, data.payload);
            } else if (data.type === 'NEXT_PHASE') {
                startRound(data.payload);
            } else if (data.type === 'GAME_OVER') {
                renderShowcase(data.payload);
            }
        }

        function handleGameStart(payload) {
            APP_STATE.game.round = 1;
            APP_STATE.game.mode = payload.mode;
            APP_STATE.game.timerDuration = payload.timerDuration;
            APP_STATE.players = payload.players || APP_STATE.players;
            
            if (APP_STATE.game.mode === 'ART_START') {
                showScene('canvas'); resizeCanvas(); clearCanvas();
                document.getElementById('draw-prompt').textContent = "Draw anything!";
                setupTimer('canvas');
            } else {
                showScene('input');
                document.getElementById('input-instruction').textContent = "Start the chain!";
                document.getElementById('input-image-preview').classList.add('hidden');
                setupTimer('input');
            }
        }

        function handleRoundSubmission(senderId, content) {
            const round = APP_STATE.game.round;
            const players = APP_STATE.players;
            const pIdx = players.findIndex(p => p.peerId === senderId);
            
            // Logic: Book index rotates every round
            let bookIdx = (pIdx - (round - 1)) % players.length;
            if (bookIdx < 0) bookIdx += players.length;

            APP_STATE.game.books[bookIdx].pages.push({ ...content, author: players[pIdx].name });

            // Count how many books have this round's page
            const count = APP_STATE.game.books.filter(b => b.pages.length >= round).length;
            if (count === players.length) advanceGame();
        }

        function advanceGame() {
            if (APP_STATE.game.round >= APP_STATE.game.totalPlayers) {
                broadcast('GAME_OVER', APP_STATE.game.books);
                renderShowcase(APP_STATE.game.books);
                return;
            }

            APP_STATE.game.round++;
            const round = APP_STATE.game.round;
            const players = APP_STATE.players;

            players.forEach((p, i) => {
                let bookIdx = (i - (round - 1)) % players.length;
                if (bookIdx < 0) bookIdx += players.length;
                
                const lastPage = APP_STATE.game.books[bookIdx].pages[round - 2];
                const phase = (APP_STATE.game.mode === 'CLASSIC') ? (round % 2 === 0 ? 'DRAW' : 'GUESS') : (round % 2 === 0 ? 'GUESS' : 'DRAW');

                const pld = { mode: phase, prompt: lastPage.value };
                if (p.peerId === APP_STATE.myId) startRound(pld);
                else {
                    const c = APP_STATE.connections.find(conn => conn.peer === p.peerId);
                    if (c) c.send({ type: 'NEXT_PHASE', payload: pld });
                }
            });
        }

        function startRound(pld) {
            if (pld.mode === 'DRAW') {
                showScene('canvas'); resizeCanvas(); clearCanvas();
                document.getElementById('draw-prompt').textContent = "Draw: " + pld.prompt;
                setupTimer('canvas');
            } else {
                showScene('input');
                document.getElementById('input-instruction').textContent = "Describe this:";
                document.getElementById('input-image-preview').classList.remove('hidden');
                document.getElementById('img-to-guess').src = pld.prompt;
                document.getElementById('game-text-input').value = "";
                setupTimer('input');
            }
        }

        function submitRound() {
            if (APP_STATE.game.timerInterval) clearInterval(APP_STATE.game.timerInterval);
            const scene = scenes.input.classList.contains('hidden') ? 'canvas' : 'input';
            const val = scene === 'input' ? { type: 'text', value: document.getElementById('game-text-input').value } : { type: 'image', value: canvas.toDataURL('image/jpeg', 0.5) };
            
            showScene('waiting');
            if (APP_STATE.isHost) handleRoundSubmission(APP_STATE.myId, val);
            else APP_STATE.conn.send({ type: 'SUBMIT_ROUND', payload: val });
        }

        function setupTimer(type) {
            if (APP_STATE.game.timerInterval) clearInterval(APP_STATE.game.timerInterval);
            if (!APP_STATE.game.timerDuration) return;
            const el = type === 'canvas' ? document.getElementById('timer-canvas') : document.getElementById('timer-text-input');
            el.classList.remove('hidden');
            let t = APP_STATE.game.timerDuration;
            el.textContent = t + "s";
            APP_STATE.game.timerInterval = setInterval(() => {
                t--; el.textContent = t + "s";
                if (t <= 0) submitRound();
            }, 1000);
        }

        function renderPlayerList() {
            const list = document.getElementById('lobby-player-list');
            list.innerHTML = '';
            APP_STATE.players.forEach(p => {
                const d = document.createElement('div');
                d.className = "bg-white border-2 border-indigo-100 px-3 py-1 rounded-lg text-xs font-bold shadow-sm";
                d.textContent = p.name;
                list.appendChild(d);
            });
            document.getElementById('player-count').textContent = APP_STATE.players.length;
        }

        function renderShowcase(books) {
            showScene('showcase');
            const container = document.getElementById('showcase-container');
            container.innerHTML = '';
            books.forEach(book => {
                const card = document.createElement('div');
                card.className = "bg-white rounded-3xl p-6 shadow-xl border-4 border-indigo-100";
                card.innerHTML = `<h3 class="font-black text-indigo-600 mb-4">${book.ownerName}'s Journey</h3>`;
                book.pages.forEach(p => {
                    const row = document.createElement('div');
                    row.className = "mb-4 border-t pt-2";
                    row.innerHTML = `<p class="text-[10px] uppercase font-black text-gray-400">${p.author}</p>`;
                    if (p.type === 'text') row.innerHTML += `<p class="text-xl font-bold">"${p.value}"</p>`;
                    else row.innerHTML += `<img src="${p.value}" class="w-full rounded-lg mt-2">`;
                    card.appendChild(row);
                });
                container.appendChild(card);
            });
        }

        function showScene(id) { Object.values(scenes).forEach(s => s.classList.add('hidden')); scenes[id].classList.remove('hidden'); }
        function setColor(c, e) { brushColor = e ? '#ffffff' : c; }
        function setLineWidth(v) { brushSize = v; }
        function clearCanvas() { ctx.fillStyle = "white"; ctx.fillRect(0,0, canvas.width, canvas.height); }
        function resizeCanvas() { const w = document.getElementById('canvas-wrapper'); canvas.width = w.clientWidth; canvas.height = w.clientHeight; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; clearCanvas(); }

        let isDrawing = false, lastX = 0, lastY = 0, brushColor = '#000000', brushSize = 5;
        const getPos = (e) => { const r = canvas.getBoundingClientRect(); const t = e.touches ? e.touches[0] : e; return { x: t.clientX - r.left, y: t.clientY - r.top }; };
        canvas.addEventListener('mousedown', (e) => { isDrawing = true; const p = getPos(e); lastX = p.x; lastY = p.y; });
        canvas.addEventListener('mousemove', (e) => { if (!isDrawing) return; const p = getPos(e); ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(p.x, p.y); ctx.strokeStyle = brushColor; ctx.lineWidth = brushSize; ctx.stroke(); lastX = p.x; lastY = p.y; });
        canvas.addEventListener('mouseup', () => isDrawing = false);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); isDrawing = true; const p = getPos(e); lastX = p.x; lastY = p.y; }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { if (!isDrawing) return; e.preventDefault(); const p = getPos(e); ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(p.x, p.y); ctx.strokeStyle = brushColor; ctx.lineWidth = brushSize; ctx.stroke(); lastX = p.x; lastY = p.y; }, {passive: false});
        canvas.addEventListener('touchend', () => isDrawing = false);

        window.onload = () => {
            const h = window.location.hash;
            if (h) { switchLobbyTab('join'); document.getElementById('input-host-id').value = h.substring(1).toUpperCase(); }
            else { switchLobbyTab('host'); APP_STATE.players = [{ name: 'Host', peerId: null, isHost: true }]; renderPlayerList(); }
            initPeer();
        };
        function toggleHowTo() { alert("Write a sentence, pass it on. Next person draws it. Next person guesses the drawing. See the hilarious chain at the end!"); }
        function copyInviteLink() { navigator.clipboard.writeText(window.location.href).then(() => alert("Link copied!")); }
    </script>
</body>
</html>
