<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tactile.io - Pro P2P Chat</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Emoji Picker -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.18.3/index.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Linkify -->
    <script src="https://cdn.jsdelivr.net/npm/linkifyjs@4.1.3/dist/linkify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/linkify-html@4.1.3/dist/linkify-html.min.js"></script>

    <!-- Toastify JS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- AutoAnimate -->
    <script type="module">
        import autoAnimate from 'https://cdn.jsdelivr.net/npm/@formkit/auto-animate@1.0.0/index.min.js';
        window.autoAnimate = autoAnimate;
    </script>

    <style>
        :root {
            /* Crystal Brutalism Palette */
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --tactile-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --hard-shadow: 3px 3px 0px 0px rgba(0,0,0,1);
            
            --accent-primary: #3b82f6;
            --accent-danger: #ef4444;
            --accent-success: #10b981;
            --accent-ephemeral: #8b5cf6; /* Purple for timed messages */
            
            --bg-mesh-1: #ff9a9e;
            --bg-mesh-2: #fad0c4;
            --bg-mesh-3: #fad0c4;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            background-image: 
                radial-gradient(at 40% 20%, hsla(28,100%,74%,0.4) 0px, transparent 50%),
                radial-gradient(at 80% 0%, hsla(189,100%,56%,0.4) 0px, transparent 50%),
                radial-gradient(at 0% 50%, hsla(340,100%,76%,0.4) 0px, transparent 50%);
            background-attachment: fixed;
            height: 100dvh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            color: #1f2937;
        }

        .font-display { font-family: 'Space Grotesk', sans-serif; }

        /* Glassmorphic Tactile Box */
        .tactile-box {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.1), 
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                inset 0 0 0 1px rgba(255,255,255,0.5); /* Inner light border */
            border-radius: 24px;
        }
        
        /* Buttons */
        .tactile-btn {
            background: #ffffff;
            border: 1.5px solid #000;
            box-shadow: var(--hard-shadow);
            transform: translate(0, 0);
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            font-weight: 600;
        }
        
        .tactile-btn:active {
            box-shadow: 0px 0px 0px 0px #000;
            transform: translate(3px, 3px);
        }

        .tactile-btn.active-mode {
            background-color: var(--accent-ephemeral);
            color: white;
            border-color: var(--accent-ephemeral);
        }

        /* Inputs */
        .tactile-input {
            border: 1.5px solid #000;
            background: rgba(255,255,255,0.8);
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }
        .tactile-input:focus {
            background: #fff;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            outline: none;
        }

        /* Chat Messages */
        #messages-container {
            mask-image: linear-gradient(to top, black 96%, transparent 100%);
        }

        .msg-bubble {
            max-width: 85%;
            padding: 10px 16px;
            border-radius: 18px;
            position: relative;
            border: 1px solid rgba(0,0,0,0.1);
            word-wrap: break-word;
            margin-bottom: 16px;
            font-size: 0.95rem;
            line-height: 1.5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: opacity 0.5s ease-out;
        }

        .msg-me {
            background: #3b82f6; /* Solid Blue */
            color: white;
            border-bottom-right-radius: 4px;
            margin-left: auto;
            box-shadow: 4px 4px 10px rgba(59, 130, 246, 0.3);
        }
        
        .msg-me a { color: #dbeafe !important; }

        .msg-other {
            background: #ffffff;
            color: #1f2937;
            border-bottom-left-radius: 4px;
            margin-right: auto;
            border: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        /* Ephemeral Message Styling */
        .msg-timed {
            border: 2px dashed var(--accent-ephemeral);
            position: relative;
            overflow: hidden;
        }
        .msg-timed::before {
            content: '';
            position: absolute;
            top: 0; left: 0; bottom: 0;
            width: 100%;
            background: rgba(139, 92, 246, 0.1);
            animation: timer 15s linear forwards;
            pointer-events: none;
            z-index: 0;
        }
        @keyframes timer {
            from { width: 100%; }
            to { width: 0%; }
        }

        .msg-me.msg-timed { background: #7c3aed; } /* Darker purple for me */
        .msg-other.msg-timed { border-color: #8b5cf6; }

        /* Utility Components */
        .reactions-container {
            position: absolute;
            bottom: -14px;
            display: flex;
            gap: 2px;
            z-index: 5;
        }
        .msg-me .reactions-container { right: 0; }
        .msg-other .reactions-container { left: 0; }

        .reaction-pill {
            background: #fff;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: popIn 0.2s;
            color: #000;
        }

        /* Animations */
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.9) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .recording-active {
            background-color: #fee2e2 !important;
            color: #dc2626 !important;
            border-color: #dc2626 !important;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2);
            animation: pulse 1.5s infinite;
        }

        /* Toastify Override */
        .toastify {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            color: #1f2937;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            padding: 12px 16px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.2); }
    </style>
</head>
<body class="text-gray-900 selection:bg-blue-500 selection:text-white">

    <div id="app" class="relative w-full h-full max-w-6xl mx-auto flex flex-col sm:p-6 lg:p-8">
        
        <!-- 1. LANDING PAGE -->
        <div id="landing-page" class="flex-1 w-full h-full flex flex-col items-center justify-center p-4 z-20">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-4xl">
                
                <!-- Brand Box -->
                <div class="tactile-box p-12 md:col-span-2 flex flex-col items-center text-center relative overflow-hidden bg-white/50">
                    <div class="absolute inset-0 bg-gradient-to-br from-blue-50/50 to-purple-50/50 -z-10"></div>
                    <h1 class="text-7xl font-bold mb-2 tracking-tighter relative z-10 font-display bg-clip-text text-transparent bg-gradient-to-r from-gray-900 to-gray-600">TACTILE.IO</h1>
                    <p class="text-lg text-gray-600 font-medium tracking-wide">Professional P2P Communication Suite</p>
                </div>

                <!-- Input Box -->
                <div class="tactile-box p-8 bg-white/80 flex flex-col justify-center gap-6">
                    <div>
                        <label class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-2 block">Identity</label>
                        <input type="text" id="username-input" placeholder="Display Name" class="tactile-input w-full p-4 rounded-xl text-lg" maxlength="20">
                    </div>
                    
                    <div>
                        <label class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-2 block">Secure Frequency</label>
                        <div class="relative">
                            <i class="ph-bold ph-hash absolute left-4 top-1/2 -translate-y-1/2 text-xl text-gray-400"></i>
                            <input type="text" id="room-input" placeholder="room-code" class="tactile-input w-full p-4 pl-12 rounded-xl text-lg font-mono uppercase tracking-widest text-gray-700">
                        </div>
                    </div>
                </div>

                <!-- Action Box -->
                <div class="tactile-box p-8 bg-white/80 flex flex-col justify-center gap-4">
                    <div class="grid grid-cols-2 gap-4 h-full">
                        <button onclick="startSession('create')" class="tactile-btn rounded-xl flex flex-col items-center justify-center p-4 hover:bg-emerald-50 hover:border-emerald-500 group transition-all">
                            <i class="ph-fill ph-broadcast text-3xl mb-3 text-emerald-500 group-hover:scale-110 transition-transform"></i>
                            <span class="font-bold text-gray-700">Host Room</span>
                        </button>
                        <button onclick="startSession('join')" class="tactile-btn rounded-xl flex flex-col items-center justify-center p-4 hover:bg-blue-50 hover:border-blue-500 group transition-all">
                            <i class="ph-fill ph-plugs-connected text-3xl mb-3 text-blue-500 group-hover:scale-110 transition-transform"></i>
                            <span class="font-bold text-gray-700">Join Room</span>
                        </button>
                    </div>
                </div>
            </div>
            <p class="mt-12 text-xs font-semibold text-gray-400 tracking-widest uppercase">v3.0 ‚Ä¢ Ephemeral ‚Ä¢ Encrypted</p>
        </div>

        <!-- 2. CHAT INTERFACE -->
        <div id="chat-interface" class="hidden absolute inset-0 sm:static sm:h-full sm:rounded-[24px] tactile-box overflow-hidden flex-col bg-white/80">
            
            <!-- Header -->
            <header class="h-20 border-b border-gray-200 bg-white/50 backdrop-blur-md flex items-center justify-between px-6 z-30 shrink-0">
                <div class="flex items-center gap-4">
                    <div class="relative cursor-pointer hover:opacity-80 transition active:scale-95" onclick="toggleSettings()">
                        <div class="w-11 h-11 rounded-full p-0.5 border border-gray-200 bg-white shadow-sm">
                             <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Init" id="remote-avatar" class="w-full h-full object-cover rounded-full">
                        </div>
                        <div id="status-dot" class="absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 border-white bg-gray-300 shadow-sm"></div>
                    </div>
                    <div>
                        <h2 id="chat-title" class="font-bold text-xl leading-tight truncate max-w-[140px] sm:max-w-xs font-display text-gray-800">Waiting...</h2>
                        <div class="flex items-center gap-1.5">
                            <span id="chat-status" class="text-xs font-medium text-gray-500">Disconnected</span>
                        </div>
                    </div>
                </div>

                <div class="flex gap-2 items-center">
                    <button onclick="startCall(false)" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-blue-50 text-gray-600 hover:text-blue-600 transition-colors" title="Voice Call">
                        <i class="ph-bold ph-phone text-xl"></i>
                    </button>
                    <button onclick="startCall(true)" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-emerald-50 text-gray-600 hover:text-emerald-600 transition-colors" title="Video Call">
                        <i class="ph-bold ph-video text-xl"></i>
                    </button>
                    <div class="w-px h-6 bg-gray-300 mx-2"></div>
                    <button onclick="toggleSettings()" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-100 text-gray-600 transition-colors" title="Settings">
                        <i class="ph-bold ph-gear text-xl"></i>
                    </button>
                    <button onclick="disconnect()" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-red-50 text-red-500 transition-colors" title="Disconnect">
                        <i class="ph-bold ph-power text-xl"></i>
                    </button>
                </div>
            </header>

            <!-- Messages Area -->
            <div id="messages-container" class="flex-1 overflow-y-auto p-4 sm:p-6 relative scroll-smooth">
                <div class="flex flex-col items-center justify-center mt-12 opacity-40 select-none text-center">
                    <div class="w-16 h-16 rounded-2xl bg-gray-100 flex items-center justify-center mb-4">
                        <i class="ph-duotone ph-shield-check text-3xl text-gray-500"></i>
                    </div>
                    <p class="text-sm font-bold font-display text-gray-600">Secure Channel Established</p>
                    <p class="text-xs mt-1 text-gray-500">Messages are end-to-end encrypted and not stored.</p>
                </div>
            </div>

            <!-- Context Bars -->
            <div id="activity-indicator" class="hidden absolute bottom-24 left-6 bg-white/90 backdrop-blur px-4 py-2 rounded-full text-xs font-bold animate-fadeIn z-20 shadow-lg border border-gray-100 flex items-center gap-2 text-gray-600">
                <div class="flex gap-1">
                    <div class="w-1.5 h-1.5 bg-gray-500 rounded-full animate-bounce"></div>
                    <div class="w-1.5 h-1.5 bg-gray-500 rounded-full animate-bounce delay-75"></div>
                    <div class="w-1.5 h-1.5 bg-gray-500 rounded-full animate-bounce delay-150"></div>
                </div>
                <span id="activity-text">Typing...</span>
            </div>

            <div id="reply-preview" class="hidden bg-white/95 border-t border-gray-200 p-3 flex justify-between items-center text-sm shadow-sm z-20 backdrop-blur-sm">
                <div class="border-l-4 border-blue-500 pl-3">
                    <span class="font-bold text-[10px] text-blue-600 uppercase tracking-wider">Replying to</span>
                    <p class="truncate max-w-[200px] font-medium text-gray-700 text-xs mt-0.5" id="reply-text">...</p>
                </div>
                <button onclick="cancelReply()" class="p-2 hover:bg-gray-100 rounded-full transition-colors"><i class="ph-bold ph-x text-gray-500"></i></button>
            </div>

            <!-- Input Area -->
            <footer class="p-4 bg-white/80 border-t border-gray-200 shrink-0 relative z-30 backdrop-blur-md">
                
                <!-- Expanded Tools -->
                <div id="media-drawer" class="hidden absolute bottom-full left-0 right-0 bg-white/95 border-t border-gray-200 h-72 flex flex-col shadow-2xl rounded-t-2xl overflow-hidden backdrop-blur-xl">
                    <div class="p-3 border-b border-gray-100 bg-gray-50/50 flex gap-2">
                         <div class="relative flex-1">
                            <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="sticker-search" placeholder="Search stickers..." class="w-full p-2 pl-9 bg-white border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-blue-500 transition-colors" oninput="filterStickers()">
                         </div>
                         <button onclick="document.getElementById('file-picker').click()" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm font-semibold flex items-center gap-2 text-gray-700 transition-colors">
                            <i class="ph-bold ph-file-arrow-up"></i> File
                         </button>
                    </div>
                    <div id="sticker-grid" class="flex-1 overflow-y-auto p-3 grid grid-cols-4 sm:grid-cols-5 gap-3 bg-gray-50/30">
                        <!-- Populated via JS -->
                    </div>
                </div>

                <div class="flex gap-2 items-end">
                    <button onclick="toggleMediaDrawer()" class="tactile-btn w-12 h-12 rounded-xl flex items-center justify-center text-gray-600 hover:bg-gray-50 shrink-0" title="Media Library">
                        <i class="ph-bold ph-plus text-lg"></i>
                    </button>

                    <button onclick="toggleTimedMode()" id="btn-timed" class="tactile-btn w-12 h-12 rounded-xl flex items-center justify-center text-gray-600 shrink-0 transition-colors" title="Ephemeral Mode (15s)">
                        <i class="ph-bold ph-timer text-lg"></i>
                    </button>

                    <div class="flex-1 relative">
                        <textarea id="msg-input" rows="1" class="w-full tactile-input p-3 pr-10 rounded-xl resize-none max-h-32 min-h-[48px] text-base leading-relaxed" placeholder="Type a message..."></textarea>
                        <button onclick="toggleEmojiPicker()" class="absolute right-3 bottom-3 text-gray-400 hover:text-gray-600 transition-colors transform active:scale-95">
                            <i class="ph-fill ph-smiley text-2xl"></i>
                        </button>
                        
                        <div id="emoji-popover" class="hidden absolute bottom-16 right-0 w-80 shadow-2xl border border-gray-200 rounded-xl z-50 overflow-hidden animate-[popIn_0.1s]">
                            <emoji-picker></emoji-picker>
                        </div>
                    </div>

                    <button id="btn-record" class="tactile-btn w-12 h-12 rounded-xl flex items-center justify-center text-gray-600 hover:bg-red-50 hover:text-red-500 shrink-0 transition-colors" title="Hold to Record">
                        <i class="ph-bold ph-microphone text-xl"></i>
                    </button>

                    <button onclick="sendMessage()" class="tactile-btn w-14 h-12 rounded-xl flex items-center justify-center bg-gray-900 text-white border-gray-900 shrink-0 hover:bg-gray-800 active:scale-95 transition-transform shadow-lg">
                        <i class="ph-bold ph-paper-plane-right text-xl"></i>
                    </button>
                </div>
            </footer>
        </div>

        <!-- SETTINGS MODAL -->
        <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm p-4">
            <div class="tactile-box bg-white p-6 max-w-sm w-full animate-[popIn_0.2s]">
                <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                    <h3 class="text-xl font-bold font-display">Preferences</h3>
                    <button onclick="toggleSettings()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100"><i class="ph-bold ph-x text-lg"></i></button>
                </div>
                
                <div class="space-y-3">
                    <!-- Notifications -->
                    <div class="flex justify-between items-center p-4 border border-gray-200 rounded-xl hover:border-gray-400 transition-colors cursor-pointer" onclick="toggleNotifs()">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600"><i class="ph-duotone ph-bell text-xl"></i></div>
                            <div class="flex flex-col">
                                <span class="font-bold text-sm">Notifications</span>
                                <span class="text-xs text-gray-500">Desktop alerts</span>
                            </div>
                        </div>
                        <div id="btn-notif" class="w-12 h-6 bg-gray-200 rounded-full relative transition-colors duration-200 pointer-events-none">
                            <div class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform duration-200 shadow-sm"></div>
                        </div>
                    </div>

                    <!-- Sounds -->
                    <div class="flex justify-between items-center p-4 border border-gray-200 rounded-xl hover:border-gray-400 transition-colors cursor-pointer" onclick="toggleSound()">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-600"><i class="ph-duotone ph-speaker-high text-xl"></i></div>
                            <div class="flex flex-col">
                                <span class="font-bold text-sm">Sound Effects</span>
                                <span class="text-xs text-gray-500">In-app sounds</span>
                            </div>
                        </div>
                        <div id="btn-sound" class="w-12 h-6 bg-gray-900 rounded-full relative transition-colors duration-200 pointer-events-none">
                            <div class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 translate-x-6 transition-transform duration-200 shadow-sm"></div>
                        </div>
                    </div>

                    <!-- Clear Chat -->
                    <button onclick="clearChat()" class="w-full p-4 mt-2 border border-red-200 bg-red-50 text-red-600 rounded-xl font-bold text-sm hover:bg-red-100 transition-colors flex items-center justify-center gap-2">
                        <i class="ph-bold ph-trash"></i> Clear Chat History
                    </button>
                </div>
                <div class="mt-6 text-center text-xs text-gray-400 font-mono">
                    Session ID: <span id="session-id-display">...</span>
                </div>
            </div>
        </div>

        <!-- CALL OVERLAY -->
        <div id="call-overlay" class="hidden fixed inset-0 z-50 bg-black flex flex-col">
            <div class="flex-1 relative group bg-gray-900">
                <video id="remote-video" autoplay playsinline class="w-full h-full object-contain"></video>
                <div class="absolute top-4 right-4 w-32 h-48 bg-black rounded-xl border border-white/20 overflow-hidden shadow-2xl draggable transition-all hover:scale-105 cursor-grab active:cursor-grabbing">
                    <video id="local-video" autoplay playsinline muted class="w-full h-full object-cover transform scale-x-[-1]"></video>
                </div>
                <div class="absolute top-8 left-1/2 -translate-x-1/2 text-center pointer-events-none w-full max-w-md px-4">
                    <div class="inline-flex items-center gap-3 bg-black/60 backdrop-blur-md px-6 py-3 rounded-full text-white border border-white/10 shadow-lg">
                        <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                        <span id="call-status-text" class="font-bold text-sm">Connected</span>
                        <div class="h-4 w-px bg-white/20"></div>
                        <span id="call-timer" class="font-mono text-sm tracking-widest">00:00</span>
                    </div>
                </div>
            </div>
            <div class="h-auto bg-gray-900 flex items-center justify-center gap-6 pb-8 pt-4 safe-area-pb">
                <button onclick="toggleMute()" id="btn-mute" class="w-14 h-14 rounded-full bg-gray-800 text-white flex items-center justify-center hover:bg-gray-700 transition border border-white/10" title="Toggle Mic"><i class="ph-fill ph-microphone text-xl"></i></button>
                <button onclick="endCall()" class="w-16 h-16 rounded-full bg-red-600 text-white flex items-center justify-center shadow-lg hover:bg-red-700 transform hover:scale-105 transition border-4 border-gray-900" title="End Call"><i class="ph-fill ph-phone-slash text-2xl"></i></button>
                <button onclick="toggleCamera()" id="btn-cam" class="w-14 h-14 rounded-full bg-gray-800 text-white flex items-center justify-center hover:bg-gray-700 transition border border-white/10" title="Toggle Cam"><i class="ph-fill ph-video-camera text-xl"></i></button>
            </div>
        </div>

        <!-- INCOMING CALL MODAL -->
        <div id="incoming-call-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
            <div class="tactile-box bg-white p-8 max-w-sm w-full text-center animate-[popIn_0.3s]">
                <div class="w-24 h-24 rounded-full overflow-hidden mx-auto border-4 border-white shadow-xl mb-6 bg-gray-100 ring-1 ring-gray-200">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" id="incoming-avatar" class="w-full h-full object-cover">
                </div>
                <h3 class="text-2xl font-bold mb-2 font-display">Incoming Call</h3>
                <p class="text-gray-500 mb-8 font-medium text-sm">Peer is requesting a connection...</p>
                <div class="flex justify-center gap-8">
                    <div class="flex flex-col items-center gap-2">
                        <button onclick="rejectCall()" class="tactile-btn bg-red-50 text-red-600 w-16 h-16 rounded-2xl flex items-center justify-center hover:bg-red-100 transition-colors border-red-100"><i class="ph-bold ph-phone-slash text-2xl"></i></button>
                        <span class="text-xs font-bold text-gray-400 uppercase">Decline</span>
                    </div>
                    <div class="flex flex-col items-center gap-2">
                        <button onclick="answerCall()" class="tactile-btn bg-emerald-500 text-white w-16 h-16 rounded-2xl flex items-center justify-center animate-bounce shadow-lg hover:bg-emerald-600 border-emerald-600"><i class="ph-bold ph-phone text-2xl"></i></button>
                        <span class="text-xs font-bold text-emerald-600 uppercase">Accept</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTEXT MENU -->
        <div id="context-menu" class="hidden absolute z-50 bg-white/95 backdrop-blur border border-gray-200 rounded-xl shadow-xl overflow-hidden min-w-[180px]">
            <div class="flex justify-around p-3 bg-gray-50 border-b border-gray-100">
                <span class="cursor-pointer hover:scale-125 transition-transform text-lg" onclick="sendReaction('üëç')">üëç</span>
                <span class="cursor-pointer hover:scale-125 transition-transform text-lg" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                <span class="cursor-pointer hover:scale-125 transition-transform text-lg" onclick="sendReaction('üòÇ')">üòÇ</span>
                <span class="cursor-pointer hover:scale-125 transition-transform text-lg" onclick="sendReaction('üî•')">üî•</span>
            </div>
            <div class="p-1">
                <div class="px-3 py-2 hover:bg-gray-100 rounded-lg cursor-pointer flex items-center gap-3 text-sm font-medium text-gray-700" onclick="handleCtxAction('reply')"><i class="ph-bold ph-arrow-u-up-left"></i> Reply</div>
                <div class="px-3 py-2 hover:bg-gray-100 rounded-lg cursor-pointer flex items-center gap-3 text-sm font-medium text-gray-700" onclick="handleCtxAction('copy')"><i class="ph-bold ph-copy"></i> Copy Text</div>
                <div class="px-3 py-2 hover:bg-gray-100 rounded-lg cursor-pointer flex items-center gap-3 text-sm font-medium text-gray-700 hidden" id="ctx-edit" onclick="handleCtxAction('edit')"><i class="ph-bold ph-pencil-simple"></i> Edit</div>
                <div class="px-3 py-2 hover:bg-red-50 rounded-lg cursor-pointer flex items-center gap-3 text-sm font-medium text-red-600 hidden" id="ctx-delete" onclick="handleCtxAction('delete')"><i class="ph-bold ph-trash"></i> Delete</div>
            </div>
        </div>
    </div>

    <input type="file" id="file-picker" class="hidden">

    <script>
        // --- CONFIG & STATE ---
        const initialStickers = [
            { url: 'https://media.tenor.com/2s_01J_1l6kAAAAi/cat-jam-vibe.gif', tags: 'cat vibe dance' },
            { url: 'https://media.tenor.com/On7kvXy7QdkAAAAi/loading-cat.gif', tags: 'cat loading' },
            { url: 'https://media.tenor.com/7100_lDpE8IAAAAi/cat-meme.gif', tags: 'cat meme huh' },
            { url: 'https://media.tenor.com/hK3D38996yEAAAAi/happy-cat.gif', tags: 'cat happy' },
            { url: 'https://media.tenor.com/gK1fsZc9FfUAAAAi/capoo-bugcat.gif', tags: 'capoo bugcat love' },
            { url: 'https://media.tenor.com/1E6H4KaF85QAAAAi/sad-cat.gif', tags: 'cat sad crying' },
            { url: 'https://media.tenor.com/N24M4b5mH58AAAAi/excited.gif', tags: 'cat excited' },
            { url: 'https://media.tenor.com/0l_JmL2jMuwAAAAi/pepe-frog.gif', tags: 'pepe frog' },
            { url: 'https://media.tenor.com/k9y3l7-rK44AAAAi/dog-cool.gif', tags: 'dog cool sunglasses' },
            { url: 'https://media.tenor.com/q7SjG0G4pQAAAAAi/thumbs-up.gif', tags: 'thumbs up ok' }
        ];

        let peer = null;
        let conn = null;
        let myId = '';
        let myName = '';
        let remoteName = 'Peer';
        let currentCall = null;
        let localStream = null;
        let typingTimeout = null;
        let replyContext = null; 
        let settings = { sound: true, notifs: false };
        let ctxTarget = null; 
        let isEditing = null; 
        let isEphemeral = false; // Timed Messages state
        let mediaRecorder = null;
        let audioChunks = [];

        const sounds = {
            pop: new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.m4a'),
            msg: new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.m4a'),
            ring: new Audio('https://assets.mixkit.co/active_storage/sfx/2060/2060-preview.m4a')
        };
        sounds.pop.volume = 0.4;
        sounds.msg.volume = 0.3;
        sounds.ring.loop = true;

        // --- INIT & UI LOGIC ---

        document.addEventListener('DOMContentLoaded', () => {
            renderStickerGrid(initialStickers);
            
            // Restore from LocalStorage
            const storedName = localStorage.getItem('tactile_name');
            const storedRoom = localStorage.getItem('tactile_room');
            if(storedName) document.getElementById('username-input').value = storedName;
            if(storedRoom) document.getElementById('room-input').value = storedRoom;

            // AutoAnimate init
            if(window.autoAnimate) window.autoAnimate(document.getElementById('messages-container'));

            // Enter key
            document.getElementById('msg-input').addEventListener('keydown', (e) => {
                if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
                sendTyping();
            });

            // Global Click Listeners for dismissals
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('context-menu');
                if(!menu.classList.contains('hidden') && !menu.contains(e.target)) menu.classList.add('hidden');
                
                const popover = document.getElementById('emoji-popover');
                const trigger = document.querySelector('button[onclick="toggleEmojiPicker()"]');
                if (!popover.classList.contains('hidden') && !popover.contains(e.target) && !trigger.contains(e.target)) {
                    popover.classList.add('hidden');
                }
            });

            // Emoji Picker
            document.querySelector('emoji-picker').addEventListener('emoji-click', event => {
                const input = document.getElementById('msg-input');
                input.value += event.detail.unicode;
                input.focus();
            });
            
            setupVoiceRecording();

            if(Notification.permission === 'granted') {
                settings.notifs = true;
                updateSettingsUI();
            }
        });

        function showToast(msg, type = 'info') {
            const bg = type === 'error' ? 'rgba(254, 226, 226, 0.9)' : 'rgba(255, 255, 255, 0.9)';
            const color = type === 'error' ? '#dc2626' : '#1f2937';
            
            Toastify({
                text: msg,
                duration: 3000,
                gravity: "top",
                position: "center",
                style: {
                    background: bg,
                    color: color,
                    border: '1px solid rgba(0,0,0,0.1)',
                    boxShadow: '0 8px 24px rgba(0,0,0,0.12)'
                },
                offset: { y: 24 }
            }).showToast();
        }

        // --- NEW FEATURES ---

        function toggleTimedMode() {
            isEphemeral = !isEphemeral;
            const btn = document.getElementById('btn-timed');
            
            if (isEphemeral) {
                btn.classList.add('active-mode');
                showToast("Ephemeral Mode ON: Messages vanish in 15s");
            } else {
                btn.classList.remove('active-mode');
                showToast("Ephemeral Mode OFF");
            }
        }

        function clearChat() {
            document.getElementById('messages-container').innerHTML = '';
            // Add system message back
            const emptyState = `
                <div class="flex flex-col items-center justify-center mt-12 opacity-40 select-none text-center">
                    <div class="w-16 h-16 rounded-2xl bg-gray-100 flex items-center justify-center mb-4">
                        <i class="ph-duotone ph-broom text-3xl text-gray-500"></i>
                    </div>
                    <p class="text-sm font-bold font-display text-gray-600">Chat Cleared</p>
                </div>`;
            document.getElementById('messages-container').innerHTML = emptyState;
            toggleSettings();
            showToast("Chat history cleared locally.");
        }

        function setupVoiceRecording() {
            const btn = document.getElementById('btn-record');
            
            const start = async (e) => {
                e.preventDefault();
                if(!conn || !conn.open) return showToast("Connect first!", "error");
                
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                     return showToast("Audio recording not supported.", "error");
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = () => {
                            const id = crypto.randomUUID();
                            const base64 = reader.result;
                            const payload = { type: 'audio', id: id, data: base64 };
                            if(isEphemeral) { payload.type = 'timed-audio'; payload.duration = 15000; }
                            
                            sendData(payload);
                            renderAudio(id, base64, 'me', isEphemeral);
                        };
                        stream.getTracks().forEach(t => t.stop());
                    };
                    mediaRecorder.start();
                    btn.classList.add('recording-active');
                    sendActivity('Recording Audio...');
                } catch(err) {
                    console.error(err);
                    showToast("Microphone access denied or error.", "error");
                }
            };

            const stop = (e) => {
                if(mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    btn.classList.remove('recording-active');
                }
            };

            btn.addEventListener('mousedown', start);
            btn.addEventListener('mouseup', stop);
            btn.addEventListener('mouseleave', stop);
            btn.addEventListener('touchstart', start);
            btn.addEventListener('touchend', stop);
        }

        // --- SETTINGS & UI ---

        function playSound(type) {
            if(settings.sound && sounds[type]) {
                sounds[type].currentTime = 0;
                sounds[type].play().catch(e => {});
            }
        }
        function stopSound(type) {
            if(sounds[type]) {
                sounds[type].pause();
                sounds[type].currentTime = 0;
            }
        }

        function toggleEmojiPicker() { document.getElementById('emoji-popover').classList.toggle('hidden'); }
        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }

        function toggleNotifs() {
            if(settings.notifs) {
                settings.notifs = false;
            } else {
                Notification.requestPermission().then(perm => {
                    if(perm === 'granted') settings.notifs = true;
                    else showToast("Notifications blocked by browser.", "error");
                    updateSettingsUI();
                });
            }
            updateSettingsUI();
        }

        function toggleSound() { settings.sound = !settings.sound; updateSettingsUI(); }

        function updateSettingsUI() {
            const btnNotif = document.getElementById('btn-notif');
            btnNotif.classList.toggle('bg-gray-900', settings.notifs);
            btnNotif.classList.toggle('bg-gray-200', !settings.notifs);
            btnNotif.querySelector('div').style.transform = settings.notifs ? 'translateX(24px)' : 'translateX(0)';

            const btnSound = document.getElementById('btn-sound');
            btnSound.classList.toggle('bg-gray-900', settings.sound);
            btnSound.classList.toggle('bg-gray-200', !settings.sound);
            btnSound.querySelector('div').style.transform = settings.sound ? 'translateX(24px)' : 'translateX(0)';
        }

        function toggleMediaDrawer() { document.getElementById('media-drawer').classList.toggle('hidden'); }

        function renderStickerGrid(list) {
            const grid = document.getElementById('sticker-grid');
            grid.innerHTML = '';
            list.forEach(item => {
                const img = document.createElement('img');
                img.src = item.url;
                img.className = 'sticker-img cursor-pointer object-contain h-20 w-full rounded-lg border border-transparent hover:border-gray-300 transition-all bg-white';
                img.onclick = () => {
                    sendSticker(item.url);
                    toggleMediaDrawer();
                };
                grid.appendChild(img);
            });
        }

        function filterStickers() {
            const query = document.getElementById('sticker-search').value.toLowerCase();
            const filtered = initialStickers.filter(s => s.tags.includes(query));
            renderStickerGrid(filtered);
        }

        document.getElementById('file-picker').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                if(file.size > 2500000) return showToast("File limit is 2.5MB", "error");
                showToast("Processing file...");
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const id = crypto.randomUUID();
                    sendData({ type: 'file', id: id, name: file.name, data: evt.target.result, mime: file.type });
                    renderFile(id, file.name, evt.target.result, file.type, 'me');
                    toggleMediaDrawer();
                };
                reader.readAsDataURL(file);
            }
        });

        // --- PEERJS LOGIC ---
        function startSession(role) {
            const userIn = document.getElementById('username-input').value.trim();
            const roomIn = document.getElementById('room-input').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '-');
            
            if(!userIn || !roomIn) return showToast("Enter Name and Room Code.", "error");
            
            localStorage.setItem('tactile_name', userIn);
            localStorage.setItem('tactile_room', roomIn);

            myName = userIn;
            
            const hostId = `tactile-chat-${roomIn}-host`;
            const joinId = `tactile-chat-${roomIn}-guest`;
            myId = (role === 'create') ? hostId : joinId;
            const targetId = (role === 'create') ? joinId : hostId;

            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('chat-interface').classList.remove('hidden');
            document.getElementById('chat-title').innerText = roomIn.toUpperCase();
            document.getElementById('session-id-display').innerText = myId;

            initPeer(myId, targetId, role);
        }

        function initPeer(id, targetId, role) {
            peer = new Peer(id, { debug: 1 });
            
            peer.on('open', () => {
                if (role === 'join') {
                    showToast("Connecting to host...");
                    connectToPeer(targetId);
                } else {
                    showToast("Room created. Waiting for guest...", "success");
                    document.getElementById('chat-status').innerText = "Waiting for guest...";
                }
            });

            peer.on('connection', c => { 
                if(conn && conn.open) {
                    c.close(); 
                    showToast("A third user tried to join (rejected).", "error");
                } else {
                    setupConnection(c); 
                }
            });

            peer.on('call', call => {
                document.getElementById('incoming-call-modal').classList.remove('hidden');
                document.getElementById('incoming-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${remoteName}`;
                playSound('ring');

                window.answerCall = () => {
                    stopSound('ring');
                    document.getElementById('incoming-call-modal').classList.add('hidden');
                    
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        conn.send({ type: 'call-rejected' });
                        return showToast("WebRTC not supported.", "error");
                    }
                    
                    navigator.mediaDevices.getUserMedia({video: true, audio: true})
                    .then(stream => {
                        handleCallStart(call, stream);
                    })
                    .catch(err => {
                        console.error(err);
                        showToast("Media access denied.", "error");
                        conn.send({ type: 'call-rejected' });
                    });
                };

                window.rejectCall = () => {
                    stopSound('ring');
                    document.getElementById('incoming-call-modal').classList.add('hidden');
                    call.close();
                    conn.send({ type: 'call-rejected' });
                };
            });

            peer.on('error', err => {
                if(err.type === 'unavailable-id') {
                    showToast("Room occupied! Try a different code.", "error");
                    setTimeout(() => location.reload(), 2000);
                }
                else if(err.type === 'network') showToast("Network error. Checking connection...", "error");
            });
        }

        function connectToPeer(targetId) {
            const c = peer.connect(targetId, { reliable: true });
            setupConnection(c);
        }

        function setupConnection(connection) {
            conn = connection;
            
            conn.on('open', () => {
                document.getElementById('chat-status').innerText = "Encrypted Connection";
                document.getElementById('chat-status').className = "text-xs font-medium text-emerald-600";
                document.getElementById('status-dot').className = "absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 border-white bg-emerald-500";
                
                conn.send({ type: 'info', name: myName });
                playSound('pop');
                showToast("Connected securely.", "success");
            });

            conn.on('data', handleData);
            
            conn.on('close', () => {
                document.getElementById('chat-status').innerText = "Disconnected";
                document.getElementById('chat-status').className = "text-xs font-medium text-red-500";
                document.getElementById('status-dot').className = "absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 border-white bg-red-500";
                showToast("Peer disconnected.", "error");
                conn = null;
            });
        }

        function handleData(data) {
            const ind = document.getElementById('activity-indicator');
            const indText = document.getElementById('activity-text');

            switch(data.type) {
                case 'info':
                    remoteName = data.name;
                    document.getElementById('chat-title').innerText = remoteName;
                    document.getElementById('remote-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${remoteName}`;
                    break;
                case 'text':
                case 'timed-text':
                    const isTimed = data.type === 'timed-text';
                    renderMessage(data.id, data.content, 'other', data.replyTo, isTimed);
                    ind.classList.add('hidden');
                    conn.send({type: 'read', id: data.id});
                    notifyUser(remoteName, isTimed ? "Sent an ephemeral message" : data.content);
                    playSound('msg');
                    break;
                case 'sticker':
                    renderSticker(data.url, 'other');
                    ind.classList.add('hidden');
                    playSound('msg');
                    break;
                case 'file':
                    renderFile(data.id, data.name, data.data, data.mime, 'other');
                    ind.classList.add('hidden');
                    playSound('msg');
                    break;
                case 'audio':
                case 'timed-audio':
                    renderAudio(data.id, data.data, 'other', data.type === 'timed-audio');
                    ind.classList.add('hidden');
                    playSound('msg');
                    break;
                case 'reaction':
                    renderReaction(data.id, data.emoji, false);
                    playSound('pop');
                    break;
                case 'typing':
                    ind.classList.remove('hidden');
                    indText.innerText = data.text || "Typing...";
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => ind.classList.add('hidden'), 3000);
                    break;
                case 'read': updateStatus(data.id, 'read'); break;
                case 'delete': 
                    const el = document.querySelector(`[data-id="${data.id}"]`);
                    if(el) {
                        el.style.opacity = '0.5';
                        el.innerHTML = '<span class="italic text-gray-400 text-xs">Message deleted</span>';
                    } 
                    break;
                case 'edit':
                    const editEl = document.querySelector(`[data-id="${data.id}"]`);
                    if(editEl) editEl.querySelector('.msg-text').innerText = data.content + " (edited)";
                    break;
                case 'call-rejected':
                    stopSound('ring');
                    document.getElementById('call-overlay').classList.add('hidden');
                    if(localStream) localStream.getTracks().forEach(t => t.stop());
                    showToast("Call ended or declined.");
                    break;
            }
        }

        function notifyUser(title, body) {
            if(settings.notifs && document.hidden) new Notification(title, { body });
        }

        function sendTyping() { if(conn && conn.open) conn.send({ type: 'typing', text: 'Typing...' }); }
        function sendActivity(txt) { if(conn && conn.open) conn.send({ type: 'typing', text: txt }); }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;

            if(conn && conn.open) {
                if(isEditing) {
                    conn.send({ type: 'edit', id: isEditing, content: text });
                    document.querySelector(`[data-id="${isEditing}"] .msg-text`).innerText = text + " (edited)";
                    isEditing = null;
                    input.style.borderColor = '#000';
                } else {
                    const id = crypto.randomUUID();
                    const payload = { type: 'text', id: id, content: text, replyTo: replyContext };
                    
                    if(isEphemeral) {
                        payload.type = 'timed-text';
                        payload.duration = 15000;
                    }

                    conn.send(payload);
                    renderMessage(id, text, 'me', replyContext, isEphemeral);
                    playSound('pop');
                }
                input.value = '';
                cancelReply();
            } else showToast("Waiting for connection...", "error");
        }

        function sendSticker(url) {
            if(conn && conn.open) {
                const id = crypto.randomUUID();
                conn.send({ type: 'sticker', id: id, url: url });
                renderSticker(url, 'me');
            }
        }

        function sendData(payload) { 
            if(conn && conn.open) {
                if(payload.type === 'file') showToast("Sending file...", "info");
                conn.send(payload); 
            }
        }

        function setReply(id, text) {
            replyContext = { id, text };
            document.getElementById('reply-preview').classList.remove('hidden');
            document.getElementById('reply-text').innerText = text;
            document.getElementById('msg-input').focus();
        }
        function cancelReply() { replyContext = null; document.getElementById('reply-preview').classList.add('hidden'); }
        function updateStatus(id, status) {
            const el = document.querySelector(`[data-id="${id}"] .status-tick`);
            if(el && status === 'read') {
                el.innerHTML = '<i class="ph-bold ph-checks-bold text-blue-500"></i>';
            }
        }

        // --- RENDERERS ---

        function scrollToBottom() {
            const c = document.getElementById('messages-container');
            c.scrollTop = c.scrollHeight;
            setTimeout(() => c.scrollTop = c.scrollHeight, 100);
        }

        function renderMessage(id, text, sender, replyTo, isTimed) {
            const container = document.getElementById('messages-container');
            const div = document.createElement('div');
            const isMe = sender === 'me';
            
            let replyHtml = replyTo ? `<div class="mb-2 text-xs bg-black/5 p-2 rounded border-l-2 ${isMe ? 'border-white' : 'border-blue-500'} truncate font-bold">Re: ${replyTo.text}</div>` : '';
            let content = linkifyHtml(escapeHtml(text), { target: '_blank', className: 'underline font-bold' });
            let timerHtml = isTimed ? '<div class="absolute top-1 right-2 text-[10px] font-bold opacity-70 flex items-center gap-1"><i class="ph-bold ph-timer"></i> 15s</div>' : '';

            div.className = `msg-bubble ${isMe ? 'msg-me' : 'msg-other'} ${isTimed ? 'msg-timed' : ''}`;
            div.dataset.id = id;
            div.innerHTML = `
                ${timerHtml}
                ${replyHtml}
                <div class="msg-content"><span class="msg-text">${content}</span></div>
                <div class="flex justify-end items-center mt-1 space-x-1">
                    <span class="text-[10px] opacity-60 font-mono">${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
                    ${isMe ? '<i class="ph-bold ph-check status-tick text-[10px] opacity-70"></i>' : ''}
                </div>`;
            
            div.oncontextmenu = (e) => showContextMenu(e, div, isMe);
            let t;
            div.addEventListener('touchstart', (e) => { t = setTimeout(() => showContextMenu(e.touches[0], div, isMe), 500); });
            div.addEventListener('touchend', () => clearTimeout(t));

            container.appendChild(div);
            scrollToBottom();

            if (isTimed) startTimer(div);
        }

        function renderAudio(id, data, sender, isTimed) {
            const container = document.getElementById('messages-container');
            const div = document.createElement('div');
            const isMe = sender === 'me';
            const audioId = `audio-${id}`;
            let timerHtml = isTimed ? '<div class="absolute top-1 right-2 text-[10px] font-bold opacity-70 flex items-center gap-1"><i class="ph-bold ph-timer"></i> 15s</div>' : '';

            div.className = `msg-bubble ${isMe ? 'msg-me' : 'msg-other'} ${isTimed ? 'msg-timed' : ''}`;
            div.dataset.id = id;
            div.dataset.type = 'media';

            div.innerHTML = `
                ${timerHtml}
                <div class="flex items-center gap-3 min-w-[200px] mt-1">
                    <button onclick="document.getElementById('${audioId}').play()" class="w-10 h-10 rounded-full bg-black/20 text-white flex items-center justify-center hover:bg-black/30 transition backdrop-blur-sm"><i class="ph-fill ph-play text-lg"></i></button>
                    <div class="flex flex-col w-full">
                        <span class="text-xs font-bold uppercase tracking-wide opacity-70">Voice Note</span>
                        <div class="w-full h-1 bg-black/10 mt-2 rounded-full overflow-hidden">
                            <div class="h-full bg-current w-1/3 opacity-50"></div>
                        </div>
                    </div>
                </div>
                <audio id="${audioId}" src="${data}" class="hidden"></audio>
            `;
            div.oncontextmenu = (e) => showContextMenu(e, div, isMe);
            container.appendChild(div);
            scrollToBottom();

            if (isTimed) startTimer(div);
        }

        function startTimer(element) {
            setTimeout(() => {
                if(element) {
                    element.style.opacity = '0';
                    setTimeout(() => element.remove(), 500);
                }
            }, 15000);
        }

        function renderSticker(url, sender) {
            const container = document.getElementById('messages-container');
            const div = document.createElement('div');
            const isMe = sender === 'me';
            div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-6 relative`;
            div.dataset.type = 'media';
            div.dataset.id = crypto.randomUUID(); 
            div.innerHTML = `<img src="${url}" class="sticker-img shadow-lg" onload="scrollToBottom()">`;
            
            div.oncontextmenu = (e) => showContextMenu(e, div, isMe);
            container.appendChild(div);
            scrollToBottom();
        }

        function renderFile(id, name, data, mime, sender) {
            const container = document.getElementById('messages-container');
            const div = document.createElement('div');
            const isMe = sender === 'me';
            div.className = `msg-bubble ${isMe ? 'msg-me' : 'msg-other'} cursor-pointer hover:bg-opacity-90`;
            div.dataset.id = id;
            div.dataset.type = 'media';

            let preview = mime && mime.startsWith('image/') ? `<img src="${data}" class="chat-image block mt-2 rounded-lg" onload="scrollToBottom()">` : '';

            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-black/5 rounded-lg flex items-center justify-center shrink-0"><i class="ph-bold ph-file text-xl opacity-70"></i></div>
                    <div class="overflow-hidden"><p class="text-sm font-bold truncate w-40">${name}</p><p class="text-xs opacity-70">Tap to download</p></div>
                </div>
                ${preview}
            `;
            div.onclick = (e) => {
                if(e.target.tagName !== 'IMG') {
                    const a = document.createElement('a');
                    a.href = data; a.download = name; a.click();
                }
            };
            div.oncontextmenu = (e) => showContextMenu(e, div, isMe);
            container.appendChild(div);
            scrollToBottom();
        }

        // --- CONTEXT MENU & REACTIONS ---
        function showContextMenu(e, element, isMe) {
            e.preventDefault();
            ctxTarget = element;
            const menu = document.getElementById('context-menu');
            document.getElementById('ctx-edit').classList.toggle('hidden', !isMe || element.dataset.type === 'media');
            document.getElementById('ctx-delete').classList.toggle('hidden', !isMe);

            const x = e.clientX;
            const y = e.clientY;
            const menuW = 200;
            const menuH = 180; 
            
            const left = (x + menuW > window.innerWidth) ? window.innerWidth - menuW - 20 : x;
            const top = (y + menuH > window.innerHeight) ? y - menuH : y;
            
            menu.style.left = left + 'px';
            menu.style.top = top + 'px';
            menu.classList.remove('hidden');
        }

        function sendReaction(emoji) {
            if(!ctxTarget) return;
            const id = ctxTarget.dataset.id;
            renderReaction(id, emoji, true);
            if(conn && conn.open) conn.send({ type: 'reaction', id: id, emoji: emoji });
            document.getElementById('context-menu').classList.add('hidden');
        }

        function renderReaction(msgId, emoji, isMe) {
            const msgEl = document.querySelector(`[data-id="${msgId}"]`);
            if(!msgEl) return;
            
            let container = msgEl.querySelector('.reactions-container');
            if(!container) {
                container = document.createElement('div');
                container.className = 'reactions-container';
                msgEl.appendChild(container);
            }
            
            const pill = document.createElement('div');
            pill.className = 'reaction-pill';
            pill.innerHTML = emoji;
            container.appendChild(pill);
        }

        function handleCtxAction(action) {
            document.getElementById('context-menu').classList.add('hidden');
            if(!ctxTarget) return;

            const id = ctxTarget.dataset.id;
            const text = ctxTarget.querySelector('.msg-text')?.innerText || "";

            if(action === 'copy') { navigator.clipboard.writeText(text); showToast("Copied"); }
            else if(action === 'reply') setReply(id, text || '[Media]');
            else if(action === 'delete') {
                ctxTarget.remove();
                if(conn && conn.open) conn.send({type: 'delete', id: id});
            } else if(action === 'edit') {
                isEditing = id;
                const input = document.getElementById('msg-input');
                input.value = text;
                input.focus();
            }
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // --- CALLING LOGIC ---
        function startCall(isVideo) {
            if(!conn || !conn.open) return showToast("Connect first!", "error");
             if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                return showToast("Browser does not support media devices.", "error");
             }
            navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true }).then(stream => {
                const call = peer.call(conn.peer, stream);
                handleCallStart(call, stream);
            }).catch(e => showToast("Media Access Error", "error"));
        }

        function handleCallStart(call, stream) {
            localStream = stream;
            document.getElementById('call-overlay').classList.remove('hidden');
            document.getElementById('local-video').srcObject = stream;
            currentCall = call;
            call.on('stream', remoteStream => {
                document.getElementById('remote-video').srcObject = remoteStream;
                startCallTimer();
                document.getElementById('call-status-text').innerText = "Connected";
            });
            call.on('close', () => endCall());
        }

        function endCall() {
            if(currentCall) currentCall.close();
            if(conn && conn.open) conn.send({type: 'call-rejected'});
            document.getElementById('call-overlay').classList.add('hidden');
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            stopCallTimer();
        }

        let callInterval;
        function startCallTimer() {
            let sec = 0;
            const el = document.getElementById('call-timer');
            clearInterval(callInterval);
            callInterval = setInterval(() => {
                sec++;
                el.innerText = `${Math.floor(sec/60).toString().padStart(2,'0')}:${(sec%60).toString().padStart(2,'0')}`;
            }, 1000);
        }
        function stopCallTimer() { clearInterval(callInterval); document.getElementById('call-timer').innerText = "00:00"; }
        function disconnect() { if(conn) conn.close(); if(peer) peer.destroy(); location.reload(); }

    </script>
</body>
</html>
